{% extends 'projeng_base.html' %}

{% block content %}
<div class="container mx-auto p-6 bg-gray-100 min-h-screen">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Upload Project Documents</h1>

    {# Upload Form Section #}
    <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload New Document</h2>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-4">
                <label for="project-select" class="block text-sm font-medium text-gray-700">Select Project:</label>
                <select id="project-select" name="project_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">-- Select a Project --</option>
                    {# Options will be populated by JavaScript or passed from view #}
                    {% for project in assigned_projects %}
                        <option value="{{ project.id }}">{{ project.name }} ({{ project.prn }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label for="document-files" class="block text-sm font-semibold text-gray-700">
                        Select Files
                    </label>
                    <span id="file-count" class="text-xs text-gray-500 font-medium hidden">
                        <span id="file-count-number">0</span> file(s) selected
                    </span>
                </div>
                <div id="file-upload-area" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors cursor-pointer">
                    <div class="space-y-2 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div class="flex flex-col items-center text-sm text-gray-600">
                            <label for="document-files" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span class="flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    Upload Multiple Documents
                                </span>
                                <input type="file" 
                                       id="document-files" 
                                       name="files" 
                                       multiple 
                                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv"
                                       class="sr-only">
                            </label>
                            <p class="mt-1 text-xs text-gray-500">or drag and drop multiple files here</p>
                        </div>
                        <p class="text-xs text-gray-500">PDF, DOC, DOCX, XLS, XLSX, images, etc. â€¢ <strong>Hold Ctrl (Windows) or Cmd (Mac) to select multiple files</strong></p>
                    </div>
                </div>
                <div id="file-preview" class="mt-4 space-y-3 hidden"></div>
            </div>
            <div id="upload-status" class="mt-4 text-sm font-medium"></div>
            <button type="submit" id="upload-btn" class="px-6 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-green-500 focus:border-green-500 font-semibold shadow-sm transition-colors duration-200 inline-flex items-center justify-center gap-2">
                <span id="upload-loading-spinner" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <span>Upload Documents</span>
            </button>
        </form>
    </div>

    {# Uploaded Documents Section #}
    <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Uploaded Documents</h2>
        {# Table or list to display uploaded documents #}
        <div id="uploaded-documents-list">
            <p class="text-gray-700">Uploaded documents will appear here.</p>
            {# Documents will be loaded here by JavaScript or passed from view #}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('upload-form');
        const uploadStatusDiv = document.getElementById('upload-status');
        const uploadedDocumentsList = document.getElementById('uploaded-documents-list');
        const projectSelect = document.getElementById('project-select');

        // Function to fetch and display uploaded documents for the selected project
        function loadUploadedDocuments(projectId) {
            if (!projectId) {
                uploadedDocumentsList.innerHTML = '<p class="text-gray-700">Please select a project to view documents.</p>';
                return;
            }

            // Assuming an API endpoint exists to get documents for a project
            // Example: /projeng/projects/{projectId}/documents/
            fetch(`/projeng/projects/${projectId}/documents/`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Failed to fetch documents');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    uploadedDocumentsList.innerHTML = ''; // Clear previous list
                    const documents = data.documents || [];
                    if (documents.length === 0) {
                        uploadedDocumentsList.innerHTML = '<p class="text-gray-700">No documents uploaded for this project yet.</p>';
                    } else {
                        const listHtml = documents.map(doc => `
                            <div class="border-b border-gray-200 py-3 flex justify-between items-center hover:bg-gray-50 transition-colors">
                                <div class="flex-1">
                                    <a href="${doc.file_url}" class="text-blue-600 hover:underline font-medium" target="_blank">${doc.name}</a>
                                    <p class="text-sm text-gray-500 mt-1">Uploaded by ${doc.uploaded_by} on ${doc.uploaded_at}</p>
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <a href="${doc.file_url}" target="_blank" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="View">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </a>
                                    <a href="${doc.file_url}" download class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Download">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        `).join('');
                        uploadedDocumentsList.innerHTML = listHtml;
                    }
                })
                .catch(error => {
                    console.error('Error loading documents:', error);
                    uploadedDocumentsList.innerHTML = `<p class="text-red-600 font-medium">Error loading documents: ${error.message}</p>`;
                });
        }

        // Load documents when a project is selected
        projectSelect.addEventListener('change', function() {
            loadUploadedDocuments(this.value);
        });

        const fileInput = document.getElementById('document-files');
        const filePreview = document.getElementById('file-preview');
        const fileCount = document.getElementById('file-count');
        const fileCountNumber = document.getElementById('file-count-number');
        const fileUploadArea = document.getElementById('file-upload-area');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadLoadingSpinner = document.getElementById('upload-loading-spinner');
        
        // Store selected files with their names
        let selectedFiles = [];
        
        // Update file count display
        function updateFileCount() {
            const count = selectedFiles.length;
            if (count > 0) {
                fileCount.classList.remove('hidden');
                fileCountNumber.textContent = count;
            } else {
                fileCount.classList.add('hidden');
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Get file icon based on type
        function getFileIcon(file) {
            const type = file.type || '';
            if (type.includes('pdf')) return 'ðŸ“„';
            if (type.includes('word') || type.includes('document')) return 'ðŸ“';
            if (type.includes('excel') || type.includes('spreadsheet')) return 'ðŸ“Š';
            if (type.includes('image')) return 'ðŸ–¼ï¸';
            if (type.includes('zip') || type.includes('archive')) return 'ðŸ“¦';
            return 'ðŸ“Ž';
        }
        
        // Render file previews
        function renderPreviews() {
            if (selectedFiles.length === 0) {
                filePreview.classList.add('hidden');
                filePreview.innerHTML = '';
                return;
            }
            
            filePreview.classList.remove('hidden');
            filePreview.innerHTML = '';
            
            selectedFiles.forEach((fileData, index) => {
                const file = fileData.file;
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-indigo-400 transition-colors group';
                div.dataset.index = index;
                
                const isImage = file.type.startsWith('image/');
                let previewContent = '';
                
                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        div.querySelector('.file-preview-image').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    previewContent = `<img src="" alt="${file.name}" class="file-preview-image w-16 h-16 object-cover rounded border border-gray-300">`;
                } else {
                    previewContent = `<div class="w-16 h-16 bg-indigo-100 rounded border border-indigo-200 flex items-center justify-center text-2xl">${getFileIcon(file)}</div>`;
                }
                
                div.innerHTML = `
                    ${previewContent}
                    <div class="flex-1 min-w-0">
                        <input type="text" 
                               class="document-name-input w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                               placeholder="Document name (optional)"
                               value="${fileData.name || file.name}"
                               data-index="${index}">
                        <p class="text-xs text-gray-500 mt-1 truncate" title="${file.name}">${file.name}</p>
                        <p class="text-xs text-gray-400">${formatFileSize(file.size)}</p>
                    </div>
                    <button type="button" 
                            class="remove-file bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm hover:bg-red-600 transition-colors shadow-lg opacity-0 group-hover:opacity-100"
                            data-index="${index}"
                            title="Remove this file">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                `;
                filePreview.appendChild(div);
            });
            
            // Add event listeners for name inputs
            filePreview.querySelectorAll('.document-name-input').forEach(input => {
                input.addEventListener('change', function() {
                    const index = parseInt(this.dataset.index);
                    if (selectedFiles[index]) {
                        selectedFiles[index].name = this.value.trim() || selectedFiles[index].file.name;
                    }
                });
            });
        }
        
        // Remove file from selection
        function removeFile(index) {
            if (index >= 0 && index < selectedFiles.length) {
                selectedFiles.splice(index, 1);
                
                // Update the file input
                const dataTransfer = new DataTransfer();
                selectedFiles.forEach(fd => dataTransfer.items.add(fd.file));
                fileInput.files = dataTransfer.files;
                
                updateFileCount();
                renderPreviews();
            }
        }
        
        // Handle file selection
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const newFiles = Array.from(e.target.files);
                console.log('Files selected:', newFiles.length, newFiles);
                
                if (newFiles.length === 0) {
                    console.warn('No files selected');
                    return;
                }
                
                // Add new files to selectedFiles (avoid duplicates)
                newFiles.forEach(file => {
                    if (!selectedFiles.some(fd => fd.file.name === file.name && fd.file.size === file.size && fd.file.lastModified === file.lastModified)) {
                        selectedFiles.push({ file: file, name: '' });
                    }
                });
                
                console.log('Total files in selection:', selectedFiles.length);
                updateFileCount();
                renderPreviews();
            });
            
            // Make upload area clickable
            if (fileUploadArea) {
                fileUploadArea.addEventListener('click', function(e) {
                    if (e.target === fileUploadArea || e.target.closest('label') === null) {
                        fileInput.click();
                    }
                });
                
                // Drag and drop support
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => {
                        fileUploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => {
                        fileUploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
                    }, false);
                });
                
                fileUploadArea.addEventListener('drop', function(e) {
                    const droppedFiles = Array.from(e.dataTransfer.files);
                    
                    droppedFiles.forEach(file => {
                        if (!selectedFiles.some(fd => fd.file.name === file.name && fd.file.size === file.size && fd.file.lastModified === file.lastModified)) {
                            selectedFiles.push({ file: file, name: '' });
                        }
                    });
                    
                    // Update the file input
                    const dataTransfer = new DataTransfer();
                    selectedFiles.forEach(fd => dataTransfer.items.add(fd.file));
                    fileInput.files = dataTransfer.files;
                    
                    updateFileCount();
                    renderPreviews();
                }, false);
            }
            
            // Handle remove button clicks
            filePreview.addEventListener('click', function(e) {
                if (e.target.closest('.remove-file')) {
                    const index = parseInt(e.target.closest('.remove-file').dataset.index);
                    removeFile(index);
                }
            });
        }
        
        // Handle form submission for uploading new document
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const projectId = projectSelect.value;

            if (!projectId) {
                uploadStatusDiv.textContent = 'Please select a project.';
                uploadStatusDiv.className = 'mt-4 text-sm font-medium text-red-600';
                return;
            }
            
            if (selectedFiles.length === 0) {
                uploadStatusDiv.textContent = 'Please select at least one file to upload.';
                uploadStatusDiv.className = 'mt-4 text-sm font-medium text-red-600';
                return;
            }
            
            console.log('Uploading files:', selectedFiles.length, selectedFiles);
            
            // Show loading state
            uploadLoadingSpinner.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadBtn.classList.add('opacity-75', 'cursor-not-allowed');
            
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Add files and names
            selectedFiles.forEach(fd => {
                formData.append('files', fd.file);
                formData.append('names', fd.name || fd.file.name);
            });

            fetch(`/projeng/projects/${projectId}/upload-document/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.error || 'Upload failed');
                        }
                        return data;
                    });
                } else {
                    throw new Error(`Unexpected response from server: ${response.status} ${response.statusText}`);
                }
            })
            .then(data => {
                uploadLoadingSpinner.classList.add('hidden');
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                
                uploadStatusDiv.textContent = data.message || 'Upload successful!';
                uploadStatusDiv.className = 'mt-4 text-sm font-medium text-green-600';
                
                // Clear form
                selectedFiles = [];
                updateFileCount();
                filePreview.classList.add('hidden');
                filePreview.innerHTML = '';
                
                loadUploadedDocuments(projectId); // Refresh the list of documents
            })
            .catch(error => {
                uploadLoadingSpinner.classList.add('hidden');
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                
                console.error('Upload error:', error);
                uploadStatusDiv.textContent = error.message || 'An error occurred during upload.';
                uploadStatusDiv.className = 'mt-4 text-sm font-medium text-red-600';
            });
        });

        // Initial load of documents if a project is already selected (optional, depending on how the project list is populated)
        // loadUploadedDocuments(projectSelect.value);
    });
</script>
{% endblock %} 