{% extends 'projeng_base.html' %}
{% block content %}
<div class="container mx-auto p-6 bg-gray-100">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6 border-b pb-4">
    <h1 class="text-3xl font-bold text-gray-800">Assigned Projects Dashboard</h1>
    <div class="flex items-center gap-4">
    </div>
  </div>

  <!-- KPI Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
          <div>
              <div class="text-sm font-medium text-gray-500">Total Assigned Projects</div>
              <div class="text-2xl font-bold text-indigo-600" id="card-total-projects">{{ total_projects }}</div>
          </div>
          <div class="p-2 bg-indigo-100 rounded-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m7-7V3m0 2.882a2 2 0 01-.876 1.553L9 10m4-5.565l2.876 1.553A2 2 0 0119 9v2M5 9h14" />
              </svg>
          </div>
      </div>
      {# Iterate over status counts to display individual KPIs #}
      {% for status, count in status_counts.items %}
          {% if status != 'Cancelled' %}
              <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
                  <div>
                      <div class="text-sm font-medium text-gray-500">{{ status }}</div>
                      <div class="text-2xl font-bold text-gray-800" id="card-{{ status|slugify }}">{{ count }}</div>
                  </div>
                  {# Add a relevant icon for each status if desired #}
                  <div class="p-2 bg-gray-100 rounded-md">
                      {# Placeholder icon - replace with status-specific icons #}
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 2v-6m2 9H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                  </div>
              </div>
          {% endif %}
      {% endfor %}
  </div>

  <!-- Main Content: Projects List and Analytics Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Project List (Left Column) -->
    <div class="space-y-3">
      <h2 class="text-xl font-semibold text-gray-800 mb-3">Recent Assigned Projects</h2>
      <div class="mb-3">
          <input type="text" id="search-dashboard-projects" placeholder="Search projects..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
      </div>
      <div class="space-y-3 overflow-y-auto">
        {% for project in assigned_projects %}
            <div class="bg-white rounded-lg shadow flex flex-col px-5 py-4 gap-2 border border-gray-200 dashboard-project-card">
              <div class="flex items-center gap-3 flex-wrap">
                <div class="text-lg font-semibold text-gray-800">{{ project.name }}</div>
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full flex-shrink-0
                    {% if project.status == 'completed' %}bg-green-100 text-green-800
                    {% elif project.status == 'in_progress' %}bg-blue-100 text-blue-800
                    {% elif project.status == 'planned' %}bg-yellow-100 text-yellow-800
                    {% elif project.status == 'delayed' %}bg-red-100 text-red-800
                    {% elif project.status == 'cancelled' %}bg-gray-300 text-gray-700
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ project.get_status_display }}
                </span>
              </div>
              <div class="text-sm text-gray-500">Last Update: {% if project.calculated_last_update %}{{ project.calculated_last_update|date:"M. d, Y" }} at {{ project.calculated_last_update|time:"g:i A" }}{% else %}Never{% endif %}</div>
            </div>
        {% empty %}
            <div class="bg-white rounded-lg shadow px-5 py-4 text-gray-600">
                No recent projects assigned to you.
            </div>
        {% endfor %}
      </div>
    </div>

    <!-- Analytics Graphs (Right Column - Stacked Vertically) -->
    <div class="space-y-6">
      <!-- Graph 1: Project Status Overview -->
      <div class="bg-white rounded-xl shadow p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Project Status Overview</h3>
        <div class="chart-container" style="height: 280px;">
            <canvas id="projectOverviewChart"></canvas>
        </div>
      </div>

      <!-- Graph 2: Placeholder for new graph -->
      <div class="bg-white rounded-xl shadow p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Graph 2</h3>
        <div class="chart-container flex items-center justify-center" style="height: 280px;">
            <canvas id="chart2"></canvas>
        </div>
      </div>

      <!-- Graph 3: Placeholder for new graph -->
      <div class="bg-white rounded-xl shadow p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Graph 3</h3>
        <div class="chart-container flex items-center justify-center" style="height: 280px;">
            <canvas id="chart3"></canvas>
        </div>
      </div>

      <!-- Graph 4: Placeholder for new graph -->
      <div class="bg-white rounded-xl shadow p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Graph 4</h3>
        <div class="chart-container flex items-center justify-center" style="height: 280px;">
            <canvas id="chart4"></canvas>
        </div>
      </div>

      <!-- Graph 5: Placeholder for new graph -->
      <div class="bg-white rounded-xl shadow p-5">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Graph 5</h3>
        <div class="chart-container flex items-center justify-center" style="height: 280px;">
            <canvas id="chart5"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Custom script for the chart -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch data for the chart
        fetch('{% url "projeng:projeng_analytics_overview_data" %}')
         .then(response => {
             if (!response.ok) {
                 throw new Error('Network response was not ok');
             }
             return response.json();
         })
         .then(data => {
             try {
                 renderProjectOverviewChart(data);
             } catch (error) {
                 console.error('Error rendering chart:', error);
                 const chartContainer = document.querySelector('#projectOverviewChart').parentElement;
                 if (chartContainer) {
                     chartContainer.innerHTML = '<div class="text-red-500 text-sm">Error loading chart data</div>';
                 }
             }
         })
         .catch(error => {
             console.error('Error fetching chart data:', error);
             const chartContainer = document.querySelector('#projectOverviewChart').parentElement;
             if (chartContainer) {
                 chartContainer.innerHTML = '<div class="text-red-500 text-sm">Error loading chart data</div>';
             }
         });

        function renderProjectOverviewChart(chartData) {
            const ctx = document.getElementById('projectOverviewChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Projects'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Project Status Overview'
                        }
                    }
                }
            });
        }

        // Placeholder functions for additional charts
        // You can implement these later with actual data
        function renderChart2() {
            const ctx = document.getElementById('chart2');
            if (ctx) {
                // Chart 2 implementation
                console.log('Chart 2 placeholder');
            }
        }

        function renderChart3() {
            const ctx = document.getElementById('chart3');
            if (ctx) {
                // Chart 3 implementation
                console.log('Chart 3 placeholder');
            }
        }

        function renderChart4() {
            const ctx = document.getElementById('chart4');
            if (ctx) {
                // Chart 4 implementation
                console.log('Chart 4 placeholder');
            }
        }

        function renderChart5() {
            const ctx = document.getElementById('chart5');
            if (ctx) {
                // Chart 5 implementation
                console.log('Chart 5 placeholder');
            }
        }

        // Call placeholder chart functions
        renderChart2();
        renderChart3();
        renderChart4();
        renderChart5();
    });
</script>
<script>
function updateDashboardCards() {
    fetch('/projeng/dashboard/api/card-data/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('card-total-projects').textContent = data.total_projects;
            for (const [status, count] of Object.entries(data.status_counts)) {
                const el = document.getElementById('card-' + status.replace(/_/g, '-').toLowerCase());
                if (el) el.textContent = count;
            }
        });
}
updateDashboardCards();
setInterval(updateDashboardCards, 30000);
</script>
<script>
document.getElementById('search-dashboard-projects').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('.dashboard-project-card').forEach(card => {
        const nameEl = card.querySelector('.text-lg');
        const name = nameEl ? nameEl.textContent.toLowerCase() : '';
        card.style.display = name.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %} 