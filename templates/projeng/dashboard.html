{% extends 'projeng_base.html' %}
{% block content %}
<div class="container mx-auto p-6 bg-gray-100">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6 border-b pb-4">
    <h1 class="text-3xl font-bold text-gray-800">Assigned Projects Dashboard</h1>
    <div class="flex items-center gap-4">
    </div>
  </div>

  <!-- KPI Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
          <div>
              <div class="text-sm font-medium text-gray-500">Total Assigned Projects</div>
              <div class="text-2xl font-bold text-indigo-600" id="card-total-projects">{{ total_projects }}</div>
          </div>
          <div class="p-2 bg-indigo-100 rounded-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m7-7V3m0 2.882a2 2 0 01-.876 1.553L9 10m4-5.565l2.876 1.553A2 2 0 0119 9v2M5 9h14" />
              </svg>
          </div>
      </div>
      {# Iterate over status counts to display individual KPIs #}
      {% for status, count in status_counts.items %}
          {% if status != 'Cancelled' %}
              <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
                  <div>
                      <div class="text-sm font-medium text-gray-500">{{ status }}</div>
                      <div class="text-2xl font-bold text-gray-800" id="card-{{ status|slugify }}">{{ count }}</div>
                  </div>
                  {# Add a relevant icon for each status if desired #}
                  <div class="p-2 bg-gray-100 rounded-md">
                      {# Placeholder icon - replace with status-specific icons #}
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 2v-6m2 9H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                  </div>
              </div>
          {% endif %}
      {% endfor %}
  </div>

  <!-- Two-column layout for Project List and Analytics -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Project List (Left Column) -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Assigned Projects</h2>
      <div class="mb-4">
          <input type="text" id="search-dashboard-projects" placeholder="Search assigned projects..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-1/2">
      </div>
    {% for project in assigned_projects %}
        <div class="bg-white rounded-xl shadow flex flex-col md:flex-row md:items-center justify-between px-6 py-4 gap-4 border border-gray-200 dashboard-project-card">
          <div>
            <div class="text-lg font-semibold text-gray-800">{{ project.name }}</div>
            <div class="text-sm text-gray-600">{{ project.get_status_display }} â€¢ Last Update: {{ project.last_update|date:"F j, Y"|default:"N/A" }}</div>
             {# You might want to add other brief project info here #}
          </div>
        </div>
    {% empty %}
        <div class="bg-white rounded-xl shadow px-6 py-4 text-gray-600">
            No recent projects assigned to you.
        </div>
    {% endfor %}
    </div>

    <!-- Analytics Section (Right Column) -->
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Project Overview Analytics</h2>
      <div class="chart-container">
          <canvas id="projectOverviewChart"></canvas>
      </div>
      {# You can add other overview metrics or charts here #}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Custom script for the chart -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch data for the chart
        fetch('{% url "projeng:projeng_analytics_overview_data" %}')
         .then(response => {
             if (!response.ok) {
                 throw new Error('Network response was not ok');
             }
             return response.json();
         })
         .then(data => {
             try {
                 renderProjectOverviewChart(data);
             } catch (error) {
                 console.error('Error rendering chart:', error);
                 document.querySelector('.chart-container').innerHTML = '<div class="text-red-500">Error loading chart data</div>';
             }
         })
         .catch(error => {
             console.error('Error fetching chart data:', error);
             document.querySelector('.chart-container').innerHTML = '<div class="text-red-500">Error loading chart data</div>';
         });

        function renderProjectOverviewChart(chartData) {
            const ctx = document.getElementById('projectOverviewChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar', // You can change this to 'pie', 'line', etc.
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Projects'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Project Status Overview'
                        }
                    }
                }
            });
        }
    });
</script>
<script>
function updateDashboardCards() {
    fetch('/projeng/dashboard/api/card-data/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('card-total-projects').textContent = data.total_projects;
            for (const [status, count] of Object.entries(data.status_counts)) {
                const el = document.getElementById('card-' + status.replace(/_/g, '-').toLowerCase());
                if (el) el.textContent = count;
            }
        });
}
updateDashboardCards();
setInterval(updateDashboardCards, 30000);
</script>
<script>
document.getElementById('search-dashboard-projects').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('.dashboard-project-card').forEach(card => {
        const name = card.querySelector('.text-lg').textContent.toLowerCase();
        card.style.display = name.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %} 