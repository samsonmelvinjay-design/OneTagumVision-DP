{% extends 'projeng_base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto p-6">
    <!-- Header without Export Button -->
    <div class="flex items-center justify-between mb-4">
        <a href="{% url 'projeng_my_projects' %}" class="inline-block px-4 py-2 bg-gradient-to-r from-gray-400 to-gray-600 text-white font-semibold rounded-lg shadow hover:from-gray-500 hover:to-gray-700 transition duration-200" title="Back to My Projects">&larr; Back to My Projects</a>
        <h1 class="text-3xl font-bold text-gray-900">Project Analytics</h1>
        {# Removed the Export Report link expecting a single project PK #}
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Progress Overview -->
        {# Assuming you have logic here to display overall progress or charts for assigned projects #}
        {# For example: #}
        <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Overall Progress</h2>
            {# Add content here related to overall project progress for the assigned projects #}
             <p>Total Projects: {{ total_projects }}</p>
             <p>Completed: {{ completed_projects }}</p>
             <p>Ongoing: {{ ongoing_projects }}</p>
             <p>Planned: {{ planned_projects }}</p>
             <p>Delayed: {{ delayed_projects_count }}</p>
        </div>

        <!-- Project Status Chart -->
        <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Project Status Overview</h2>
             {# Add a canvas for a chart here, and corresponding JS #}
             <canvas id="projectStatusChart"></canvas>
                </div>

    </div>

    <!-- Projects Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden mb-6">
         <h2 class="text-xl font-semibold text-gray-900 px-6 py-4 border-b">Projects List</h2>
         <div class="p-4 flex gap-4 items-center">
            <input type="text" id="search-input" placeholder="Search projects..." 
                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
             {# You might want to add a barangay filter here too if needed #}
             <select id="filter-barangay" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                 <option value="">All Barangays</option>
                 {# Options will be populated by JS or from view context #}
                 {% for project in projects %}
                     {% if project.barangay %}<option value="{{ project.barangay }}">{{ project.barangay }}</option>{% endif %}
                 {% endfor %}
             </select>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barangay</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="projects-table-body">
                    {# Table rows will be populated by JavaScript #}
                </tbody>
            </table>
        </div>
    </div>

    {# Data for JavaScript #}
    {{ projects|json_script:"projects-data" }}

</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectsDataElement = document.getElementById('projects-data');
    if (!projectsDataElement) {
        console.error('projects-data element not found!');
        return;
    }
    let projectsData = [];
    try {
        console.log('Raw projects-data textContent:', projectsDataElement.textContent);
        projectsData = JSON.parse(projectsDataElement.textContent);
        console.log('Parsed projects:', projectsData);
    } catch (e) {
        console.error('Error parsing project data:', e, projectsDataElement.textContent);
        return;
    }
    const searchInput = document.getElementById('search-input');
    const filterBarangay = document.getElementById('filter-barangay');
    const tableBody = document.getElementById('projects-table-body');
    function renderTable(filteredProjects) {
        tableBody.innerHTML = '';
        filteredProjects.forEach(project => {
            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-50');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${project.name}</div>
                    <div class="text-sm text-gray-500">${project.prn || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${project.barangay || ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${project.progress || 0}%"></div>
                    </div>
                    <span class="text-sm text-gray-500">${project.progress || 0}%</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                     <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                         ${project.status === 'completed' ? 'bg-green-100 text-green-800' : 
                           (project.status === 'ongoing' || project.status === 'in_progress') ? 'bg-blue-100 text-blue-800' : 
                           (project.status === 'planned' || project.status === 'pending') ? 'bg-yellow-100 text-yellow-800' : 
                           project.status === 'delayed' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                         ${project.status ? project.status.charAt(0).toUpperCase() + project.status.slice(1) : ''}
                     </span>
                 </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${project.start_date ? new Date(project.start_date).toLocaleDateString() : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${project.end_date ? new Date(project.end_date).toLocaleDateString() : ''}
                </td>
                 <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                     <a href="/projeng/projects/${project.projeng_id}/detail/" class="text-blue-600 hover:text-blue-900" title="View/Manage Project">View/Manage</a>
                 </td>
            `