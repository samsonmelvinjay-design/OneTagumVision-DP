{% extends 'projeng_base.html' %}
{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Project Map</h1>
    <!-- Map container -->
    <div id="mapid" style="height: 600px;"></div>
</div>

<!-- Layer Details Modal -->
<div id="layerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 1000;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Layer Details</h3>
            <form id="layerForm" class="space-y-4">
                <div>
                    <label for="layerName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="layerName" name="layerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="layerDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="layerDescription" name="layerDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                <div>
                    <label for="layerType" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="layerType" name="layerType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="project">Project</option>
                        <option value="area">Area</option>
                        <option value="point">Point of Interest</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Initialize the map
    var mymap = L.map('mapid').setView([7.4471, 125.8091], 13); // Centered around Tagum City

    // Add a base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mymap);

    // Initialize the FeatureGroup to store editable layers
    var editableLayers = new L.FeatureGroup();
    mymap.addLayer(editableLayers);

    // Store the current layer being edited
    var currentLayer = null;

    // Initialize the draw control and add it to the map
    var options = {
        position: 'topright',
        draw: {
            polyline: {
                shapeOptions: {
                    color: '#f32424', // Red color
                    weight: 3 // Thicker line
                }
            },
            polygon: {},
            rectangle: {},
            circle: {},
            marker: {},
        },
        edit: {
            featureGroup: editableLayers,
            remove: true
        }
    };
    var drawControl = new L.Control.Draw(options);
    mymap.addControl(drawControl);

    // Function to show modal
    function showModal() {
        document.getElementById('layerModal').classList.remove('hidden');
    }

    // Function to close modal
    function closeModal() {
        document.getElementById('layerModal').classList.add('hidden');
        document.getElementById('layerForm').reset();
        currentLayer = null;
    }

    // Handle created features
    mymap.on(L.Draw.Event.CREATED, function (e) {
        var type = e.layerType,
            layer = e.layer;

        // Store the current layer
        currentLayer = layer;
        
        // Add layer to the map
        editableLayers.addLayer(layer);

        // Show the modal for adding details
        showModal();
    });

    // Handle form submission
    document.getElementById('layerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentLayer) return;

        // Get form data
        const formData = {
            name: document.getElementById('layerName').value,
            description: document.getElementById('layerDescription').value,
            type: document.getElementById('layerType').value,
            geometry: currentLayer.toGeoJSON()
        };

        // Send data to backend
        fetch('/projeng/save-layer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add properties to the layer
                currentLayer.properties = {
                    name: formData.name,
                    description: formData.description,
                    type: formData.type,
                    id: data.layer_id
                };
                
                // Close modal
                closeModal();
                
                // Show success message
                alert('Layer saved successfully!');
            } else {
                alert('Error saving layer: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving layer. Please try again.');
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle edited/deleted features
    mymap.on(L.Draw.Event.EDITED, function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            var geojson = layer.toGeoJSON();
            console.log('Edited:', geojson);
            // TODO: Add update functionality
        });
    });

    mymap.on(L.Draw.Event.DELETED, function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            var geojson = layer.toGeoJSON();
            console.log('Deleted:', geojson);
            // TODO: Add delete functionality
        });
    });

    // Load existing layers
    {% if layers %}
        {% for layer in layers %}
            var layerData = {{ layer.geometry.geojson|safe }};
            var layer = L.geoJSON(layerData, {
                properties: {
                    name: "{{ layer.name }}",
                    description: "{{ layer.description|default:'' }}",
                    type: "{{ layer.type }}",
                    id: {{ layer.id }}
                }
            }).addTo(editableLayers);
        {% endfor %}
    {% endif %}

    // --- Project Markers Dynamic AJAX Refresh ---
    var projectMarkers = {};

    function createOrUpdateMarker(project) {
        const progress = parseFloat(project.progress);
        const displayProgress = !isNaN(progress) && progress >= 0 && progress <= 100 ? progress : 0;
        var popupContent = `
            <div class="p-2">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-1 text-xs rounded-full font-semibold shadow-sm
                        ${project.status === 'completed' ? 'bg-green-100 text-green-700' :
                          project.status === 'ongoing' || project.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                          project.status === 'planned' || project.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                          project.status === 'delayed' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                        ${project.status ? project.status.charAt(0).toUpperCase() + project.status.slice(1).replace('_', ' ') : ''}
                    </span>
                    ${project.status === 'delayed' ? `<span class='px-2 py-1 text-xs rounded-full font-semibold bg-red-100 text-red-700'>Delayed Project</span>` : ''}
                </div>
                <h3 class="font-bold text-lg mb-1">${project.name}</h3>
                <div class="text-sm text-gray-700 mb-2">${project.description || 'City Lights'}</div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs text-gray-500">${project.barangay || 'N/A'}</span>
                </div>
                <div class="text-xs text-gray-500 mb-1">
                    <span class="block"><span class='font-semibold'>Lat:</span> ${project.latitude}, <span class='font-semibold'>Lng:</span> ${project.longitude}</span>
                </div>
                ${project.status === 'ongoing' || project.status === 'in_progress' ? `
                    <div class="text-xs text-gray-500 mb-2">
                        <span class="block"><span class='font-semibold'>Progress:</span> ${displayProgress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${displayProgress}%"></div>
                    </div>
                ` : ''}
                ${project.image ? `<img src="${project.image}" alt="Project Image" class="mt-2 h-auto rounded" style="max-width: 80px; height: auto;">` : ''}
                <div class="mt-2">
                    <a href="/projeng/projects/${project.id}/detail/" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">View Details</a>
                </div>
            </div>
        `;
        if (projectMarkers[project.id]) {
            // Update marker position and popup
            projectMarkers[project.id].setLatLng([project.latitude, project.longitude]);
            projectMarkers[project.id].setPopupContent(popupContent);
        } else {
            // Create new marker
            var marker = L.marker([project.latitude, project.longitude])
                .addTo(mymap)
                .bindPopup(popupContent);
            projectMarkers[project.id] = marker;
        }
    }

    function removeOldMarkers(currentProjectIds) {
        Object.keys(projectMarkers).forEach(function(id) {
            if (!currentProjectIds.includes(parseInt(id))) {
                mymap.removeLayer(projectMarkers[id]);
                delete projectMarkers[id];
            }
        });
    }

    function fetchAndUpdateProjects() {
        fetch('/projeng/map/api/projects/')
            .then(response => response.json())
            .then(data => {
                var projects = data.projects || [];
                var currentIds = [];
                projects.forEach(function(project) {
                    if (project.latitude && project.longitude) {
                        createOrUpdateMarker(project);
                        currentIds.push(project.id);
                    }
                });
                removeOldMarkers(currentIds);
            });
    }

    // Initial marker load
    fetchAndUpdateProjects();
    // Refresh every 10 seconds
    setInterval(fetchAndUpdateProjects, 10000);
</script>
{% endblock %} 