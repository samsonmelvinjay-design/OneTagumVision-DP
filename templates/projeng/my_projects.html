{% extends 'projeng_base.html' %}
{% block content %}
<div class="container mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
        <a href="{% url 'projeng:projeng_dashboard' %}" class="inline-block px-4 py-2 bg-gradient-to-r from-gray-400 to-gray-600 text-white font-semibold rounded-lg shadow hover:from-gray-500 hover:to-gray-700 transition duration-200" title="Back to Dashboard">&larr; Back to Dashboard</a>
        <h1 class="text-3xl font-bold text-gray-900">My Projects</h1>
    </div>
    <div class="mb-4">
        <input type="text" id="search-projects" placeholder="Search projects..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-1/2">
    </div>
    <div class="space-y-4" id="projects-list">
        {% for project in projects %}
            <div class="project-card bg-white rounded-xl shadow flex flex-col md:flex-row md:items-center justify-between px-6 py-4 gap-4" data-project-id="{{ project.id }}">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="text-lg font-semibold text-gray-800">{{ project.name }}</div>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                            {% if project.status == 'completed' %}bg-green-100 text-green-800
                            {% elif project.status == 'in_progress' %}bg-blue-100 text-blue-800
                            {% elif project.status == 'planned' %}bg-yellow-100 text-yellow-800
                            {% elif project.status == 'delayed' %}bg-red-100 text-red-800
                            {% elif project.status == 'cancelled' %}bg-gray-300 text-gray-700
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ project.get_status_display }}
                        </span>
                    </div>
                    <div class="text-sm text-gray-500">Last Update: {% if project.calculated_last_update %}{{ project.calculated_last_update|date:"M. d, Y" }} at {{ project.calculated_last_update|time:"g:i A" }}{% else %}Never{% endif %}</div>
                    <div class="text-sm text-gray-600 mt-1">{{ project.description|default:"No description" }}</div>
                    <div class="text-sm text-gray-500">Dates: {{ project.start_date|date:"M. d, Y"|default:"N/A" }} to {{ project.end_date|date:"M. d, Y"|default:"N/A" }}</div>
                </div>
                <a href="{% url 'projeng:projeng_project_detail' project.pk %}" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold shadow hover:bg-blue-700 transition inline-block" title="View project details">View Details</a>
            </div>
        {% empty %}
            <p id="no-projects-message">No projects assigned yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}
<script>
// Search functionality
document.getElementById('search-projects').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('.project-card').forEach(card => {
        const nameEl = card.querySelector('.text-lg');
        const name = nameEl ? nameEl.textContent.toLowerCase() : '';
        card.style.display = name.includes(searchTerm) ? '' : 'none';
    });
});

// Real-time project list updates
function setupRealtimeProjectList() {
    console.log('ðŸ“‹ Setting up real-time project list updates...');
    
    // Connect to project status SSE stream
    if (window.realtimeManager) {
        window.realtimeManager.connectProjects((data) => {
            console.log('ðŸ“¦ Received project update:', data);
            
            if (data.type === 'project_status' && data.projects) {
                // Handle multiple project updates
                data.projects.forEach(projectData => {
                    addOrUpdateProjectInList(projectData);
                });
            } else if (data.type === 'project_status' && data.project_id) {
                // Handle single project update
                addOrUpdateProjectInList(data);
            }
        }, null); // null = monitor all projects
    } else {
        console.error('âŒ RealtimeManager not available!');
    }
}

// Add or update a project in the list
function addOrUpdateProjectInList(projectData) {
    const projectsList = document.getElementById('projects-list');
    if (!projectsList) return;
    
    const existingCard = document.querySelector(`[data-project-id="${projectData.id}"]`);
    
    if (existingCard) {
        // Update existing project
        updateProjectCard(existingCard, projectData);
        // Highlight the updated project
        existingCard.classList.add('bg-yellow-50');
        setTimeout(() => {
            existingCard.classList.remove('bg-yellow-50');
        }, 2000);
    } else {
        // Add new project
        addProjectToList(projectData);
    }
}

// Helper function to get status badge HTML
function getStatusBadgeHTML(status, statusDisplay) {
    const statusLower = (status || '').toLowerCase();
    let badgeClass = 'bg-gray-100 text-gray-800';
    
    if (statusLower === 'completed') {
        badgeClass = 'bg-green-100 text-green-800';
    } else if (statusLower === 'in_progress') {
        badgeClass = 'bg-blue-100 text-blue-800';
    } else if (statusLower === 'planned') {
        badgeClass = 'bg-yellow-100 text-yellow-800';
    } else if (statusLower === 'delayed') {
        badgeClass = 'bg-red-100 text-red-800';
    } else if (statusLower === 'cancelled') {
        badgeClass = 'bg-gray-300 text-gray-700';
    }
    
    const displayText = statusDisplay || status || 'Unknown';
    return `<span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${badgeClass}">${escapeHtml(displayText)}</span>`;
}

// Update existing project card
function updateProjectCard(card, projectData) {
    // Find name container (new structure with badge)
    const nameContainer = card.querySelector('.flex.items-center.gap-3');
    
    if (nameContainer) {
        // New structure: update name and badge
        const nameEl = nameContainer.querySelector('.text-lg');
        const badgeEl = nameContainer.querySelector('span.inline-block.rounded-full');
        
        if (nameEl) nameEl.textContent = projectData.name || 'Unnamed Project';
        
        // Update status badge
        const statusDisplay = projectData.status_display || projectData.get_status_display || projectData.status;
        const badgeHTML = getStatusBadgeHTML(projectData.status, statusDisplay);
        
        if (badgeEl) {
            badgeEl.outerHTML = badgeHTML;
        } else {
            // If badge doesn't exist, create it
            nameContainer.insertAdjacentHTML('beforeend', badgeHTML);
        }
    } else {
        // Fallback: old structure - update name directly
        const nameEl = card.querySelector('.text-lg');
        if (nameEl) nameEl.textContent = projectData.name || 'Unnamed Project';
    }
    
    // Update last update text
    const statusContainers = card.querySelectorAll('.text-sm.text-gray-500');
    let statusContainer = null;
    
    // Find the container that starts with "Last Update:"
    statusContainers.forEach(container => {
        if (container.textContent.includes('Last Update:')) {
            statusContainer = container;
        }
    });
    
    if (statusContainer) {
        const lastUpdate = projectData.calculated_last_update || projectData.updated_at;
        let lastUpdateText = 'Never';
        if (lastUpdate) {
            const updateDate = new Date(lastUpdate);
            lastUpdateText = updateDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            }) + ' at ' + updateDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        statusContainer.textContent = `Last Update: ${lastUpdateText}`;
    }
}

// Add new project to the list
function addProjectToList(projectData) {
    console.log('âž• Adding new project to list:', projectData);
    const projectsList = document.getElementById('projects-list');
    if (!projectsList) return;
    
    // Hide "no projects" message
    const noProjectsMsg = document.getElementById('no-projects-message');
    if (noProjectsMsg) {
        noProjectsMsg.style.display = 'none';
    }
    
    // Create new project card
    const projectCard = document.createElement('div');
    projectCard.className = 'project-card bg-white rounded-xl shadow flex flex-col md:flex-row md:items-center justify-between px-6 py-4 gap-4 animate-fade-in';
    projectCard.setAttribute('data-project-id', projectData.id);
    projectCard.style.opacity = '0';
    projectCard.style.transform = 'translateY(-10px)';
    
    const lastUpdate = projectData.calculated_last_update || projectData.updated_at;
    let lastUpdateText = 'Never';
    if (lastUpdate) {
        const updateDate = new Date(lastUpdate);
        lastUpdateText = updateDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        }) + ' at ' + updateDate.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
    }
    const startDate = projectData.start_date ? new Date(projectData.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
    const endDate = projectData.end_date ? new Date(projectData.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
    
    // Get status badge HTML
    const statusBadge = getStatusBadgeHTML(projectData.status, projectData.status_display || projectData.get_status_display || projectData.status);
    
    projectCard.innerHTML = `
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="text-lg font-semibold text-gray-800">${escapeHtml(projectData.name || 'Unnamed Project')}</div>
                ${statusBadge}
            </div>
            <div class="text-sm text-gray-500">Last Update: ${lastUpdateText}</div>
            <div class="text-sm text-gray-600 mt-1">${escapeHtml(projectData.description || 'No description')}</div>
            <div class="text-sm text-gray-500">Dates: ${startDate} to ${endDate}</div>
        </div>
        <a href="/projeng/projects/${projectData.id}/detail/" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold shadow hover:bg-blue-700 transition inline-block" title="View project details">View Details</a>
    `;
    
    // Add to top of list
    projectsList.insertBefore(projectCard, projectsList.firstChild);
    
    // Animate in
    setTimeout(() => {
        projectCard.style.transition = 'all 0.3s ease';
        projectCard.style.opacity = '1';
        projectCard.style.transform = 'translateY(0)';
        projectCard.classList.add('bg-green-50');
        setTimeout(() => {
            projectCard.classList.remove('bg-green-50');
        }, 2000);
    }, 10);
}

// Update project in list (for status changes)
function updateProjectInList(projectData) {
    const card = document.querySelector(`[data-project-id="${projectData.id}"]`);
    if (card) {
        updateProjectCard(card, projectData);
        // Highlight update
        card.classList.add('bg-blue-50');
        setTimeout(() => {
            card.classList.remove('bg-blue-50');
        }, 2000);
    } else {
        // Project doesn't exist in list, add it
        addProjectToList(projectData);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for realtimeManager to be initialized
    setTimeout(() => {
        setupRealtimeProjectList();
        
        // Also setup notifications to show toast
        if (typeof setupRealtimeNotifications === 'function') {
            setupRealtimeNotifications();
        }
    }, 500);
});
</script>
<style>
@keyframes fade-in {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: none;
    }
}
.animate-fade-in {
    animation: fade-in 0.3s ease;
}
</style> 