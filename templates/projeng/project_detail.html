{% extends 'projeng_base.html' %}
{% load humanize %}
{% block content %}
<style>
    .info-card {
        transition: all 0.2s ease;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        border: 1px solid;
    }
    /* Custom scrollbar for Activity History */
    .activity-history-scroll::-webkit-scrollbar {
        width: 8px;
    }
    .activity-history-scroll::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }
    .activity-history-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    .activity-history-scroll::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    /* Custom scrollbar for Documents */
    .documents-scroll::-webkit-scrollbar {
        width: 8px;
    }
    .documents-scroll::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }
    .documents-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    .documents-scroll::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
</style>
<div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-6 gap-4 flex-wrap">
            <div class="flex items-center gap-4">
                <a href="{% url 'projeng:projeng_my_projects' %}" 
                   class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 -ml-2 rounded-lg hover:bg-gray-100"
                   title="Back to My Projects">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-900">Project Details</h1>
            </div>
            <div class="flex items-center gap-2 flex-wrap justify-end">
                <button type="button"
                        id="print-report-btn"
                        class="px-4 py-2.5 rounded-lg bg-gray-600 text-white hover:bg-gray-700 text-sm font-semibold inline-flex items-center gap-2 shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Print Report
                </button>

                <a href="{% url 'projeng:projeng_add_progress_update' project.pk %}" 
                   class="px-4 py-2.5 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm font-semibold inline-flex items-center gap-2 shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Update
                </a>
            </div>
        </div>
        
        <!-- Project Name and Status Header Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-start justify-between flex-wrap gap-4">
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-gray-900 mb-3">{{ project.name }}</h2>
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="status-badge
                            {% if project.status == 'completed' %}bg-green-50 text-green-800 border-green-200
                            {% elif project.status == 'in_progress' %}bg-blue-50 text-blue-800 border-blue-200
                            {% elif project.status == 'planned' %}bg-amber-50 text-amber-800 border-amber-200
                            {% elif project.status == 'delayed' %}bg-red-50 text-red-800 border-red-200
                            {% else %}bg-gray-50 text-gray-800 border-gray-200{% endif %}">
                            {{ project.get_status_display }}
                        </span>
                        {% if project.prn %}
                        <span class="text-sm text-gray-600 font-medium">PRN: {{ project.prn }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="mt-6">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                    <span class="font-medium">Expected Progress</span>
                    {% if configured_target_progress is not None %}
                        <span class="font-semibold text-gray-900">{{ configured_target_progress|floatformat:2 }}%</span>
                    {% else %}
                        <span class="font-semibold text-gray-500">Not set</span>
                    {% endif %}
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div class="bg-gradient-to-r from-slate-500 to-slate-600 h-3 rounded-full transition-all duration-300"
                         style="width: {% if configured_target_progress is not None %}{{ configured_target_progress }}{% else %}0{% endif %}%"></div>
                </div>
                {% if configured_target_date %}
                    <p class="text-xs text-gray-500 mt-2">Target date: {{ configured_target_date|date:"F j, Y" }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Basic Information -->
        <div class="space-y-6">
            <!-- Basic Information Card -->
            <div class="info-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Basic Information
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Description</label>
                        <p class="text-gray-900 mt-1">{{ project.description|default:"No description provided" }}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Start Date</label>
                            <p class="text-gray-900 mt-1">
                                {% if project.start_date %}
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        {{ project.start_date|date:"F j, Y" }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">Not set</span>
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">End Date</label>
                            <p class="text-gray-900 mt-1">
                                {% if project.end_date %}
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        {{ project.end_date|date:"F j, Y" }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">Not set</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Last Update</label>
                        <p class="text-gray-900 mt-1">
                            {% if project.calculated_last_update %}
                                {{ project.calculated_last_update|date:"F j, Y" }} at {{ project.calculated_last_update|time:"g:i A" }}
                            {% else %}
                                <span class="text-gray-400">Never</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Created By</label>
                            <p class="text-gray-900 mt-1">
                                {% if project.created_by %}
                                    {{ project.created_by.get_full_name|default:project.created_by.username }}
                                {% else %}
                                    <span class="text-gray-400">N/A</span>
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Assigned Engineers</label>
                            <p class="text-gray-900 mt-1">
                                {% if project.assigned_engineers.all %}
                                    {% for engineer in project.assigned_engineers.all %}
                                        <span class="inline-block px-2 py-1 bg-blue-50 text-blue-700 rounded-md text-sm mr-1 mb-1">{{ engineer.get_full_name|default:engineer.username }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-gray-400">No engineers assigned</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="space-y-6">
            <!-- Location & Financials Card -->
            <div class="info-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Location & Financials
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Barangay</label>
                        <p class="text-gray-900 mt-1 flex items-center gap-1">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            {{ project.barangay|default:"Not specified" }}
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Latitude</label>
                            <p class="text-gray-900 mt-1 font-mono text-sm">{{ project.latitude|default:"N/A" }}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Longitude</label>
                            <p class="text-gray-900 mt-1 font-mono text-sm">{{ project.longitude|default:"N/A" }}</p>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Project Cost</label>
                        <p class="text-gray-900 mt-1 text-lg font-semibold">
                            {% if project.project_cost %}
                                ‚Ç±{{ project.project_cost|floatformat:2|intcomma }}
                            {% else %}
                                <span class="text-gray-400">Not specified</span>
                            {% endif %}
                        </p>
                    </div>
                    {% if project.project_cost %}
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Spent</label>
                        <p class="text-gray-900 mt-1 text-lg font-semibold">
                            ‚Ç±{{ total_cost|floatformat:2|intcomma }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            {% if budget_utilization >= 100 %}
                                <span class="text-red-600 font-semibold">Over budget by ‚Ç±{{ over_budget_amount|floatformat:2|intcomma }}</span>
                            {% elif budget_utilization >= 80 %}
                                <span class="text-amber-600 font-semibold">{{ budget_utilization|floatformat:1 }}% utilized</span>
                            {% elif budget_utilization > 0 %}
                                <span class="text-gray-600">{{ budget_utilization|floatformat:1 }}% utilized</span>
                            {% else %}
                                <span class="text-gray-500">No costs recorded yet</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Remaining Budget</label>
                        {% if remaining_budget is not None %}
                            {% if remaining_budget < 0 %}
                                <p class="text-red-600 mt-1 text-lg font-semibold">
                                    ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}
                                </p>
                                <p class="text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è Over budget</p>
                            {% elif budget_utilization >= 80 %}
                                <p class="text-amber-600 mt-1 text-lg font-semibold">
                                    ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}
                                </p>
                                <p class="text-xs text-amber-600 mt-1">‚ö†Ô∏è Less than 20% remaining</p>
                            {% else %}
                                <p class="text-green-600 mt-1 text-lg font-semibold">
                                    ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}
                                </p>
                            {% endif %}
                        {% else %}
                            <p class="text-gray-400 mt-1 text-lg font-semibold">N/A</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div>
                        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Source of Funds</label>
                        <p class="text-gray-900 mt-1">{{ project.source_of_funds|default:"Not specified" }}</p>
                    </div>
                    
                    <!-- Budget Alert (more professional + only shows when needed) -->
                    {% for group in user.groups.all %}
                        {% if group.name == 'Project Engineer' and project.project_cost %}
                            {% if budget_utilization >= 95 or remaining_budget < 0 %}
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="rounded-lg border border-red-200 bg-red-50 p-4">
                                        <div class="flex items-start justify-between gap-3 flex-wrap">
                                            <div class="flex items-start gap-3">
                                                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-5 h-5 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-semibold text-red-900">Budget is critical</p>
                                                    <p class="text-xs text-red-800 mt-1">
                                                        Utilization: {{ budget_utilization|floatformat:1 }}%{% if remaining_budget is not None %} ‚Ä¢ Remaining: ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}{% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                            <button type="button"
                                                    onclick="showBudgetAlertModal()"
                                                    class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm font-semibold inline-flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.07 19h13.86c1.54 0 2.5-1.67 1.73-3L13.73 4c-.77-1.33-2.69-1.33-3.46 0L3.34 16c-.77 1.33.19 3 1.73 3z"/>
                                                </svg>
                                                Send alert
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% elif budget_utilization >= 80 %}
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="rounded-lg border border-amber-200 bg-amber-50 p-4">
                                        <div class="flex items-start justify-between gap-3 flex-wrap">
                                            <div class="flex items-start gap-3">
                                                <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                                                    <svg class="w-5 h-5 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-semibold text-amber-900">Budget is nearing limit</p>
                                                    <p class="text-xs text-amber-800 mt-1">
                                                        Utilization: {{ budget_utilization|floatformat:1 }}%{% if remaining_budget is not None %} ‚Ä¢ Remaining: ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}{% endif %}
                                                    </p>
                                                </div>
                                            </div>
                                            <button type="button"
                                                    onclick="showBudgetAlertModal()"
                                                    class="px-4 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700 text-sm font-semibold inline-flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.07 19h13.86c1.54 0 2.5-1.67 1.73-3L13.73 4c-.77-1.33-2.69-1.33-3.46 0L3.34 16c-.77 1.33.19 3 1.73 3z"/>
                                                </svg>
                                                Notify
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-6">
            <!-- Project Documents Card -->
            <div class="info-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Project Documents
                        {% if documents|length > 3 %}
                            <span class="text-sm font-normal text-gray-500">({{ documents|length }})</span>
                        {% endif %}
                    </h3>
                    <div class="flex items-center gap-2">
                        {% if documents|length > 3 %}
                            <button onclick="openDocumentsModal()" 
                                    class="text-xs text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                View All
                            </button>
                        {% endif %}
                        <button type="button" onclick="openUploadDocumentModal()"
                                class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Upload
                        </button>
                    </div>
                </div>
                
                {% if documents %}
                    <div class="space-y-3 max-h-80 overflow-y-auto pr-2 documents-scroll" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                        {% for doc in documents|slice:":3" %}
                            <div class="flex items-start justify-between gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <svg class="w-5 h-5 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        <p class="text-sm font-medium text-gray-900 truncate" title="{{ doc.name }}">
                                            {{ doc.name }}
                                        </p>
                                    </div>
                                    <div class="flex items-center gap-3 text-xs text-gray-500 ml-7">
                                        <span class="flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                            </svg>
                                            {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }}
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            {{ doc.uploaded_at|date:"M j, Y" }}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <a href="{{ doc.file.url }}" 
                                       target="_blank"
                                       class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                       title="View Document">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </a>
                                    <a href="{{ doc.file.url }}" 
                                       download
                                       class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                       title="Download Document">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% if documents|length > 3 %}
                        <div class="mt-3 pt-3 border-t border-gray-200 text-center">
                            <button onclick="openDocumentsModal()" 
                                    class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center justify-center gap-1 mx-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                                View {{ documents|length|add:"-3" }} more document{{ documents|length|add:"-3"|pluralize }}
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-6">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-sm text-gray-500 mb-3">No documents uploaded yet</p>
                        <button type="button" onclick="openUploadDocumentModal()"
                                class="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Upload Document
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Progress Trends Chart (if available) -->
    {% if progress_timeline_data|length > 0 %}
    <div class="mt-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Progress Trends
            </h3>
            <div class="h-64">
                <canvas id="progressTrendsChart"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center">
                Shows progress percentage over time based on updates
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Timeline Comparison & Activity History Side-by-Side -->
    {% if timeline_comparison or activity_log %}
    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Timeline Comparison -->
        {% if timeline_comparison %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Timeline Comparison
            </h3>
            <div class="h-64 mb-4">
                <canvas id="timelineComparisonChart"></canvas>
            </div>
            
            <!-- Timeline Metrics -->
            <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200">
                <div>
                    <p class="text-xs text-gray-500 mb-1">
                        {% if timeline_comparison.configured_target_date %}
                            Target ({{ timeline_comparison.configured_target_date }})
                        {% else %}
                            Expected Progress
                        {% endif %}
                    </p>
                    <p class="text-lg font-semibold text-gray-900">
                        {% if timeline_comparison.configured_target_progress != None %}
                            {{ timeline_comparison.configured_target_progress }}%
                        {% else %}
                            {{ timeline_comparison.expected_progress }}%
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Actual Progress</p>
                    <p class="text-lg font-semibold text-gray-900">{{ timeline_comparison.actual_progress }}%</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Variance</p>
                    <p class="text-lg font-semibold {% if timeline_comparison.is_ahead %}text-green-600{% elif timeline_comparison.is_behind %}text-red-600{% else %}text-gray-900{% endif %}">
                        {% if timeline_comparison.progress_variance > 0 %}+{% endif %}{{ timeline_comparison.progress_variance }}%
                    </p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Days Remaining</p>
                    <p class="text-lg font-semibold text-gray-900">{{ timeline_comparison.remaining_days }} days</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Total Working Days</p>
                    <p class="text-lg font-semibold text-gray-900">{{ timeline_comparison.total_days }} days</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Performance Ratio</p>
                    <p class="text-lg font-semibold text-gray-900">
                        {% if performance_ratio is not None %}
                            {{ performance_ratio|floatformat:2 }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </p>
                    <p class="text-[11px] text-gray-500 mt-1">Actual √∑ Expected</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">Efficiency Ratio</p>
                    <p class="text-lg font-semibold text-gray-900">
                        {% if efficiency_ratio is not None %}
                            {{ efficiency_ratio|floatformat:2 }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </p>
                    <p class="text-[11px] text-gray-500 mt-1">Progress √∑ Budget Used %</p>
                </div>
            </div>
            
            <!-- Status Badge -->
            {% if timeline_comparison.is_ahead %}
            <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                    <strong>‚úì On Track:</strong> Project is ahead of schedule by {{ timeline_comparison.progress_variance|floatformat:1 }}%
                </p>
            </div>
            {% elif timeline_comparison.is_behind %}
            <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-sm text-red-800">
                    <strong>‚ö† Behind Schedule:</strong> Project is {{ timeline_comparison.progress_variance|floatformat:1|slice:"1:" }}% behind expected progress
                </p>
            </div>
            {% else %}
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>üìä On Schedule:</strong> Project progress aligns with timeline expectations
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Activity History Log -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Activity History
            </h3>
            
            {% if activity_log %}
                <div class="space-y-4 max-h-96 overflow-y-auto pr-2 activity-history-scroll" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                    {% for activity in activity_log %}
                        <div class="flex items-start gap-4 pb-4 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                            <!-- Icon -->
                            <div class="flex-shrink-0 mt-1">
                                {% if activity.type == 'project_created' %}
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                    </div>
                                {% elif activity.type == 'progress_update' %}
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                {% elif activity.type == 'cost_entry' %}
                                    <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% elif activity.type == 'budget_request' %}
                                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m2 8H7a2 2 0 01-2-2V6a2 2 0 012-2h8l4 4v10a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                {% elif activity.type == 'budget_request_decision' %}
                                    <div class="w-10 h-10 rounded-full {% if activity.status == 'approved' %}bg-green-100{% else %}bg-red-100{% endif %} flex items-center justify-center">
                                        <svg class="w-5 h-5 {% if activity.status == 'approved' %}text-green-700{% else %}text-red-700{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% elif activity.type == 'document_upload' %}
                                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                {% else %}
                                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-4 flex-wrap">
                                    <div class="flex-1">
                                        <p class="text-gray-900 font-medium">{{ activity.message }}</p>
                                        {% if activity.description %}
                                            <p class="text-sm text-gray-600 mt-1">{{ activity.description|truncatewords:30 }}</p>
                                        {% endif %}
                                        {% if activity.justification %}
                                            <div class="mt-2 p-2 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800">
                                                <strong>Justification:</strong> {{ activity.justification|truncatewords:20 }}
                                            </div>
                                        {% endif %}
                                        {% if activity.type == 'progress_update' %}
                                            <div class="mt-2 flex items-center gap-2 flex-wrap">
                                                <span class="text-xs font-semibold text-green-700 bg-green-50 px-2 py-1 rounded">{{ activity.percentage }}% Complete</span>
                                                <span class="text-xs text-gray-500">{{ activity.date|date:"M j, Y" }}</span>
                                                {% if activity.milestone %}
                                                    <span class="text-xs font-semibold text-blue-700 bg-blue-50 px-2 py-1 rounded">Milestone: {{ activity.milestone }}</span>
                                                {% endif %}
                                                {% if activity.progress_id %}
                                                    {% if can_edit_any_progress or activity.user == request.user %}
                                                        <a href="{% url 'projeng:projeng_edit_progress_update' project.pk activity.progress_id %}"
                                                           class="text-xs font-semibold text-indigo-700 bg-indigo-50 px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-100">
                                                            Edit
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% elif activity.type == 'cost_entry' %}
                                            <div class="mt-2 flex items-center gap-2">
                                                <span class="text-xs font-semibold text-yellow-700 bg-yellow-50 px-2 py-1 rounded">{{ activity.cost_type }}</span>
                                                <span class="text-xs text-gray-500">{{ activity.date|date:"M j, Y" }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <p class="text-sm font-medium text-gray-900">
                                            {% if activity.user %}
                                                {{ activity.user.get_full_name|default:activity.user.username }}
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </p>
                                        <p class="text-xs text-gray-500 mt-1">
                                            {{ activity.timestamp|date:"M j, Y" }} at {{ activity.timestamp|time:"g:i A" }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-gray-500">No activity history yet</p>
                    <p class="text-sm text-gray-400 mt-1">Activity will appear here as engineers update the project</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Budget Alert Modal Functions - Make them globally accessible
    window.showBudgetAlertModal = function() {
        const modal = document.getElementById('budgetAlertModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // Ensure flex display for centering
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        } else {
            console.error('Budget alert modal not found!');
        }
    };

    window.hideBudgetAlertModal = function() {
        const modal = document.getElementById('budgetAlertModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        } else {
            console.error('Budget alert modal not found!');
        }
    };

    // Close modal when clicking outside - wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        const budgetModal = document.getElementById('budgetAlertModal');
        if (budgetModal) {
            budgetModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    window.hideBudgetAlertModal();
                }
            });
        } else {
            console.warn('Budget alert modal element not found in DOM');
        }
    });
</script>

<!-- Budget Alert Modal -->
<div id="budgetAlertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display: none;">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Send Budget Alert</h3>
            <button onclick="hideBudgetAlertModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form method="post" action="{% url 'projeng:send_budget_alert' project_id=project.pk %}">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Current Budget Status: <span class="font-semibold {% if budget_utilization >= 100 %}text-red-600{% elif budget_utilization >= 95 %}text-orange-600{% elif budget_utilization >= 80 %}text-yellow-600{% else %}text-green-600{% endif %}">
                        {{ budget_utilization|floatformat:1 }}% utilized
                    </span>
                </label>
                <p class="text-sm text-gray-600 mb-4">
                    Spent: ‚Ç±{{ total_cost|floatformat:2|intcomma }} | Budget: ‚Ç±{{ project.project_cost|floatformat:2|intcomma }} | Remaining: ‚Ç±{{ remaining_budget|floatformat:2|intcomma }}
                </p>
            </div>
            <div class="mb-4">
                <label for="alert-message" class="block text-sm font-medium text-gray-700 mb-2">
                    Describe your budget concern (optional):
                </label>
                <textarea id="alert-message" 
                          name="message" 
                          rows="4" 
                          placeholder="e.g., Upcoming milestone will require additional materials. Anticipated cost: ‚Ç±30,000..."
                          class="w-full border rounded-md p-2 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"></textarea>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                    Send Alert
                </button>
                <button type="button" 
                        onclick="hideBudgetAlertModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Progress Trends Chart
    {% if progress_timeline_data|length > 0 %}
    const progressTrendsCtx = document.getElementById('progressTrendsChart');
    if (progressTrendsCtx) {
        const progressTrendsChart = new Chart(progressTrendsCtx, {
            type: 'line',
            data: {
                labels: {{ progress_dates|safe }},
                datasets: [{
                    label: 'Progress (%)',
                    data: {{ progress_percentages|safe }},
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: 'rgb(34, 197, 94)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return 'Progress: ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Progress Percentage'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Timeline Comparison Chart
    {% if timeline_comparison %}
    const timelineComparisonCtx = document.getElementById('timelineComparisonChart');
    if (timelineComparisonCtx) {
        const timelineComparisonChart = new Chart(timelineComparisonCtx, {
            type: 'line',
            data: {
                labels: {{ expected_dates_json|safe }},
                datasets: [
                    {
                        label: 'Expected Progress',
                        data: {{ expected_progress_data_json|safe }},
                        borderColor: 'rgb(156, 163, 175)',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Actual Progress',
                        data: {{ actual_progress_aligned_json|safe }},
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Progress Percentage'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>

<!-- Upload Document Modal -->
<div id="uploadDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Upload Document
            </h3>
            <button type="button" onclick="closeUploadDocumentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="upload-document-form" class="p-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <div>
                <label for="upload-document-files" class="block text-sm font-medium text-gray-700 mb-2">Select files to upload</label>
                <div id="upload-drop-zone" class="flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-400 transition-colors cursor-pointer">
                    <div class="space-y-2 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-sm text-gray-600">Click to select or drag and drop files</p>
                        <p class="text-xs text-gray-500">PDF, DOC, DOCX, XLS, XLSX, images, etc.</p>
                        <input type="file" id="upload-document-files" name="files" multiple
                               accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv"
                               class="sr-only">
                    </div>
                </div>
                <p id="upload-file-names" class="mt-2 text-xs text-gray-500 hidden"></p>
            </div>
            <div id="upload-document-status" class="text-sm font-medium hidden"></div>
            <div class="flex justify-end gap-2 pt-2">
                <button type="button" onclick="closeUploadDocumentModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button type="submit" id="upload-document-submit" disabled
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2">
                    <span id="upload-document-spinner" class="hidden">
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    Upload
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Documents Modal for Project Engineer -->
<div id="documentsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                All Project Documents
                <span class="text-sm font-normal text-gray-500">({{ documents|length }})</span>
            </h3>
            <button onclick="closeDocumentsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Modal Body - Scrollable -->
        <div class="flex-1 overflow-y-auto p-6">
            {% if documents %}
                <div class="space-y-3">
                    {% for doc in documents %}
                        <div class="flex items-start justify-between gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <p class="text-sm font-medium text-gray-900" title="{{ doc.name }}">
                                        {{ doc.name }}
                                    </p>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-gray-500 ml-7">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                        {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.username }}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        {{ doc.uploaded_at|date:"M j, Y" }}
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        {{ doc.uploaded_at|date:"g:i A" }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <a href="{{ doc.file.url }}" 
                                   target="_blank"
                                   class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                   title="View Document">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </a>
                                <a href="{{ doc.file.url }}" 
                                   download
                                   class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                   title="Download Document">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="text-gray-500 text-lg">No documents uploaded yet</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Modal Footer -->
        <div class="p-6 border-t border-gray-200 flex justify-end">
            <button onclick="closeDocumentsModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                Close
            </button>
        </div>
    </div>
</div>

{% if report_data %}
{{ report_data|json_script:"report-data" }}
{% endif %}

<script>
function openDocumentsModal() {
    document.getElementById('documentsModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').classList.add('hidden');
    document.body.style.overflow = '';
}

function openUploadDocumentModal() {
    document.getElementById('uploadDocumentModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('upload-document-files').value = '';
    document.getElementById('upload-file-names').classList.add('hidden');
    document.getElementById('upload-document-submit').disabled = true;
    document.getElementById('upload-document-status').classList.add('hidden');
}

function closeUploadDocumentModal() {
    document.getElementById('uploadDocumentModal').classList.add('hidden');
    document.body.style.overflow = '';
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const documentsModal = document.getElementById('documentsModal');
    if (documentsModal) {
        documentsModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDocumentsModal();
            }
        });
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const docsModal = document.getElementById('documentsModal');
            const uploadModal = document.getElementById('uploadDocumentModal');
            if (uploadModal && !uploadModal.classList.contains('hidden')) {
                closeUploadDocumentModal();
            } else if (docsModal && !docsModal.classList.contains('hidden')) {
                closeDocumentsModal();
            }
        }
    });

    // Upload Document Modal
    const uploadDocumentModal = document.getElementById('uploadDocumentModal');
    if (uploadDocumentModal) {
        uploadDocumentModal.addEventListener('click', function(e) {
            if (e.target === this) closeUploadDocumentModal();
        });
    }

    const uploadDropZone = document.getElementById('upload-drop-zone');
    const uploadFileInput = document.getElementById('upload-document-files');
    const uploadFileNames = document.getElementById('upload-file-names');
    const uploadSubmitBtn = document.getElementById('upload-document-submit');
    const uploadForm = document.getElementById('upload-document-form');
    const uploadStatus = document.getElementById('upload-document-status');
    const uploadSpinner = document.getElementById('upload-document-spinner');

    if (uploadDropZone && uploadFileInput) {
        uploadDropZone.addEventListener('click', () => uploadFileInput.click());
        uploadDropZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadDropZone.classList.add('border-indigo-500'); });
        uploadDropZone.addEventListener('dragleave', () => uploadDropZone.classList.remove('border-indigo-500'));
        uploadDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropZone.classList.remove('border-indigo-500');
            if (e.dataTransfer.files.length) {
                uploadFileInput.files = e.dataTransfer.files;
                updateUploadFileNames();
            }
        });
    }

    if (uploadFileInput) {
        uploadFileInput.addEventListener('change', updateUploadFileNames);
    }

    function updateUploadFileNames() {
        const files = uploadFileInput.files;
        if (files && files.length > 0) {
            const names = Array.from(files).map(f => f.name).join(', ');
            uploadFileNames.textContent = files.length + ' file(s) selected: ' + (names.length > 60 ? names.substring(0, 60) + '...' : names);
            uploadFileNames.classList.remove('hidden');
            uploadSubmitBtn.disabled = false;
        } else {
            uploadFileNames.classList.add('hidden');
            uploadSubmitBtn.disabled = true;
        }
    }

    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const files = uploadFileInput.files;
            if (!files || files.length === 0) return;

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
                formData.append('names', files[i].name);
            }

            uploadSubmitBtn.disabled = true;
            uploadSpinner.classList.remove('hidden');
            uploadStatus.classList.remove('hidden');
            uploadStatus.className = 'text-sm font-medium text-gray-600';
            uploadStatus.textContent = 'Uploading...';

            fetch('{% url "projeng:projeng_upload_project_document" project.pk %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(res => res.json())
            .then(data => {
                uploadSpinner.classList.add('hidden');
                if (data.success) {
                    uploadStatus.className = 'text-sm font-medium text-green-600';
                    uploadStatus.textContent = data.message || 'Upload successful!';
                    setTimeout(() => {
                        closeUploadDocumentModal();
                        window.location.reload();
                    }, 500);
                } else {
                    uploadStatus.className = 'text-sm font-medium text-red-600';
                    uploadStatus.textContent = data.error || 'Upload failed.';
                    uploadSubmitBtn.disabled = false;
                }
            })
            .catch(err => {
                uploadSpinner.classList.add('hidden');
                uploadStatus.className = 'text-sm font-medium text-red-600';
                uploadStatus.textContent = 'Upload failed: ' + (err.message || 'Network error');
                uploadSubmitBtn.disabled = false;
            });
        });
    }
});
</script>
{% if report_data %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
<script>
(function() {
    function fmtNum(n) { return n != null ? Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'; }
    function fmtPct(n) { return n != null ? Number(n).toFixed(2) + '%' : 'N/A'; }

    var reportDataEl = document.getElementById('report-data');
    var printBtn = document.getElementById('print-report-btn');
    if (!reportDataEl || !printBtn) return;

    function buildPdfAndOpen() {
        try {
            var data = JSON.parse(reportDataEl.textContent);
            var p = data.project || {};
            var scheduled = data.expected_progress != null ? Number(data.expected_progress).toFixed(2) + '%' : 'N/A';
            var actual = data.latest_progress_pct != null ? Number(data.latest_progress_pct).toFixed(2) + '%' : 'N/A';
            var slippage = data.progress_variance != null ? Number(data.progress_variance).toFixed(2) + '%' : 'N/A';

            function linedRow(label, value) {
                return [
                    { text: label, bold: true, margin: [0, 2, 0, 2] },
                    { text: ': ' + (value || 'N/A'), margin: [0, 2, 0, 2] }
                ];
            }

            var durationText = data.total_days ? data.total_days + ' WORKING DAYS' : 'N/A';
            var elapsedText = data.days_elapsed != null ? String(data.days_elapsed) : 'N/A';
            var remainingText = data.days_remaining != null ? String(data.days_remaining) : 'N/A';
            var extensionCount = data.extension_count != null ? String(data.extension_count) : 'N/A';
            var revisedTargetDate = data.revised_target_date || 'N/A';
            var statusText = (p.status || '').toLowerCase();
            var remarksProjectText = 'PROJECT ON GOING';
            if (statusText === 'completed') remarksProjectText = 'PROJECT COMPLETED';
            else if (statusText === 'delayed') remarksProjectText = 'PROJECT DELAYED';
            else if (statusText === 'planned' || statusText === 'pending') remarksProjectText = 'PROJECT PLANNED';
            var asOfText = (p.start_date && p.end_date)
                ? ('AS OF: ' + p.start_date.toUpperCase() + ' TO ' + p.end_date.toUpperCase())
                : ('AS OF: ' + (data.generated_at || '').toUpperCase());

            var preparedName = (data.assigned_engineers && data.assigned_engineers[0])
                ? data.assigned_engineers[0]
                : (data.generated_by || 'N/A');
            var concurredName = data.generated_by || 'N/A';

            var content = [
                {
                    table: {
                        widths: ['*'],
                        body: [[{ text: 'CITY OF TAGUM    |    CEO - CONSTRUCTION DIVISION', alignment: 'center', color: 'white', bold: true, fillColor: '#4f8a3e', margin: [0, 3, 0, 3] }]]
                    },
                    layout: 'noBorders',
                    margin: [0, 0, 0, 2]
                },
                {
                    table: {
                        widths: ['*'],
                        body: [[{ text: 'INDIVIDUAL PROJECT INFORMATION', alignment: 'center', color: 'white', bold: true, fillColor: '#3f3a37', margin: [0, 4, 0, 4], fontSize: 13 }]]
                    },
                    layout: 'noBorders',
                    margin: [0, 0, 0, 2]
                },
                { text: asOfText, alignment: 'center', fontSize: 10, bold: true, margin: [0, 0, 0, 8] },
                {
                    table: {
                        widths: [170, '*'],
                        body: [
                            [{ text: 'PROJECT NAME:', bold: true }, { text: p.name || 'N/A' }],
                            [{ text: 'LOCATION:', bold: true }, { text: p.barangay || 'N/A' }],
                            [{ text: 'REFERENCE NUMBER:', bold: true }, { text: p.prn || 'N/A' }]
                        ]
                    },
                    layout: {
                        hLineColor: function() { return '#666666'; },
                        vLineColor: function() { return '#666666'; },
                        hLineWidth: function() { return 0.8; },
                        vLineWidth: function() { return 0.8; }
                    },
                    margin: [0, 4, 0, 10]
                },
                {
                    table: {
                        widths: [200, '*'],
                        body: [
                            linedRow('Project Cost', 'PHP ' + fmtNum(data.budget)),
                            linedRow('Source of fund', p.source_of_funds || 'N/A'),
                            linedRow('Date Started', p.start_date || 'N/A'),
                            linedRow('Target Date of Completion', p.end_date || 'N/A'),
                            linedRow('Project Duration', durationText),
                            linedRow('No. of Time Extension (if any)', extensionCount),
                            linedRow('Revised target date of completion', revisedTargetDate),
                            linedRow('No. of Days Elapsed to date', elapsedText),
                            linedRow('Remaining No. of Days', remainingText),
                            linedRow('Project Description', p.description || 'N/A'),
                            linedRow('Mode of Implementation', p.mode_of_implementation || 'BY ADMINISTRATION')
                        ]
                    },
                    layout: {
                        hLineColor: function() { return '#8d8d8d'; },
                        vLineWidth: function() { return 0; },
                        hLineWidth: function(i, node) { return i === 0 || i === node.table.body.length ? 0 : 0.5; }
                    },
                    margin: [0, 0, 0, 8]
                },
                {
                    table: {
                        widths: [240, '*'],
                        body: [
                            linedRow('Scheduled Project Accomplishment', scheduled),
                            linedRow('Actual Project Accomplishment', actual),
                            linedRow('Slippage', slippage)
                        ]
                    },
                    layout: {
                        hLineColor: function() { return '#8d8d8d'; },
                        vLineWidth: function() { return 0; },
                        hLineWidth: function(i, node) { return i === 0 || i === node.table.body.length ? 0 : 0.5; }
                    },
                    margin: [0, 2, 0, 10]
                },
                {
                    table: {
                        widths: ['*', 220],
                        body: [[
                            { text: 'REMARKS', bold: true, alignment: 'center', fillColor: '#4d4844', color: 'white' },
                            { text: remarksProjectText, bold: true, alignment: 'center', fillColor: '#4d4844', color: 'white' }
                        ]]
                    },
                    layout: 'noBorders',
                    margin: [0, 8, 0, 26]
                },
                {
                    columns: [
                        {
                            width: '*',
                            stack: [
                                { text: 'Prepared by:', margin: [0, 0, 0, 14] },
                                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 210, y2: 0 }] },
                                { text: preparedName, bold: true, alignment: 'center', margin: [0, 4, 0, 0] },
                                { text: 'Project In-Charge', alignment: 'center' }
                            ]
                        },
                        {
                            width: '*',
                            stack: [
                                { text: 'Concurred by:', margin: [0, 0, 0, 14] },
                                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 210, y2: 0 }] },
                                { text: concurredName, bold: true, alignment: 'center', margin: [0, 4, 0, 0] },
                                { text: 'Head Engineer', alignment: 'center' }
                            ]
                        }
                    ]
                }
            ];

            var doc = {
                pageSize: 'A4',
                pageMargins: [36, 30, 36, 46],
                defaultStyle: { fontSize: 10, font: 'Roboto' },
                styles: { label: { bold: true }, sectionTitle: { bold: true, fontSize: 10 } },
                footer: function(i, n) { return { text: 'Page ' + i + ' of ' + n, alignment: 'center', fontSize: 8 }; },
                content: content
            };
            if (typeof pdfMake !== 'undefined') {
                pdfMake.createPdf(doc).open();
            } else {
                alert('PDF library not loaded. Please refresh and try again.');
            }
        } catch (err) {
            console.error('PDF generation error:', err);
            alert('Failed to generate PDF: ' + (err.message || 'Unknown error'));
        }
    }

    window.printReportPdf = buildPdfAndOpen;
    printBtn.addEventListener('click', function(e) {
        e.preventDefault();
        buildPdfAndOpen();
    });
})();
</script>
{% endif %}
{% endblock %}
