{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Project List</h1>
                    <p class="text-gray-600 text-sm lg:text-base">Manage and view all city development projects</p>
                </div>
                <button id="add-project-btn" class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 hover:shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Project
                </button>
            </div>
        </div>

        <!-- Filters Card -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6">
            <form id="barangay-filter-form" method="get" class="grid grid-cols-1 md:grid-cols-8 gap-4">
                <div>
                    <label for="barangay-filter" class="block text-sm font-semibold text-gray-700 mb-2">Barangay</label>
                    <select id="barangay-filter" name="barangay" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" onchange="this.form.submit()">
                        <option value="" {% if not request.GET.barangay %}selected{% endif %}>All Barangays</option>
                        <option value="Apokon" {% if request.GET.barangay == 'Apokon' %}selected{% endif %}>Apokon</option>
                        <option value="Bincungan" {% if request.GET.barangay == 'Bincungan' %}selected{% endif %}>Bincungan</option>
                        <option value="Busaon" {% if request.GET.barangay == 'Busaon' %}selected{% endif %}>Busaon</option>
                        <option value="Canocotan" {% if request.GET.barangay == 'Canocotan' %}selected{% endif %}>Canocotan</option>
                        <option value="Cuambogan" {% if request.GET.barangay == 'Cuambogan' %}selected{% endif %}>Cuambogan</option>
                        <option value="La Filipina" {% if request.GET.barangay == 'La Filipina' %}selected{% endif %}>La Filipina</option>
                        <option value="Liboganon" {% if request.GET.barangay == 'Liboganon' %}selected{% endif %}>Liboganon</option>
                        <option value="Madaum" {% if request.GET.barangay == 'Madaum' %}selected{% endif %}>Madaum</option>
                        <option value="Magdum" {% if request.GET.barangay == 'Magdum' %}selected{% endif %}>Magdum</option>
                        <option value="Magugpo East" {% if request.GET.barangay == 'Magugpo East' %}selected{% endif %}>Magugpo East</option>
                        <option value="Magugpo North" {% if request.GET.barangay == 'Magugpo North' %}selected{% endif %}>Magugpo North</option>
                        <option value="Magugpo Poblacion" {% if request.GET.barangay == 'Magugpo Poblacion' %}selected{% endif %}>Magugpo Poblacion</option>
                        <option value="Magugpo South" {% if request.GET.barangay == 'Magugpo South' %}selected{% endif %}>Magugpo South</option>
                        <option value="Magugpo West" {% if request.GET.barangay == 'Magugpo West' %}selected{% endif %}>Magugpo West</option>
                        <option value="Mankilam" {% if request.GET.barangay == 'Mankilam' %}selected{% endif %}>Mankilam</option>
                        <option value="New Balamban" {% if request.GET.barangay == 'New Balamban' %}selected{% endif %}>New Balamban</option>
                        <option value="Nueva Fuerza" {% if request.GET.barangay == 'Nueva Fuerza' %}selected{% endif %}>Nueva Fuerza</option>
                        <option value="Pagsabangan" {% if request.GET.barangay == 'Pagsabangan' %}selected{% endif %}>Pagsabangan</option>
                        <option value="Pandapan" {% if request.GET.barangay == 'Pandapan' %}selected{% endif %}>Pandapan</option>
                        <option value="San Agustin" {% if request.GET.barangay == 'San Agustin' %}selected{% endif %}>San Agustin</option>
                        <option value="San Isidro" {% if request.GET.barangay == 'San Isidro' %}selected{% endif %}>San Isidro</option>
                        <option value="San Miguel" {% if request.GET.barangay == 'San Miguel' %}selected{% endif %}>San Miguel</option>
                        <option value="Visayan Village" {% if request.GET.barangay == 'Visayan Village' %}selected{% endif %}>Visayan Village</option>
                    </select>
                </div>
                <div>
                    <label for="status-filter" class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select id="status-filter" name="status" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" onchange="this.form.submit()">
                        <option value="" {% if not request.GET.status %}selected{% endif %}>All Statuses</option>
                        <option value="planned" {% if request.GET.status == 'planned' %}selected{% endif %}>Planned</option>
                        <option value="in_progress" {% if request.GET.status == 'in_progress' or request.GET.status == 'ongoing' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="delayed" {% if request.GET.status == 'delayed' %}selected{% endif %}>Delayed</option>
                    </select>
                </div>
                <div>
                    <label for="duration-filter" class="block text-sm font-semibold text-gray-700 mb-2">Duration</label>
                    <select id="duration-filter" name="duration" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" onchange="this.form.submit()">
                        <option value="" {% if not request.GET.duration %}selected{% endif %}>All Durations</option>
                        <option value="lt6" {% if request.GET.duration == 'lt6' %}selected{% endif %}>< 6 months</option>
                        <option value="6to12" {% if request.GET.duration == '6to12' %}selected{% endif %}>6-12 months</option>
                        <option value="gt12" {% if request.GET.duration == 'gt12' %}selected{% endif %}>> 1 year</option>
                    </select>
                </div>
                <div>
                    <label for="source-of-funds-filter" class="block text-sm font-semibold text-gray-700 mb-2">Source of Funds</label>
                    <select id="source-of-funds-filter" name="source_of_funds" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" onchange="this.form.submit()">
                        <option value="" {% if not request.GET.source_of_funds %}selected{% endif %}>All Sources</option>
                        {% for sof in source_of_funds_options %}
                            <option value="{{ sof.name }}" {% if request.GET.source_of_funds == sof.name %}selected{% endif %}>{{ sof.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="project-type-filter" class="block text-sm font-semibold text-gray-700 mb-2">Project Type</label>
                    <select id="project-type-filter" name="project_type" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" onchange="this.form.submit()">
                        <option value="" {% if not request.GET.project_type %}selected{% endif %}>All Types</option>
                        {% for pt in project_type_options %}
                            <option value="{{ pt.id }}" {% if request.GET.project_type == pt.id|stringformat:"s" %}selected{% endif %}>{{ pt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="cost-min-filter" class="block text-sm font-semibold text-gray-700 mb-2">Cost Min</label>
                    <input id="cost-min-filter" name="cost_min" type="number" step="0.01" inputmode="decimal" value="{{ request.GET.cost_min }}" placeholder="‚Ç± min" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" />
                </div>
                <div>
                    <label for="cost-max-filter" class="block text-sm font-semibold text-gray-700 mb-2">Cost Max</label>
                    <input id="cost-max-filter" name="cost_max" type="number" step="0.01" inputmode="decimal" value="{{ request.GET.cost_max }}" placeholder="‚Ç± max" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300" />
                </div>
            </form>
        </div>

        <!-- Projects Table Card -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-[900px] divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">#</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">PRN#</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Name of Project</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Description</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Location</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Project Cost</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Source of Funds</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Project Type</th>
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="project-table-body" class="bg-white divide-y divide-gray-200">
                        {% for project in page_obj.object_list %}
                        <tr data-project-id="{{ project.id }}" class="hover:bg-blue-50 transition-colors duration-150">
                            <td class="px-4 py-4 text-sm font-medium text-gray-900">{{ page_obj.start_index|add:forloop.counter0 }}</td>
                            <td class="px-4 py-4 text-sm text-gray-700 project-prn font-mono">{{ project.prn|default_if_none:'‚Äî' }}</td>
                            <td class="px-4 py-4 text-sm font-semibold text-gray-900 break-words project-name">{{ project.name }}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 break-words project-description">{{ project.description|truncatechars:40|default_if_none:'‚Äî' }}</td>
                            <td class="px-4 py-4 text-sm text-gray-700 project-barangay">{{ project.barangay|default_if_none:'‚Äî' }}</td>
                            <td class="px-4 py-4 text-sm font-medium text-gray-900 project-cost">
                                {% if project.project_cost %}
                                    ‚Ç±{{ project.project_cost|floatformat:2|intcomma }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600 project-funds">{{ project.source_of_funds|default_if_none:'‚Äî' }}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 project-type">{% if project.project_type %}{{ project.project_type.name }}{% else %}‚Äî{% endif %}</td>
                            <td class="px-4 py-4 text-center project-status">
                                {% with calculated_status=project.calculated_status|default:project.status %}
                                {% if calculated_status == 'completed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Completed</span>
                                {% elif calculated_status == 'delayed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Delayed</span>
                                {% elif calculated_status == 'ongoing' or calculated_status == 'in_progress' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Ongoing</span>
                                {% elif calculated_status == 'planned' or calculated_status == 'pending' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">Planned</span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">{{ calculated_status|title }}</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td class="px-4 py-4 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button title="View" onclick="openDetailsModal({{ project.id }})" class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </button>
                                    <button title="Edit" onclick="openEditModal({{ project.id }})" class="p-2 text-gray-600 hover:text-yellow-600 hover:bg-yellow-50 rounded-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button title="Delete" onclick="openDeleteModal({{ project.id }})" class="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-12">
                                <div class="flex flex-col items-center">
                                    <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-500 text-lg font-medium">No projects found</p>
                                    <p class="text-gray-400 text-sm mt-1">Try adjusting your filters</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-semibold">{{ page_obj.start_index }}</span> to <span class="font-semibold">{{ page_obj.end_index }}</span> of <span class="font-semibold">{{ page_obj.paginator.count }}</span> projects
                    </div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.barangay %}&barangay={{ request.GET.barangay }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.duration %}&duration={{ request.GET.duration }}{% endif %}{% if request.GET.source_of_funds %}&source_of_funds={{ request.GET.source_of_funds }}{% endif %}{% if request.GET.project_type %}&project_type={{ request.GET.project_type }}{% endif %}{% if request.GET.cost_min %}&cost_min={{ request.GET.cost_min }}{% endif %}{% if request.GET.cost_max %}&cost_max={{ request.GET.cost_max }}{% endif %}" class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Previous
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Previous
                            </span>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span aria-current="page" class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-semibold text-blue-600">
                                    {{ num }}
                                </span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}{% if request.GET.barangay %}&barangay={{ request.GET.barangay }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.duration %}&duration={{ request.GET.duration }}{% endif %}{% if request.GET.source_of_funds %}&source_of_funds={{ request.GET.source_of_funds }}{% endif %}{% if request.GET.project_type %}&project_type={{ request.GET.project_type }}{% endif %}{% if request.GET.cost_min %}&cost_min={{ request.GET.cost_min }}{% endif %}{% if request.GET.cost_max %}&cost_max={{ request.GET.cost_max }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    {{ num }}
                                </a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.barangay %}&barangay={{ request.GET.barangay }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.duration %}&duration={{ request.GET.duration }}{% endif %}{% if request.GET.source_of_funds %}&source_of_funds={{ request.GET.source_of_funds }}{% endif %}{% if request.GET.project_type %}&project_type={{ request.GET.project_type }}{% endif %}{% if request.GET.cost_min %}&cost_min={{ request.GET.cost_min }}{% endif %}{% if request.GET.cost_max %}&cost_max={{ request.GET.cost_max }}{% endif %}" class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                Next
                                <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                Next
                                <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </span>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-apply filters (remove need for Apply/Clear)
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('barangay-filter-form');
    if (!form) return;

    const autoSubmit = () => {
        // reset page when filters change
        const existing = form.querySelector('input[name="page"]');
        if (existing) existing.remove();
        const page = document.createElement('input');
        page.type = 'hidden';
        page.name = 'page';
        page.value = '1';
        form.appendChild(page);
        form.submit();
    };

    // Debounce for cost min/max typing
    let t;
    ['cost-min-filter', 'cost-max-filter'].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(autoSubmit, 500);
        });
        el.addEventListener('change', () => {
            clearTimeout(t);
            t = setTimeout(autoSubmit, 150);
        });
    });
});
</script>

    <!-- Add/Edit Project Modal (compact for laptop) -->
    <div id="project-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-y-auto transition-opacity duration-300 opacity-0 pointer-events-none p-2">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl p-0 relative max-h-[90vh] overflow-y-auto animate-modal-scale">
            <button id="close-modal" class="absolute top-4 right-4 z-30 w-10 h-10 flex items-center justify-center bg-blue-700 text-white text-2xl rounded-full border-2 border-white shadow hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all duration-200">&times;</button>
            <form id="project-form" method="post" enctype="multipart/form-data" action="{% url 'project_list' %}" class="w-full p-4 md:p-5">
                {% csrf_token %}
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">
                    <!-- Left column: PRN, Name, Description, Barangay, Project Cost, Project Type -->
                    <div class="lg:col-span-5 space-y-3">
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">PRN</label>
                            <input type="text" name="prn" readonly inputmode="none" aria-readonly="true"
                                   class="mt-1 w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" />
                            <p class="text-[10px] text-gray-500 mt-0.5">Auto-generated (not editable)</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">Name</label>
                            <input type="text" name="name" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" required />
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">Description</label>
                            <textarea name="description" rows="2" placeholder="Example: Road concreting (200m); scope, location, key outputs."
                                      class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none resize-y min-h-[4rem]"
                                      required></textarea>
                            <p class="text-[10px] text-gray-500 mt-0.5">Scope, location, key outputs.</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">Barangay</label>
                            <select name="barangay" id="modal-barangay-select" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none cursor-pointer" required>
                                <option value="">---------</option>
                                <option value="Apokon">Apokon</option>
                                <option value="Bincungan">Bincungan</option>
                                <option value="Busaon">Busaon</option>
                                <option value="Canocotan">Canocotan</option>
                                <option value="Cuambogan">Cuambogan</option>
                                <option value="La Filipina">La Filipina</option>
                                <option value="Liboganon">Liboganon</option>
                                <option value="Madaum">Madaum</option>
                                <option value="Magdum">Magdum</option>
                                <option value="Magugpo East">Magugpo East</option>
                                <option value="Magugpo North">Magugpo North</option>
                                <option value="Magugpo Poblacion">Magugpo Poblacion</option>
                                <option value="Magugpo South">Magugpo South</option>
                                <option value="Magugpo West">Magugpo West</option>
                                <option value="Mankilam">Mankilam</option>
                                <option value="New Balamban">New Balamban</option>
                                <option value="Nueva Fuerza">Nueva Fuerza</option>
                                <option value="Pagsabangan">Pagsabangan</option>
                                <option value="Pandapan">Pandapan</option>
                                <option value="San Agustin">San Agustin</option>
                                <option value="San Isidro">San Isidro</option>
                                <option value="San Miguel">San Miguel</option>
                                <option value="Visayan Village">Visayan Village</option>
                            </select>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">Project Cost</label>
                            <input type="number" step="0.01" name="project_cost" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" required />
                        </div>
                        <div>
                            <label class="font-semibold text-gray-700 text-sm">Project Type</label>
                            <select id="project-type-select" name="project_type" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none cursor-pointer">
                                <option value="">Select project type (optional)</option>
                                {% for pt in project_type_options %}
                                    <option value="{{ pt.id }}">{{ pt.name }}</option>
                                {% endfor %}
                                <option value="__add_new__">Add new Project Type</option>
                            </select>
                            <div id="project-type-new-wrap" class="mt-2" style="display: none;">
                                <label class="text-[10px] font-semibold text-gray-500 uppercase tracking-wide block">Or add new</label>
                                <input type="text" name="project_type_new" id="project-type-new-input" class="mt-0.5 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" placeholder="Type new (optional)" />
                            </div>
                        </div>
                    </div>

                    <!-- Right column: Project Location (large), then Dates, Status/Image, Source/Engineers -->
                    <div class="lg:col-span-7 space-y-3">
                        <div class="border-2 border-dashed border-blue-300 rounded-lg p-3 bg-blue-50 min-h-[7.5rem] flex flex-col justify-between">
                            <div>
                                <label class="font-semibold text-blue-700 text-sm mb-1 block">üìç Project Location <span class="text-red-500">*</span></label>
                                <p class="text-[10px] text-gray-600 mb-2">Click the button below to select location on the map</p>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="text-[10px] font-medium text-gray-600">Latitude</label>
                                        <input type="hidden" name="latitude" id="latitude-input" />
                                        <p class="text-[11px] text-gray-700 mt-1 font-mono" id="latitude-display">Set automatically when you pick a point on the map.</p>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-medium text-gray-600">Longitude</label>
                                        <input type="hidden" name="longitude" id="longitude-input" />
                                        <p class="text-[11px] text-gray-700 mt-1 font-mono" id="longitude-display">Set automatically when you pick a point on the map.</p>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="map-fullscreen-btn"
                                    class="w-full bg-blue-700 hover:bg-blue-800 text-white font-semibold px-3 py-2 rounded-lg shadow transition flex items-center justify-center gap-1.5 text-sm"
                                    title="Click to open map and select location">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span id="map-btn-text">Select Location on Map</span>
                            </button>
                            <div id="location-status" class="mt-1 text-[10px] hidden">
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-green-100 text-green-700">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Location selected
                                </span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="font-semibold text-gray-700 text-sm">Start Date</label>
                                {% if request.user.is_superuser or request.user.groups.all.0.name == 'Head Engineer' %}
                                <input type="date" name="start_date" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" required />
                                {% else %}
                                <input type="date" name="start_date" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" required disabled />
                                {% endif %}
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700 text-sm">End Date</label>
                                {% if request.user.is_superuser or request.user.groups.all.0.name == 'Head Engineer' %}
                                <input type="date" name="end_date" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" required />
                                {% else %}
                                <input type="date" name="end_date" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" required disabled />
                                {% endif %}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="font-semibold text-gray-700 text-sm">Status</label>
                                <select name="status" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none cursor-pointer" required>
                                    <option value="">---------</option>
                                    <option value="planned">Planned</option>
                                    <option value="in_progress">Ongoing</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold text-gray-700 text-sm">Image</label>
                                <input type="file" name="image" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none cursor-pointer file:mr-2 file:py-1.5 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="image-input" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="font-semibold text-gray-700 text-sm">Source of Funds</label>
                                <select id="source-of-funds-select" name="source_of_funds" class="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none cursor-pointer" required>
                                    <option value="">Select source of funds</option>
                                    {% for sof in source_of_funds_options %}
                                        <option value="{{ sof.name }}">{{ sof.name }}</option>
                                    {% endfor %}
                                    <option value="__add_new__">Add new Source of Funds</option>
                                </select>
                                <div id="source-of-funds-new-wrap" class="mt-2" style="display: none;">
                                    <label class="text-[10px] font-semibold text-gray-500 uppercase tracking-wide block">Or add new</label>
                                    <input type="text" name="source_of_funds_new" id="source-of-funds-new-input" class="mt-0.5 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none" placeholder="Type new (optional)" />
                                </div>
                            </div>
                            <div class="relative pt-3 border-t border-gray-100">
                                <label class="font-semibold text-gray-700 text-sm">Assigned Engineers <span class="text-red-500">*</span></label>
                                <p class="text-[10px] text-gray-500 mt-0.5 mb-1">Search or scroll, click to add. Remove with √ó on chip.</p>
                                <div id="assigned-engineers-chips" class="mb-1 flex flex-wrap gap-1.5 min-h-[1.5rem]"></div>
                                <input type="text" id="assigned-engineers-search"
                                       class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm w-full focus:ring-2 focus:ring-blue-400 outline-none mb-1"
                                       placeholder="Search by name or username..." autocomplete="off" />
                                <p class="text-[10px] font-medium text-gray-600 mb-0.5">Engineers ‚Äî click to add</p>
                                <div id="assigned-engineers-list" class="border border-gray-200 rounded-lg bg-gray-50 max-h-28 overflow-y-auto"></div>
                                <select name="assigned_engineers" id="assigned-engineers-select" class="sr-only" multiple required aria-hidden="true" tabindex="-1">
                                    <!-- Options populated by JS; kept for form submit -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-gray-100">
                    <button type="button" onclick="closeProjectModal()" class="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm shadow-sm">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-blue-700 hover:bg-blue-800 text-white font-semibold rounded-lg text-sm shadow-sm flex items-center gap-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        Save Project
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal - Landscape Style -->
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden" style="opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl relative mx-4 my-4 max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header with Gradient -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-2xl px-4 py-3 relative flex-shrink-0">
                <button id="close-details-modal" class="absolute top-3 right-3 text-white hover:text-gray-200 text-2xl font-bold w-8 h-8 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-all">&times;</button>
                <div class="flex items-start gap-3 pr-10">
                    <img id="details-image" class="w-12 h-12 object-cover object-center rounded-lg bg-white bg-opacity-20 border-2 border-white border-opacity-30 shadow-lg flex-shrink-0" alt="Project image" style="display: none;" onerror="this.onerror=null;this.style.display='none';" />
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                            <h2 class="text-lg font-bold text-white" id="details-title">Project Details</h2>
                            <span id="details-status"></span>
                        </div>
                        <div class="text-sm font-semibold text-white mb-0.5" id="details-name"></div>
                        <div class="text-xs text-blue-100 font-mono" id="details-prn"></div>
                    </div>
                </div>
            </div>
            
            <!-- Content - Scrollable -->
            <div class="p-3 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <!-- Project Info Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-2 border-l-4 border-blue-500">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div class="w-6 h-6 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">‚ÑπÔ∏è</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Project Info</h3>
                        </div>
                        <div class="bg-white rounded-lg p-1.5 shadow-sm">
                            <div class="text-xs text-gray-500 uppercase mb-1">Description</div>
                            <div class="text-xs font-medium text-gray-800" id="details-description">No description</div>
                        </div>
                    </div>
                    
                    <!-- Financial Card -->
                    <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-2 border-l-4 border-yellow-500">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div class="w-6 h-6 bg-yellow-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">üí∞</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Financial</h3>
                        </div>
                        <div class="space-y-1.5">
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">Project Cost</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-cost">‚Äî</div>
                            </div>
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">Total Spent</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-spent">‚Äî</div>
                            </div>
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">Remaining Funds</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-remaining">‚Äî</div>
                            </div>
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">Source of Funds</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-funds">‚Äî</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates Card -->
                    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl p-2 border-l-4 border-indigo-500">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div class="w-6 h-6 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">üìÖ</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Timeline</h3>
                        </div>
                        <div class="space-y-1.5">
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">Start Date</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-start-date">‚Äî</div>
                            </div>
                            <div class="bg-white rounded-lg p-1.5 shadow-sm">
                                <div class="text-xs text-gray-500 uppercase mb-1">End Date</div>
                                <div class="text-xs font-semibold text-gray-800" id="details-end-date">‚Äî</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Card (Conditional) -->
                    <div id="details-progress-section" class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-2 border-l-4 border-purple-500 hidden">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div class="w-6 h-6 bg-purple-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">üìà</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Progress</h3>
                        </div>
                        <div class="bg-white rounded-lg p-2 shadow-sm">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                                <div id="details-progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="details-progress-text" class="text-xs font-semibold text-gray-700 text-center">0% Complete</div>
                        </div>
                    </div>
                    
                    <!-- Assigned Engineers Card -->
                    <div class="bg-gradient-to-br from-gray-50 to-slate-50 rounded-xl p-2 border-l-4 border-gray-400">
                        <div class="flex items-center gap-2 mb-1.5">
                            <div class="w-6 h-6 bg-gray-400 rounded-lg flex items-center justify-center text-white font-bold text-xs">üë∑</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Assigned Engineer(s)</h3>
                        </div>
                        <div class="bg-white rounded-lg p-1.5 shadow-sm">
                            <div id="details-assigned-engineers" class="text-xs text-gray-700">None assigned</div>
                        </div>
                    </div>
                    
                    <!-- Location Card - Full Width -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-2 border-l-4 border-green-500 lg:col-span-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">üìç</div>
                            <h3 class="font-bold text-gray-800 text-xs uppercase tracking-wide">Location</h3>
                        </div>
                        <!-- Side-by-side Layout: Details Left, Map Right -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <!-- Left Side: Location Details -->
                            <div class="space-y-1.5">
                                <div class="bg-white rounded-lg p-2 shadow-sm">
                                    <div class="text-xs text-gray-500 uppercase mb-1">Barangay</div>
                                    <div class="text-xs font-semibold text-gray-800" id="details-barangay">‚Äî</div>
                                </div>
                                <div class="bg-white rounded-lg p-2 shadow-sm">
                                    <div class="text-xs text-gray-500 uppercase mb-1">Zone Type</div>
                                    <div class="text-xs font-semibold text-gray-800" id="details-zone-type">‚Äî</div>
                                </div>
                                <div class="bg-white rounded-lg p-2 shadow-sm">
                                    <div class="text-xs text-gray-500 uppercase mb-1">Latitude</div>
                                    <div class="text-xs font-mono text-gray-700" id="details-latitude">‚Äî</div>
                                </div>
                                <div class="bg-white rounded-lg p-2 shadow-sm">
                                    <div class="text-xs text-gray-500 uppercase mb-1">Longitude</div>
                                    <div class="text-xs font-mono text-gray-700" id="details-longitude">‚Äî</div>
                                </div>
                            </div>
                            <!-- Right Side: Map -->
                            <div class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
                                <div id="details-map" class="w-full rounded-lg" style="height: 200px; min-height: 200px; background-color: #f3f4f6;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative mx-2">
            <button id="close-delete-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-red-700">Delete Project</h2>
            <p class="mb-6">Are you sure you want to delete this project?</p>
            <div class="flex justify-end gap-2">
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-2 rounded-lg shadow transition">Delete</button>
                <button id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-6 py-2 rounded-lg shadow transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="success-toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden transition-all duration-300"></div>

    <!-- Popup Map Modal -->
    <div id="map-popup-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 overflow-y-auto hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl p-6 relative mx-4 my-4">
            <button type="button" id="close-map-popup" class="absolute top-4 right-4 z-30 w-10 h-10 flex items-center justify-center bg-blue-700 text-white text-2xl rounded-full border-4 border-white shadow-lg hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200">&times;</button>
            
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">üìç Select Project Location</h2>
                <p class="text-gray-600 text-sm">
                    Click anywhere on the map to set the project location. You can also drag the marker to adjust the position.
                </p>
            </div>
            
            <div id="popup-map" style="min-height:400px; height:70vh; background:#eee;" class="rounded-lg border-2 border-blue-300 w-full mb-4"></div>
            
            <div class="flex items-center justify-between bg-blue-50 p-4 rounded-lg mb-4">
                <div>
                    <p class="text-sm font-medium text-gray-700">Selected Coordinates:</p>
                    <p class="text-lg font-mono text-blue-700">
                        <span id="selected-lat-display">--</span>¬∞N, 
                        <span id="selected-lng-display">--</span>¬∞E
                    </p>
                </div>
                <button 
                    type="button" 
                    id="use-current-location-btn" 
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow transition flex items-center gap-2 text-sm"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Use My Location
                </button>
            </div>
            
            <div class="flex justify-end gap-4">
                <button type="button" id="close-map-popup-btn" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg shadow transition">Cancel</button>
                <button type="button" id="confirm-location-btn" class="px-6 py-2 bg-blue-700 hover:bg-blue-800 text-white font-semibold rounded-lg shadow transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Confirm Location
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
{{ block.super }}
{% if projects_data %}
{{ projects_data|json_script:"projects-data" }}
{% else %}
<script id="projects-data" type="application/json">[]</script>
{% endif %}
<script>
window.currentUsername = "{{ request.user.username|escapejs }}";
</script>
<script>
// Initialize window.projects as an array
window.projects = [];

var projectsDataElement = document.getElementById('projects-data');
if (projectsDataElement) {
    try {
        let rawContent = projectsDataElement.textContent.trim();
        console.log('Raw projects-data content:', rawContent.substring(0, 100) + '...');
        
        // Parse the JSON
        let parsed = JSON.parse(rawContent);
        console.log('Parsed projects-data type:', typeof parsed, 'IsArray:', Array.isArray(parsed));
        
        // Handle different data types
        if (Array.isArray(parsed)) {
            window.projects = parsed;
            console.log('‚úÖ Loaded', parsed.length, 'projects from array');
        } else if (parsed && typeof parsed === 'object') {
            // If it's an object, try to convert to array
            window.projects = Object.values(parsed);
            console.log('‚úÖ Converted object to array, loaded', window.projects.length, 'projects');
        } else if (typeof parsed === 'string') {
            // If it's still a string, try parsing again
            console.warn('‚ö†Ô∏è Parsed data is still a string, attempting re-parse...');
            try {
                parsed = JSON.parse(parsed);
                if (Array.isArray(parsed)) {
                    window.projects = parsed;
                } else {
                    window.projects = [];
                }
            } catch (e2) {
                console.error('‚ùå Re-parse failed:', e2);
                window.projects = [];
            }
        } else {
            console.warn('‚ö†Ô∏è projects-data is not an array or object:', typeof parsed, parsed);
            window.projects = [];
        }
    } catch (e) {
        console.error('‚ùå Error parsing projects-data JSON:', e);
        console.error('Raw content:', projectsDataElement.textContent.substring(0, 200));
        window.projects = [];
    }
} else {
    console.warn('‚ö†Ô∏è projects-data element not found');
    window.projects = [];
}

// Ensure window.projects is always an array
if (!Array.isArray(window.projects)) {
    console.warn('window.projects is not an array, converting...', typeof window.projects);
    window.projects = [];
}

console.log('window.projects initialized:', window.projects.length, 'projects, Type:', typeof window.projects, 'IsArray:', Array.isArray(window.projects));

// Fix Leaflet icon paths to use CDN if local files are missing
// This must run after Leaflet is loaded (which happens in base.html)
if (typeof L !== 'undefined') {
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    console.log('Leaflet icon paths configured to use CDN');
}

const barangayCoordinates = {
    'Apokon': [7.4237747, 125.8259557],
    'Bincungan': [7.3788027, 125.7547817],
    'Busaon': [7.3599983, 125.7535189],
    'Canocotan': [7.4001209, 125.7740386],
    'Cuambogan': [7.4912804, 125.7927462],
    'La Filipina': [7.4764565, 125.8053029],
    'Liboganon': [7.3464940, 125.7767654],
    'Madaum': [7.3826395, 125.8087180],
    'Magdum': [7.4692173, 125.8347371],
    'Magugpo East': [7.4493737, 125.8196061],
    'Magugpo North': [7.4596946, 125.8161767],
    'Magugpo Poblacion': [7.4472333, 125.8043897],
    'Magugpo South': [7.4472497, 125.7950305],
    'Magugpo West': [7.4567492, 125.8031452],
    'Mankilam': [7.4607703, 125.7848619],
    'New Balamban': [7.4952507, 125.8452198],
    'Nueva Fuerza': [7.4993765, 125.8186816],
    'Pagsabangan': [7.4825329, 125.7518306],
    'Pandapan': [7.4826495, 125.8758813],
    'San Agustin': [7.4920504, 125.8259339],
    'San Isidro': [7.3939060, 125.7854038],
    'San Miguel': [7.4422203, 125.7761364],
    'Visayan Village': [7.4318430, 125.8037910],
};

// --- Modal Logic ---
let deleteProjectId = null;
let editProjectId = null;
const projectModal = document.getElementById('project-modal');
const projectForm = document.getElementById('project-form');
const addProjectBtn = document.getElementById('add-project-btn');
const closeModal = document.getElementById('close-modal');
const cancelBtn = document.querySelector('button[type="button"][onclick="closeProjectModal()"]');
const imageInput = document.getElementById('image-input');
const closeDetailsModal = document.getElementById('close-details-modal');
const closeDeleteModal = document.getElementById('close-delete-modal');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
const successToast = document.getElementById('success-toast');
const modalBarangaySelect = document.getElementById('modal-barangay-select');
const assignedEngineersSelect = document.getElementById('assigned-engineers-select');
const assignedEngineersSearch = document.getElementById('assigned-engineers-search');
const assignedEngineersChips = document.getElementById('assigned-engineers-chips');

// Source of funds UX: show input when "Add new Source of Funds" selected, auto-add to dropdown on blur/Enter
function initSourceOfFundsUX() {
    if (!projectForm) return;
    const fundsSelect = projectForm.querySelector('select[name="source_of_funds"]');
    const fundsNew = projectForm.querySelector('input[name="source_of_funds_new"]');
    const fundsNewWrap = document.getElementById('source-of-funds-new-wrap');
    if (!fundsSelect || !fundsNew) return;
    if (fundsSelect.dataset.fundsUx === '1') return;
    fundsSelect.dataset.fundsUx = '1';

    // Show "add new" input only when "Add new Source of Funds" is selected
    if (fundsNewWrap) {
        fundsNewWrap.style.display = 'none';
        fundsSelect.addEventListener('change', function() {
            if (fundsSelect.value === '__add_new__') {
                fundsNewWrap.style.display = 'block';
                fundsNew.focus();
            } else {
                fundsNewWrap.style.display = 'none';
                fundsNew.value = '';
            }
        });
    }
    projectForm.addEventListener('submit', function() {
        if (fundsSelect.value === '__add_new__') {
            fundsSelect.value = '';
        }
    });

    const ensureOptionEverywhere = (val) => {
        const v = (val || '').trim();
        if (!v) return;
        // Update ALL "source_of_funds" selects on the page (modal + filter dropdowns)
        const allSelects = Array.from(document.querySelectorAll('select[name="source_of_funds"]'));
        allSelects.forEach(sel => {
            const has = Array.from(sel.options).some(o => (o.value || '').trim() === v);
            if (!has) {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                sel.appendChild(opt);
            }
        });
        fundsSelect.value = v;
    };

    const submitNew = () => {
        const v = (fundsNew.value || '').trim();
        if (v) {
            ensureOptionEverywhere(v);
            fundsNew.value = '';
        }
    };

    fundsNew.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitNew();
        }
    });
    fundsNew.addEventListener('blur', () => submitNew());

    fundsSelect.addEventListener('change', () => {
        if ((fundsSelect.value || '').trim() && fundsSelect.value !== '__add_new__') {
            fundsNew.value = '';
        }
    });
}

// Project type UX: allow adding new ProjectType and sync across dropdowns
function initProjectTypeUX() {
    if (!projectForm) return;
    const typeSelect = projectForm.querySelector('select[name="project_type"]');
    const typeNew = projectForm.querySelector('input[name="project_type_new"]');
    const typeNewWrap = document.getElementById('project-type-new-wrap');
    if (!typeSelect || !typeNew) return;
    if (typeSelect.dataset.ptUx === '1') return;
    typeSelect.dataset.ptUx = '1';

    // Show "add new" input only when "Add new Project Type" is selected
    if (typeNewWrap) {
        typeNewWrap.style.display = 'none';
        typeSelect.addEventListener('change', function() {
            if (typeSelect.value === '__add_new__') {
                typeNewWrap.style.display = 'block';
                typeNew.focus();
            } else {
                typeNewWrap.style.display = 'none';
                typeNew.value = '';
            }
        });
    }
    projectForm.addEventListener('submit', function() {
        if (typeSelect.value === '__add_new__') {
            typeSelect.value = '';
        }
    });

    const getCookie = (name) => {
        const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return m ? decodeURIComponent(m[2]) : '';
    };

    const ensureOptionEverywhere = (id, label) => {
        const allSelects = Array.from(document.querySelectorAll('select[name="project_type"]'));
        allSelects.forEach(sel => {
            const has = Array.from(sel.options).some(o => (o.value || '') === String(id));
            if (!has) {
                const opt = document.createElement('option');
                opt.value = String(id);
                opt.textContent = label;
                sel.appendChild(opt);
            }
        });
        typeSelect.value = String(id);
    };

    const createType = async (name) => {
        const resp = await fetch("{% url 'create_project_type_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
            body: JSON.stringify({ name }),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.success) {
            const msg = (data && (data.error || data.message)) || 'Failed to create project type.';
            throw new Error(msg);
        }
        return data;
    };

    const submitNew = async () => {
        const name = (typeNew.value || '').trim();
        if (!name) return;
        try {
            const data = await createType(name);
            ensureOptionEverywhere(data.id, data.name || name);
            typeNew.value = '';
        } catch (e) {
            console.error(e);
            alert(e.message || 'Failed to create project type.');
        }
    };

    typeNew.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitNew();
        }
    });
    typeNew.addEventListener('blur', () => {
        // Create on blur for mouse users
        submitNew();
    });
    typeSelect.addEventListener('change', () => {
        if ((typeSelect.value || '').trim() && typeSelect.value !== '__add_new__') {
            typeNew.value = '';
        }
    });
}

function _normalizeText(val) {
    return (val || '').toString().trim().toLowerCase();
}

function renderAssignedEngineerChips() {
    if (!assignedEngineersSelect || !assignedEngineersChips) return;
    assignedEngineersChips.innerHTML = '';
    const selected = Array.from(assignedEngineersSelect.selectedOptions || []);
    if (selected.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'text-xs text-gray-500';
        empty.textContent = 'No engineers selected yet.';
        assignedEngineersChips.appendChild(empty);
        return;
    }
    selected.forEach(opt => {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-blue-800 border border-blue-200 text-sm';
        chip.textContent = opt.textContent || opt.value;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-blue-700 hover:text-blue-900 font-bold leading-none';
        btn.setAttribute('aria-label', `Remove ${opt.textContent || 'engineer'}`);
        btn.textContent = '√ó';
        btn.addEventListener('click', () => {
            opt.selected = false;
            assignedEngineersSelect.dispatchEvent(new Event('change', { bubbles: true }));
        });

        chip.appendChild(btn);
        assignedEngineersChips.appendChild(chip);
    });
}

var _projectListEngineers = [];

function getSelectedEngineerIds() {
    if (!assignedEngineersSelect) return [];
    return Array.from(assignedEngineersSelect.selectedOptions || []).map(o => o.value);
}

function buildAssignedEngineersList() {
    const listEl = document.getElementById('assigned-engineers-list');
    const searchEl = assignedEngineersSearch;
    if (!listEl || !assignedEngineersSelect) return;
    const q = _normalizeText(searchEl ? searchEl.value : '');
    const selectedIds = getSelectedEngineerIds();
    const list = (_projectListEngineers || []).filter(function(e) {
        if (selectedIds.indexOf(String(e.id)) !== -1) return false;
        const label = _normalizeText((e.full_name || e.username || ''));
        return !q || label.indexOf(q) !== -1;
    });
    listEl.innerHTML = '';
    if (list.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'px-4 py-3 text-sm text-gray-500';
        empty.textContent = selectedIds.length && !q ? 'All engineers already selected.' : 'No matching engineers.';
        listEl.appendChild(empty);
    } else {
        list.forEach(function(e) {
            const label = e.full_name || e.username || ('#' + e.id);
            const sub = (e.username && e.full_name && e.username !== e.full_name) ? (' @' + e.username) : '';
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-blue-100 focus:bg-blue-100 focus:outline-none border-b border-gray-200 last:border-0 transition';
            item.textContent = label + sub;
            item.dataset.id = e.id;
            item.addEventListener('click', function() {
                const opt = Array.from(assignedEngineersSelect.options).find(function(o) { return o.value === String(e.id); });
                if (opt) {
                    opt.selected = true;
                    assignedEngineersSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
                if (searchEl) searchEl.value = '';
                buildAssignedEngineersList();
                renderAssignedEngineerChips();
            });
            listEl.appendChild(item);
        });
    }
}

function initAssignedEngineersSelectorOnce() {
    if (!assignedEngineersSelect) return;
    if (assignedEngineersSelect.dataset.enhanced === '1') return;
    assignedEngineersSelect.dataset.enhanced = '1';

    if (assignedEngineersSearch) {
        assignedEngineersSearch.addEventListener('input', buildAssignedEngineersList);
    }
    assignedEngineersSelect.addEventListener('change', function() {
        renderAssignedEngineerChips();
        buildAssignedEngineersList();
    });
    renderAssignedEngineerChips();
    buildAssignedEngineersList();
}

function showToast(message) {
    if (successToast) {
        successToast.textContent = message;
        successToast.classList.remove('hidden');
        setTimeout(() => {
            successToast.classList.add('hidden');
        }, 2000);
    }
}

async function ensureAutoPrn() {
    try {
        if (!projectForm) return;
        const mode = projectForm.getAttribute('data-mode') || 'add';
        if (mode !== 'add') return; // keep existing PRN on edit
        const prnInput = projectForm.elements ? projectForm.elements['prn'] : null;
        if (!prnInput) return;
        prnInput.readOnly = true;
        // Always generate a fresh PRN when opening "Add Project"
        prnInput.value = 'Generating...';
        const res = await fetch('/dashboard/api/prn/generate/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await res.json();
        if (data && data.success && data.prn) {
            prnInput.value = data.prn;
        } else {
            prnInput.value = '';
            console.error('Failed to generate PRN:', data);
        }
    } catch (e) {
        console.error('Failed to generate PRN:', e);
        try {
            const prnInput = projectForm && projectForm.elements ? projectForm.elements['prn'] : null;
            if (prnInput) prnInput.value = '';
        } catch (_) {}
    }
}

function showModal() {
    if (projectModal) {
        projectModal.classList.remove('opacity-0', 'pointer-events-none');
        setTimeout(() => projectModal.classList.add('opacity-100'), 10);
    }
    initSourceOfFundsUX();
    initProjectTypeUX();
    ensureAutoPrn();
    updateCoordinateDisplays();
}
function hideModal() {
    if (projectModal) {
        projectModal.classList.remove('opacity-100');
        setTimeout(() => projectModal.classList.add('opacity-0', 'pointer-events-none'), 300);
    }
    projectForm.reset();
    editProjectId = null;
    projectForm.setAttribute('data-mode', 'add');
    // Clear assigned engineers options
    assignedEngineersSelect.innerHTML = '';
    if (assignedEngineersSearch) assignedEngineersSearch.value = '';
    if (assignedEngineersChips) assignedEngineersChips.innerHTML = '';
    // Reset button text to default
    const submitBtn = projectForm.querySelector('button[type="submit"]');
    if (submitBtn) {
        const saveIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
        submitBtn.innerHTML = saveIcon + ' Save Project';
    }
    // Remove any hidden project_id input
    const projectIdInput = projectForm.querySelector('input[name="project_id"]');
    if (projectIdInput) {
        projectIdInput.remove();
    }
    // Clear location inputs
    if (latInput) latInput.value = '';
    if (lngInput) lngInput.value = '';
    updateLocationStatus();
    updateCoordinateDisplays();
}
window.closeProjectModal = hideModal;

function populateEngineers() {
    return fetch('/projeng/api/engineers/')
        .then(response => response.json())
        .then(engineers => {
            assignedEngineersSelect.innerHTML = '';
            if (engineers.error) {
                _projectListEngineers = [];
                const option = document.createElement('option');
                option.textContent = 'No engineers available or not authorized';
                assignedEngineersSelect.appendChild(option);
                assignedEngineersSelect.disabled = true;
                return;
            }
            assignedEngineersSelect.disabled = false;
            const currentUsername = (window.currentUsername || '').trim().toLowerCase();
            _projectListEngineers = (engineers || []).filter(function(e) {
                const u = (e.username || '').trim().toLowerCase();
                return u !== currentUsername;
            });
            _projectListEngineers.forEach(function(engineer) {
                const option = document.createElement('option');
                option.value = engineer.id;
                option.textContent = engineer.full_name || engineer.username;
                assignedEngineersSelect.appendChild(option);
            });
            initAssignedEngineersSelectorOnce();
            renderAssignedEngineerChips();
        })
        .catch(err => {
            console.error('Failed to fetch engineers:', err);
            throw err; // Re-throw to allow caller to handle
        });
}

if (addProjectBtn) {
    addProjectBtn.addEventListener('click', function() {
        editProjectId = null;
        projectForm.setAttribute('data-mode', 'add');
        if (imageInput) imageInput.required = true;
        // Update button text for add mode
        const submitBtn = projectForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            const saveIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
            submitBtn.innerHTML = saveIcon + ' Save Project';
        }
        populateEngineers();
        showModal();
    });
}
if (closeModal) closeModal.addEventListener('click', hideModal);
if (cancelBtn) cancelBtn.addEventListener('click', hideModal);

// --- View Details Modal ---
function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (isNaN(date)) return dateStr;
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

window.openDetailsModal = function(id) {
    const detailsModal = document.getElementById('details-modal');
    const detailsImage = document.getElementById('details-image');
    
    if (!detailsModal) {
        console.error('Details modal not found');
        return;
    }
    
    // Show modal with loading state
    detailsModal.classList.remove('hidden');
    detailsModal.style.opacity = '1';
    detailsModal.style.pointerEvents = 'auto';
    
    document.getElementById('details-title').textContent = 'Loading...';
    document.getElementById('details-name').textContent = '';
    document.getElementById('details-prn').textContent = '';
    document.getElementById('details-barangay').textContent = '‚Äî';
    const detailsZoneTypeEl = document.getElementById('details-zone-type');
    if (detailsZoneTypeEl) detailsZoneTypeEl.textContent = '‚Äî';
    document.getElementById('details-cost').textContent = '‚Äî';
    if (document.getElementById('details-spent')) document.getElementById('details-spent').textContent = '‚Äî';
    if (document.getElementById('details-remaining')) document.getElementById('details-remaining').textContent = '‚Äî';
    document.getElementById('details-funds').textContent = '‚Äî';
    document.getElementById('details-description').textContent = 'Loading project data...';
    document.getElementById('details-latitude').textContent = '‚Äî';
    document.getElementById('details-longitude').textContent = '‚Äî';
    document.getElementById('details-start-date').textContent = '‚Äî';
    document.getElementById('details-end-date').textContent = '‚Äî';
    document.getElementById('details-assigned-engineers').textContent = 'Loading...';
    if (detailsImage) {
        detailsImage.src = '';
        detailsImage.style.display = 'none';
    }
    document.getElementById('details-map').innerHTML = '<div class="text-gray-400 text-center py-8">Loading...</div>';
    document.getElementById('details-progress-section').classList.add('hidden');
    
    // Fetch project data from API
    fetch(`/dashboard/projects/${id}/api/get/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.project) {
                throw new Error(data.error || 'Failed to load project data');
            }
            
            const project = data.project;
            
            // Populate all fields
            document.getElementById('details-title').textContent = project.name || 'Project Details';
            document.getElementById('details-status').innerHTML = getStatusBadge(project.status || '');
            document.getElementById('details-name').textContent = project.name || '';
            document.getElementById('details-prn').textContent = project.prn ? `PRN#: ${project.prn}` : '';
            document.getElementById('details-barangay').textContent = project.barangay || '‚Äî';
            const detailsZoneTypeEl = document.getElementById('details-zone-type');
            if (detailsZoneTypeEl) detailsZoneTypeEl.textContent = project.zone_type || 'Not assigned';
            const fmtMoney = (val) => `‚Ç±${parseFloat(val).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('details-cost').textContent = project.project_cost ? fmtMoney(project.project_cost) : '‚Äî';
            if (document.getElementById('details-spent')) {
                document.getElementById('details-spent').textContent = project.total_spent ? fmtMoney(project.total_spent) : '‚Äî';
            }
            if (document.getElementById('details-remaining')) {
                if (project.remaining_funds !== undefined && project.remaining_funds !== null && project.remaining_funds !== '') {
                    const remainingNum = parseFloat(project.remaining_funds);
                    document.getElementById('details-remaining').textContent = isNaN(remainingNum) ? '‚Äî' : fmtMoney(remainingNum);
                    document.getElementById('details-remaining').classList.toggle('text-red-700', !isNaN(remainingNum) && remainingNum < 0);
                    document.getElementById('details-remaining').classList.toggle('text-gray-800', isNaN(remainingNum) || remainingNum >= 0);
                } else {
                    document.getElementById('details-remaining').textContent = '‚Äî';
                }
            }
            document.getElementById('details-funds').textContent = project.source_of_funds || '‚Äî';
            document.getElementById('details-description').textContent = project.description || 'No description';
            document.getElementById('details-latitude').textContent = project.latitude || '‚Äî';
            document.getElementById('details-longitude').textContent = project.longitude || '‚Äî';
            document.getElementById('details-start-date').textContent = formatDate(project.start_date) || '‚Äî';
            document.getElementById('details-end-date').textContent = formatDate(project.end_date) || '‚Äî';
            
            // Handle project image
            if (detailsImage) {
                if (project.image && project.image.trim() !== '') {
                    detailsImage.src = project.image;
                    detailsImage.style.display = 'block';
                    console.log('Setting project image:', project.image);
                } else {
                    detailsImage.src = '';
                    detailsImage.style.display = 'none';
                    console.log('No image for project:', project.id);
                }
            }
            
            // Initialize map
            setTimeout(() => {
                const detailsMapDiv = document.getElementById('details-map');
                if (window.detailsMap) {
                    window.detailsMap.remove();
                }
                const detailMapLat = parseFloat(project.latitude);
                const detailMapLng = parseFloat(project.longitude);
                
                if (!isNaN(detailMapLat) && !isNaN(detailMapLng)) {
                    // Fix for Leaflet map container reuse error
                    if (L.DomUtil.get('details-map')) {
                        L.DomUtil.get('details-map')._leaflet_id = null;
                    }
                    window.detailsMap = L.map('details-map', {
                        zoomControl: true,
                        scrollWheelZoom: false,
                        doubleClickZoom: false,
                        dragging: true,
                        touchZoom: true
                    }).setView([detailMapLat, detailMapLng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(window.detailsMap);
                    L.marker([detailMapLat, detailMapLng]).addTo(window.detailsMap);
                    setTimeout(() => { 
                        if (window.detailsMap) {
                            window.detailsMap.invalidateSize(); 
                        }
                    }, 350);
                } else {
                    if (detailsMapDiv) {
                        detailsMapDiv.innerHTML = '<div class="text-gray-400 text-center py-8">No location set</div>';
                    }
                }
            }, 100);

            // --- Handle Progress Bar ---
            const progressSection = document.getElementById('details-progress-section');
            const progressBar = document.getElementById('details-progress-bar');
            const progressText = document.getElementById('details-progress-text');

            // Check if project status is 'ongoing' or 'in_progress' and if progress data exists
            if ((project.status === 'ongoing' || project.status === 'in_progress') && project.progress !== undefined && project.progress !== null) {
                const progressValue = parseInt(project.progress, 10);
                if (!isNaN(progressValue) && progressValue >= 0 && progressValue <= 100) {
                    progressSection.classList.remove('hidden');
                    progressBar.style.width = progressValue + '%';
                    progressText.textContent = progressValue + '% Complete';
                } else {
                    // Hide if progress data is invalid
                    progressSection.classList.add('hidden');
                }
            } else {
                // Hide if status is not ongoing or progress data is missing
                progressSection.classList.add('hidden');
            }
            // --- End Progress Bar Handling ---

            // --- Display Assigned Engineers ---
            const assignedEngineersElement = document.getElementById('details-assigned-engineers');
            if (assignedEngineersElement) {
                if (project.assigned_engineers && project.assigned_engineers.length > 0) {
                    assignedEngineersElement.textContent = project.assigned_engineers.join(', ');
                } else {
                    assignedEngineersElement.textContent = 'None assigned';
                }
            }
            // --- End Assigned Engineers Display ---
        })
        .catch(error => {
            console.error('Error fetching project data:', error);
            document.getElementById('details-title').textContent = 'Error';
            document.getElementById('details-description').textContent = 'Failed to load project data: ' + (error.message || 'Unknown error');
            document.getElementById('details-map').innerHTML = '<div class="text-red-400 text-center py-8">Error loading project data</div>';
        });
};
window.closeDetailsModalFunc = function() {
    const detailsModal = document.getElementById('details-modal');
    if (detailsModal) {
        detailsModal.style.opacity = '0';
        detailsModal.style.pointerEvents = 'none';
        setTimeout(() => {
            detailsModal.classList.add('hidden');
        }, 300); // Wait for transition to complete
    }
};
if (closeDetailsModal) closeDetailsModal.addEventListener('click', window.closeDetailsModalFunc);

// --- Delete Modal ---
window.openDeleteModal = function(id) {
    const deleteModal = document.getElementById('delete-modal');
    if (deleteModal) {
        deleteModal.classList.remove('hidden');
        deleteProjectId = id;
    }
};
window.closeDeleteModalFunc = function() {
    const deleteModal = document.getElementById('delete-modal');
    if (deleteModal) {
        deleteModal.classList.add('hidden');
        deleteProjectId = null;
    }
};
if (closeDeleteModal) closeDeleteModal.addEventListener('click', window.closeDeleteModalFunc);
if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', window.closeDeleteModalFunc);
if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', function() {
        if (deleteProjectId) {
            // Get CSRF token from cookie
            const csrftoken = document.cookie.split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];

            fetch(`/dashboard/projects/${deleteProjectId}/api/delete/`, { 
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
                .then(res => {
                    // Check if response is JSON
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return res.json();
                    } else {
                        // If not JSON, it might be an error page
                        return res.text().then(text => {
                            throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
                        });
                    }
                })
                .then(data => {
                    if (data.success) {
                        // Remove the row from the table
                        const row = document.querySelector(`tr[data-project-id='${deleteProjectId}']`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => {
                                row.remove();
                                renumberProjectRows();
                            }, 300);
                        }
                        showToast('Project deleted successfully!');
                    } else {
                        alert(data.error || 'Delete failed.');
                    }
                    window.closeDeleteModalFunc();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the project: ' + (error.message || 'Unknown error'));
                    window.closeDeleteModalFunc();
                });
        }
    });
}

// --- Enhanced Popup Map Modal Logic ---
let popupMap = null;
let popupMarker = null;
let barangayBoundaryLayer = null;
const mapPopupModal = document.getElementById('map-popup-modal');
const popupMapDiv = document.getElementById('popup-map');
const closeMapPopup = document.getElementById('close-map-popup');
const closeMapPopupBtn = document.getElementById('close-map-popup-btn');
const mapFullscreenBtn = document.getElementById('map-fullscreen-btn');
const latInput = document.getElementById('latitude-input');
const lngInput = document.getElementById('longitude-input');
const locationStatus = document.getElementById('location-status');
const mapBtnText = document.getElementById('map-btn-text');
const selectedLatDisplay = document.getElementById('selected-lat-display');
const selectedLngDisplay = document.getElementById('selected-lng-display');
const confirmLocationBtn = document.getElementById('confirm-location-btn');
const useCurrentLocationBtn = document.getElementById('use-current-location-btn');

// Update location status indicator
function updateLocationStatus() {
    const hasLocation = latInput && lngInput && latInput.value && lngInput.value;
    if (locationStatus) {
        if (hasLocation) {
            locationStatus.classList.remove('hidden');
            if (mapBtnText) mapBtnText.textContent = 'Change Location';
            if (latInput) {
                latInput.classList.remove('border-red-300');
                latInput.classList.add('border-green-400');
            }
            if (lngInput) {
                lngInput.classList.remove('border-red-300');
                lngInput.classList.add('border-green-400');
            }
        } else {
            locationStatus.classList.add('hidden');
            if (mapBtnText) mapBtnText.textContent = 'Select Location on Map';
            if (latInput) {
                latInput.classList.remove('border-green-400');
                latInput.classList.add('border-red-300');
            }
            if (lngInput) {
                lngInput.classList.remove('border-green-400');
                lngInput.classList.add('border-red-300');
            }
        }
    }
}

// Update coordinate displays (popup map + modal form)
function updateCoordinateDisplays() {
    if (selectedLatDisplay && selectedLngDisplay && latInput && lngInput) {
        if (latInput.value && lngInput.value) {
            selectedLatDisplay.textContent = parseFloat(latInput.value).toFixed(6);
            selectedLngDisplay.textContent = parseFloat(lngInput.value).toFixed(6);
        } else {
            selectedLatDisplay.textContent = '--';
            selectedLngDisplay.textContent = '--';
        }
    }
    // Update visible lat/lng in Add Project modal
    const latDisplay = document.getElementById('latitude-display');
    const lngDisplay = document.getElementById('longitude-display');
    const hint = 'Set automatically when you pick a point on the map.';
    if (latDisplay && latInput) {
        latDisplay.textContent = latInput.value ? parseFloat(latInput.value).toFixed(6) : hint;
    }
    if (lngDisplay && lngInput) {
        lngDisplay.textContent = lngInput.value ? parseFloat(lngInput.value).toFixed(6) : hint;
    }
}

// --- Purok dropdown (simple, defense-friendly) ---
// Default to Purok 1..20 for any barangay (can be refined later per barangay).
window.populatePurokOptions = function(selectEl, currentValue = '') {
    if (!selectEl) return;
    const normalizedCurrent = (currentValue || '').trim();
    const options = [''].concat(Array.from({ length: 20 }, (_, i) => `Purok ${i + 1}`)).concat(['Other']);
    selectEl.innerHTML = '';
    options.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val ? val : 'Select Purok (optional)';
        selectEl.appendChild(opt);
    });
    if (normalizedCurrent && !options.includes(normalizedCurrent)) {
        const opt = document.createElement('option');
        opt.value = normalizedCurrent;
        opt.textContent = normalizedCurrent;
        selectEl.appendChild(opt);
    }
    selectEl.value = normalizedCurrent || '';
};

// --- Barangay boundary validation helpers ---
let _barangayGeo = null; // raw GeoJSON FeatureCollection
let _barangayGeomByName = null; // normalized name -> geometry

function _normalizeBarangayName(name) {
    return (name || '').toLowerCase().trim();
}

async function _ensureBarangayGeoLoaded() {
    if (_barangayGeomByName) return;
    try {
        const res = await fetch("{% url 'barangay_geojson' %}");
        if (!res.ok) throw new Error(`GeoJSON fetch failed: ${res.status}`);
        _barangayGeo = await res.json();
        _barangayGeomByName = new Map();
        if (_barangayGeo && Array.isArray(_barangayGeo.features)) {
            _barangayGeo.features.forEach(f => {
                const n = _normalizeBarangayName(f?.properties?.name);
                if (n && f.geometry) _barangayGeomByName.set(n, f.geometry);
            });
        }
    } catch (e) {
        console.warn('Could not load barangay GeoJSON for boundary validation:', e);
        _barangayGeomByName = new Map(); // avoid retry loop
    }
}

function _pointInRing(lat, lng, ringLngLat) {
    // ringLngLat: [[lng,lat], ...]
    let inside = false;
    for (let i = 0, j = ringLngLat.length - 1; i < ringLngLat.length; j = i++) {
        const xi = ringLngLat[i][0], yi = ringLngLat[i][1];
        const xj = ringLngLat[j][0], yj = ringLngLat[j][1];
        const intersect = ((yi > lat) !== (yj > lat)) &&
            (lng < (xj - xi) * (lat - yi) / ((yj - yi) || 1e-12) + xi);
        if (intersect) inside = !inside;
    }
    return inside;
}

function _pointInPolygonGeometry(lat, lng, geom) {
    if (!geom) return true;
    if (geom.type === 'Polygon') {
        const rings = geom.coordinates || [];
        if (!rings.length) return true;
        // Basic check: must be inside outer ring; ignore holes for simplicity
        return _pointInRing(lat, lng, rings[0]);
    }
    if (geom.type === 'MultiPolygon') {
        const polys = geom.coordinates || [];
        return polys.some(poly => poly && poly[0] && _pointInRing(lat, lng, poly[0]));
    }
    return true;
}

async function _isInsideSelectedBarangay(lat, lng) {
    await _ensureBarangayGeoLoaded();
    const barangay = modalBarangaySelect ? modalBarangaySelect.value : '';
    if (!barangay) return false; // must choose barangay first
    const geom = _barangayGeomByName.get(_normalizeBarangayName(barangay));
    if (!geom) return true; // if unknown, don't block
    return _pointInPolygonGeometry(lat, lng, geom);
}

function _clearBarangayBoundary() {
    try {
        if (popupMap && barangayBoundaryLayer) {
            popupMap.removeLayer(barangayBoundaryLayer);
        }
    } catch (_) {}
    barangayBoundaryLayer = null;
}

async function _drawSelectedBarangayBoundary() {
    try {
        if (!popupMap) return;
        await _ensureBarangayGeoLoaded();
        _clearBarangayBoundary();

        const selectedBarangay = modalBarangaySelect ? modalBarangaySelect.value : '';
        if (!selectedBarangay || !_barangayGeo || !Array.isArray(_barangayGeo.features)) return;

        const target = _normalizeBarangayName(selectedBarangay);
        const feature = _barangayGeo.features.find(f => _normalizeBarangayName(f?.properties?.name) === target);
        if (!feature) return;

        if (!popupMap.getPane('barangayBoundaryPane')) {
            const pane = popupMap.createPane('barangayBoundaryPane');
            pane.style.zIndex = '450'; // above tiles, below markers
        }

        barangayBoundaryLayer = L.geoJSON(feature, {
            pane: 'barangayBoundaryPane',
            interactive: false,
            style: {
                color: '#2563eb',
                weight: 3,
                opacity: 0.95,
                fillColor: '#60a5fa',
                fillOpacity: 0.08,
                dashArray: '6 6',
            },
        }).addTo(popupMap);

        // If no pinned point yet, zoom to barangay bounds for easier pinning
        const hasPoint = (latInput && latInput.value && lngInput && lngInput.value);
        if (!hasPoint) {
            try {
                const b = barangayBoundaryLayer.getBounds();
                if (b && b.isValid && b.isValid()) {
                    popupMap.fitBounds(b, { padding: [16, 16] });
                }
            } catch (_) {}
        }
    } catch (e) {
        console.warn('Failed to draw barangay boundary:', e);
    }
}

function showPopupMap() {
    if (mapPopupModal) {
        mapPopupModal.classList.remove('hidden');
        setTimeout(() => {
            let lat = parseFloat(latInput.value) || 7.4475; // Default to a central location if inputs are empty
            let lng = parseFloat(lngInput.value) || 125.8078;
            let zoom = 13; // Default zoom

            // Use barangay coordinates if a barangay is selected in the add/edit modal
            const selectedBarangay = modalBarangaySelect.value; // modalBarangaySelect is defined earlier
            if (selectedBarangay && barangayCoordinates[selectedBarangay]) {
                 [lat, lng] = barangayCoordinates[selectedBarangay];
                 zoom = 14; // Adjust zoom level when centering on a barangay
            } else if (latInput.value && lngInput.value) {
                 // If latitude/longitude inputs already have values, use them
                 lat = parseFloat(latInput.value);
                 lng = parseFloat(lngInput.value);
                 zoom = 14; // Zoom in if coordinates are pre-filled
            }

            if (!popupMap) {
                // Initialize the map only if it doesn't exist
                // Fix for Leaflet map container reuse error
                if (L.DomUtil.get('popup-map')) {
                    L.DomUtil.get('popup-map')._leaflet_id = null;
                }
                popupMap = L.map('popup-map').setView([lat, lng], zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(popupMap);
                _drawSelectedBarangayBoundary();
                
                // Add click listener to update coordinates
                let lastValidLatLng = null;

                popupMap.on('click', async function(e) {
                    const clickedLat = e.latlng.lat;
                    const clickedLng = e.latlng.lng;

                    const ok = await _isInsideSelectedBarangay(clickedLat, clickedLng);
                    if (!ok) {
                        alert('Selected point is outside the chosen barangay boundary. Please pin inside the selected barangay.');
                        return;
                    }
                    
                    // Update inputs with 6 decimal precision
                    if (latInput) latInput.value = clickedLat.toFixed(6);
                    if (lngInput) lngInput.value = clickedLng.toFixed(6);
                    
                    // Update displays
                    updateCoordinateDisplays();
                    
                    // Update marker
                    if (popupMarker) {
                        popupMarker.setLatLng([clickedLat, clickedLng]);
                    } else {
                        popupMarker = L.marker([clickedLat, clickedLng], {
                            draggable: true
                        }).addTo(popupMap);
                        
                        // Allow dragging marker
                        popupMarker.on('dragend', async function(e) {
                            const pos = popupMarker.getLatLng();
                            const okDrag = await _isInsideSelectedBarangay(pos.lat, pos.lng);
                            if (!okDrag) {
                                alert('Marker is outside the chosen barangay boundary. It will be returned to the last valid position.');
                                if (lastValidLatLng) popupMarker.setLatLng(lastValidLatLng);
                                return;
                            }
                            lastValidLatLng = { lat: pos.lat, lng: pos.lng };
                            if (latInput) latInput.value = pos.lat.toFixed(6);
                            if (lngInput) lngInput.value = pos.lng.toFixed(6);
                            updateCoordinateDisplays();
                        });
                    }

                    lastValidLatLng = { lat: clickedLat, lng: clickedLng };
                    
                    // Show popup with coordinates
                    popupMarker.bindPopup(`
                        <div class="text-center">
                            <strong>Selected Location</strong><br>
                            ${clickedLat.toFixed(6)}¬∞N, ${clickedLng.toFixed(6)}¬∞E
                        </div>
                    `).openPopup();
                });
            } else {
                // If map already exists, just set the view
                popupMap.setView([lat, lng], zoom);
                _drawSelectedBarangayBoundary();
            }

            // Remove existing marker before adding a new one
             if (popupMarker) {
                 popupMap.removeLayer(popupMarker);
                 popupMarker = null;
             }

            // Create and add marker AFTER setting the view if coordinates exist
            if (latInput && lngInput && latInput.value && lngInput.value) {
                const markerLat = parseFloat(latInput.value);
                const markerLng = parseFloat(lngInput.value);
                popupMarker = L.marker([markerLat, markerLng], {
                    draggable: true
                }).addTo(popupMap);
                
                popupMarker.bindPopup(`
                    <div class="text-center">
                        <strong>Current Location</strong><br>
                        ${markerLat.toFixed(6)}¬∞N, ${markerLng.toFixed(6)}¬∞E
                    </div>
                `).openPopup();
                
                let lastValidLatLng = { lat: markerLat, lng: markerLng };
                // Allow dragging
                popupMarker.on('dragend', function(e) {
                    const pos = popupMarker.getLatLng();
                    _isInsideSelectedBarangay(pos.lat, pos.lng).then(ok => {
                        if (!ok) {
                            alert('Marker is outside the chosen barangay boundary. It will be returned to the last valid position.');
                            if (lastValidLatLng) popupMarker.setLatLng(lastValidLatLng);
                            return;
                        }
                        lastValidLatLng = { lat: pos.lat, lng: pos.lng };
                        if (latInput) latInput.value = pos.lat.toFixed(6);
                        if (lngInput) lngInput.value = pos.lng.toFixed(6);
                        updateCoordinateDisplays();
                    });
                });
            }
            
            updateCoordinateDisplays();
            setTimeout(() => { popupMap.invalidateSize(); }, 350);

            // Keep boundary updated when barangay changes (bind once)
            if (modalBarangaySelect && modalBarangaySelect.dataset.boundaryWatch !== '1') {
                modalBarangaySelect.dataset.boundaryWatch = '1';
                modalBarangaySelect.addEventListener('change', () => {
                    if (!popupMap) return;
                    _drawSelectedBarangayBoundary();
                });
            }
        }, 100);
    }
}

// Purok removed: no purok dropdown to populate

function hidePopupMap() {
    if (mapPopupModal) {
        mapPopupModal.classList.add('hidden');
        updateLocationStatus();
    }
}

// Use current location (browser geolocation)
if (useCurrentLocationBtn) {
    useCurrentLocationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
        }
        
        useCurrentLocationBtn.disabled = true;
        const originalHTML = useCurrentLocationBtn.innerHTML;
        useCurrentLocationBtn.innerHTML = '<span>Getting location...</span>';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Check if within Tagum City bounds (approximate)
                if (lat >= 7.0 && lat <= 8.0 && lng >= 125.0 && lng <= 126.0) {
                    if (latInput) latInput.value = lat.toFixed(6);
                    if (lngInput) lngInput.value = lng.toFixed(6);
                    
                    if (popupMap) {
                        popupMap.setView([lat, lng], 16);
                        
                        if (popupMarker) {
                            popupMarker.setLatLng([lat, lng]);
                        } else {
                            popupMarker = L.marker([lat, lng], {
                                draggable: true
                            }).addTo(popupMap);
                            
                            popupMarker.on('dragend', function(e) {
                                const pos = popupMarker.getLatLng();
                                if (latInput) latInput.value = pos.lat.toFixed(6);
                                if (lngInput) lngInput.value = pos.lng.toFixed(6);
                                updateCoordinateDisplays();
                            });
                        }
                        
                        popupMarker.bindPopup(`
                            <div class="text-center">
                                <strong>Your Location</strong><br>
                                ${lat.toFixed(6)}¬∞N, ${lng.toFixed(6)}¬∞E
                            </div>
                        `).openPopup();
                    }
                    
                    updateCoordinateDisplays();
                } else {
                    alert('Your location is outside Tagum City. Please select a location on the map.');
                }
                
                useCurrentLocationBtn.disabled = false;
                useCurrentLocationBtn.innerHTML = originalHTML;
            },
            function(error) {
                alert('Unable to get your location: ' + error.message);
                useCurrentLocationBtn.disabled = false;
                useCurrentLocationBtn.innerHTML = originalHTML;
            }
        );
    });
}

// Confirm location button
if (confirmLocationBtn) {
    confirmLocationBtn.addEventListener('click', function() {
        if (latInput && lngInput && latInput.value && lngInput.value) {
            hidePopupMap();
        } else {
            alert('Please select a location on the map first.');
        }
    });
}

if (mapFullscreenBtn) {
    mapFullscreenBtn.addEventListener('click', showPopupMap);
}
if (closeMapPopup) closeMapPopup.addEventListener('click', hidePopupMap);
if (closeMapPopupBtn) closeMapPopupBtn.addEventListener('click', hidePopupMap);

// Update location status on page load
if (latInput && lngInput) {
    updateLocationStatus();
    
    // Update location status when inputs change
    latInput.addEventListener('input', function() {
        updateLocationStatus();
        updateCoordinateDisplays();
    });
    lngInput.addEventListener('input', function() {
        updateLocationStatus();
        updateCoordinateDisplays();
    });
}

// Validate location before form submission and handle edit mode
if (projectForm) {
    projectForm.addEventListener('submit', function(e) {
        if (!latInput || !lngInput || !latInput.value || !lngInput.value) {
            e.preventDefault();
            alert('‚ö†Ô∏è Please select a location on the map before saving the project.');
            if (mapFullscreenBtn) {
                showPopupMap();
            }
            return false;
        }
        
        // Add project ID if in edit mode
        if (editProjectId) {
            // Create a hidden input for the project ID if it doesn't exist
            let projectIdInput = projectForm.querySelector('input[name="project_id"]');
            if (!projectIdInput) {
                projectIdInput = document.createElement('input');
                projectIdInput.type = 'hidden';
                projectIdInput.name = 'project_id';
                projectForm.appendChild(projectIdInput);
            }
            projectIdInput.value = editProjectId;
        }
    });
}

// Close modal when clicking outside the modal content (Popup Map Modal)
if (mapPopupModal) {
    mapPopupModal.addEventListener('mousedown', function(e) {
        if (e.target === mapPopupModal) {
            hidePopupMap();
        }
    });
}

// --- Utility Functions ---
function getStatusBadge(status) {
    if (status === 'completed') {
        return '<span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>';
    } else if (status === 'in_progress' || status === 'ongoing') {
        return '<span class="inline-block px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700 font-semibold">Ongoing</span>';
    } else if (status === 'planned' || status === 'pending') {
        return '<span class="inline-block px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 font-semibold">Planned</span>';
    } else if (status === 'delayed') {
        return '<span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 font-semibold">Delayed</span>';
    } else {
        return status;
    }
}
function renumberProjectRows() {
    const rows = document.querySelectorAll('#project-table-body tr');
    rows.forEach((row, idx) => {
        const numberCell = row.querySelector('td:first-child');
        if (numberCell) {
            numberCell.textContent = idx + 1;
        }
    });
}

window.openEditModal = function(id) {
    // Fetch project data from API instead of relying on window.projects
    editProjectId = id;
    projectForm.setAttribute('data-mode', 'edit');
    if (imageInput) imageInput.required = false;
    
    // Show loading state
    const submitBtn = projectForm.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>Loading...</span>';
    }
    
    // Fetch project data from API
    fetch(`/dashboard/projects/${id}/api/get/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success || !data.project) {
                throw new Error(data.error || 'Failed to load project data');
            }
            
            const project = data.project;
            
            // Populate form fields
            projectForm.elements['prn'].value = project.prn || '';
            projectForm.elements['name'].value = project.name || '';
            projectForm.elements['description'].value = project.description || '';
            projectForm.elements['barangay'].value = project.barangay || '';
            // Purok removed
            projectForm.elements['project_cost'].value = project.project_cost || '';
            // Source of Funds (select): if value isn't in options, add it dynamically
            const fundsSelect = projectForm.elements['source_of_funds'];
            const fundsValue = project.source_of_funds || '';
            if (fundsSelect && fundsSelect.tagName === 'SELECT') {
                if (fundsValue) {
                    const hasOption = Array.from(fundsSelect.options).some(o => o.value === fundsValue);
                    if (!hasOption) {
                        const opt = document.createElement('option');
                        opt.value = fundsValue;
                        opt.textContent = fundsValue;
                        fundsSelect.appendChild(opt);
                    }
                    fundsSelect.value = fundsValue;
                } else {
                    fundsSelect.value = '';
                }
            }
            // Clear add-new input in edit mode
            if (projectForm.elements['source_of_funds_new']) {
                projectForm.elements['source_of_funds_new'].value = '';
            }
            projectForm.elements['status'].value = project.status || '';
            projectForm.elements['latitude'].value = project.latitude || '';
            projectForm.elements['longitude'].value = project.longitude || '';
            projectForm.elements['start_date'].value = project.start_date || '';
            projectForm.elements['end_date'].value = project.end_date || '';
            
            // Update location status
            updateLocationStatus();
            updateCoordinateDisplays();
            
            // Populate assigned engineers
            populateEngineers().then(() => {
                // After engineers are loaded, select the assigned ones
                const assignedEngineersField = projectForm.elements['assigned_engineers'];
                if (assignedEngineersField && project.assigned_engineer_ids && project.assigned_engineer_ids.length > 0) {
                    // Select assigned engineers by ID
                    for (let i = 0; i < assignedEngineersField.options.length; i++) {
                        const option = assignedEngineersField.options[i];
                        if (project.assigned_engineer_ids.includes(parseInt(option.value))) {
                            option.selected = true;
                        }
                    }
                }
                // Refresh enhanced selector UI after selection is applied
                if (typeof renderAssignedEngineerChips === 'function') {
                    renderAssignedEngineerChips();
                }
                if (typeof buildAssignedEngineersList === 'function') {
                    buildAssignedEngineersList();
                }
                
                // Restore button state and update text for edit mode
                if (submitBtn) {
                    submitBtn.disabled = false;
                    // Update button text for edit mode
                    const saveIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                    submitBtn.innerHTML = saveIcon + ' Update Project';
                }
                
                // Show the modal
                showModal();
            }).catch(err => {
                console.error('Error populating engineers:', err);
                // Still show modal even if engineers fail to load
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
                showModal();
            });
        })
        .catch(error => {
            console.error('Error fetching project data:', error);
            alert('Failed to load project data: ' + (error.message || 'Unknown error'));
            // Restore button state
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
};
</script>
{% endblock %}