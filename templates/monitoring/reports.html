{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="mx-auto px-4 py-6 lg:px-8 w-full max-w-[1600px]">
        {# Page header #}
        <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Project Reports</h1>
                <p class="text-gray-600 mt-1">View and export project data by barangay, status, and date range.</p>
            </div>
            <button type="button" id="export-button-header" class="flex-shrink-0 inline-flex items-center gap-2 px-5 py-2.5 text-base font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition border-2 border-green-700 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                Export
            </button>
        </div>

        {# Summary cards (updated by JS when filters change) #}
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Projects</p>
                <p id="summary-count" class="text-2xl font-bold text-gray-900 mt-1">{{ projects_count|default:0 }}</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Budget</p>
                <p id="summary-budget" class="text-2xl font-bold text-gray-900 mt-1">₱{{ total_budget|floatformat:0|intcomma|default:"0" }}</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Spent</p>
                <p id="summary-spent" class="text-2xl font-bold text-gray-900 mt-1">₱{{ total_spent|floatformat:0|intcomma|default:"0" }}</p>
            </div>
        </div>

        {# Filters card — same style as Project List / All Project Analytics #}
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6">
            <form method="get" id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                <div>
                    <label for="barangay-filter" class="block text-sm font-semibold text-gray-700 mb-2">Barangay</label>
                    <select id="barangay-filter" name="barangay" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300 cursor-pointer">
                        <option value="" {% if not selected_barangay %}selected{% endif %}>All Barangays</option>
                        <option value="Apokon" {% if selected_barangay == 'Apokon' %}selected{% endif %}>Apokon</option>
                        <option value="Bincungan" {% if selected_barangay == 'Bincungan' %}selected{% endif %}>Bincungan</option>
                        <option value="Busaon" {% if selected_barangay == 'Busaon' %}selected{% endif %}>Busaon</option>
                        <option value="Canocotan" {% if selected_barangay == 'Canocotan' %}selected{% endif %}>Canocotan</option>
                        <option value="Cuambogan" {% if selected_barangay == 'Cuambogan' %}selected{% endif %}>Cuambogan</option>
                        <option value="La Filipina" {% if selected_barangay == 'La Filipina' %}selected{% endif %}>La Filipina</option>
                        <option value="Liboganon" {% if selected_barangay == 'Liboganon' %}selected{% endif %}>Liboganon</option>
                        <option value="Madaum" {% if selected_barangay == 'Madaum' %}selected{% endif %}>Madaum</option>
                        <option value="Magdum" {% if selected_barangay == 'Magdum' %}selected{% endif %}>Magdum</option>
                        <option value="Magugpo East" {% if selected_barangay == 'Magugpo East' %}selected{% endif %}>Magugpo East</option>
                        <option value="Magugpo North" {% if selected_barangay == 'Magugpo North' %}selected{% endif %}>Magugpo North</option>
                        <option value="Magugpo Poblacion" {% if selected_barangay == 'Magugpo Poblacion' %}selected{% endif %}>Magugpo Poblacion</option>
                        <option value="Magugpo South" {% if selected_barangay == 'Magugpo South' %}selected{% endif %}>Magugpo South</option>
                        <option value="Magugpo West" {% if selected_barangay == 'Magugpo West' %}selected{% endif %}>Magugpo West</option>
                        <option value="Mankilam" {% if selected_barangay == 'Mankilam' %}selected{% endif %}>Mankilam</option>
                        <option value="New Balamban" {% if selected_barangay == 'New Balamban' %}selected{% endif %}>New Balamban</option>
                        <option value="Nueva Fuerza" {% if selected_barangay == 'Nueva Fuerza' %}selected{% endif %}>Nueva Fuerza</option>
                        <option value="Pagsabangan" {% if selected_barangay == 'Pagsabangan' %}selected{% endif %}>Pagsabangan</option>
                        <option value="Pandapan" {% if selected_barangay == 'Pandapan' %}selected{% endif %}>Pandapan</option>
                        <option value="San Agustin" {% if selected_barangay == 'San Agustin' %}selected{% endif %}>San Agustin</option>
                        <option value="San Isidro" {% if selected_barangay == 'San Isidro' %}selected{% endif %}>San Isidro</option>
                        <option value="San Miguel" {% if selected_barangay == 'San Miguel' %}selected{% endif %}>San Miguel</option>
                        <option value="Visayan Village" {% if selected_barangay == 'Visayan Village' %}selected{% endif %}>Visayan Village</option>
                    </select>
                </div>
                <div>
                    <label for="status-filter" class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                    <select id="status-filter" name="status" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300 cursor-pointer">
                        <option value="" {% if not selected_status %}selected{% endif %}>All Statuses</option>
                        <option value="planned" {% if selected_status == 'planned' %}selected{% endif %}>Planned</option>
                        <option value="in_progress" {% if selected_status == 'in_progress' or selected_status == 'ongoing' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="delayed" {% if selected_status == 'delayed' %}selected{% endif %}>Delayed</option>
                    </select>
                </div>
                <div>
                    <label for="start-date-filter" class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="start-date-filter" name="start_date" value="{{ selected_start_date|default:'' }}" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300">
                </div>
                <div>
                    <label for="end-date-filter" class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                    <input type="date" id="end-date-filter" name="end_date" value="{{ selected_end_date|default:'' }}" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300">
                </div>
                <div class="flex flex-wrap items-end gap-2 sm:col-span-2 lg:col-span-2">
                    <button type="button" id="clear-filters-btn" class="px-4 py-2.5 text-base font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition border-2 border-gray-200">Clear Filters</button>
                    <button type="button" id="export-button" class="px-4 py-2.5 text-base font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition flex items-center gap-2 border-2 border-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        Export
                    </button>
                </div>
            </form>
            <p id="result-count" class="text-sm text-gray-500 mt-4">Showing <strong id="result-count-num">0</strong> projects</p>
        </div>

        {# Table card #}
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            {# Table — full width of container, no horizontal scroll; all content visible #}
            <div class="w-full">
                <table id="projects-table" class="w-full divide-y divide-gray-200 table-fixed">
                    <colgroup>
                        <col style="width:3%">
                        <col style="width:10%">
                        <col style="width:12%">
                        <col style="width:18%">
                        <col style="width:10%">
                        <col style="width:11%">
                        <col style="width:14%">
                        <col style="width:6%">
                        <col style="width:6%">
                        <col style="width:10%">
                    </colgroup>
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">#</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">PRN#</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Project</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Cost</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Source of Funds</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Started</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ended</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100" id="projects-table-body">
                        {# Rows populated by JS #}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Export modal #}
<div id="exportModal" class="fixed inset-0 bg-black/50 z-50 hidden overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-900">Export Project List</h3>
                <button type="button" id="closeModal" class="p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition">&times;</button>
            </div>
            <div class="p-4 flex flex-wrap items-center gap-3 border-b border-gray-100">
                <label for="modal-barangay-filter" class="text-sm font-medium text-gray-700">Barangay:</label>
                <select id="modal-barangay-filter" name="modal_barangay" class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                    <option value="">All Barangays</option>
                    <option value="Apokon">Apokon</option>
                    <option value="Bincungan">Bincungan</option>
                    <option value="Busaon">Busaon</option>
                    <option value="Canocotan">Canocotan</option>
                    <option value="Cuambogan">Cuambogan</option>
                    <option value="La Filipina">La Filipina</option>
                    <option value="Liboganon">Liboganon</option>
                    <option value="Madaum">Madaum</option>
                    <option value="Magdum">Magdum</option>
                    <option value="Magugpo East">Magugpo East</option>
                    <option value="Magugpo North">Magugpo North</option>
                    <option value="Magugpo Poblacion">Magugpo Poblacion</option>
                    <option value="Magugpo South">Magugpo South</option>
                    <option value="Magugpo West">Magugpo West</option>
                    <option value="Mankilam">Mankilam</option>
                    <option value="New Balamban">New Balamban</option>
                    <option value="Nueva Fuerza">Nueva Fuerza</option>
                    <option value="Pagsabangan">Pagsabangan</option>
                    <option value="Pandapan">Pandapan</option>
                    <option value="San Agustin">San Agustin</option>
                    <option value="San Isidro">San Isidro</option>
                    <option value="San Miguel">San Miguel</option>
                    <option value="Visayan Village">Visayan Village</option>
                </select>
                <span class="text-sm text-gray-500">Export as:</span>
                <div class="flex gap-2">
                    <a href="{% url 'export_reports_csv' %}" id="export-csv" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">CSV</a>
                    <a href="{% url 'export_reports_excel' %}" id="export-excel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">Excel</a>
                    <a href="{% url 'export_reports_pdf' %}" id="export-pdf" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">PDF</a>
                </div>
            </div>
            <div class="overflow-auto flex-1 p-4">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">#</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">PRN#</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Project</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Description</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Location</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Cost</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Source</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Started</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Ended</th>
                            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="modal-projects-table-body" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{{ projects_json|json_script:"projects-data" }}
<div id="reports-meta" data-total-spent="{{ total_spent|default:0 }}" class="hidden"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/pdfmake.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.7/build/vfs_fonts.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectsDataElement = document.getElementById('projects-data');
    let projects = [];
    let filteredProjects = [];

    if (projectsDataElement && projectsDataElement.textContent.trim()) {
        try {
            const parsed = JSON.parse(projectsDataElement.textContent.trim());
            projects = Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error('Error parsing projects data:', e);
        }
    }
    filteredProjects = [...projects];

    const barangayFilter = document.getElementById('barangay-filter');
    const statusFilter = document.getElementById('status-filter');
    const startDateFilter = document.getElementById('start-date-filter');
    const endDateFilter = document.getElementById('end-date-filter');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const projectsTableBody = document.getElementById('projects-table-body');
    const resultCountNum = document.getElementById('result-count-num');
    const summaryCount = document.getElementById('summary-count');
    const summaryBudget = document.getElementById('summary-budget');

    function normalizeStatus(s) {
        if (!s) return '';
        s = String(s).toLowerCase();
        if (s === 'in_progress' || s === 'ongoing') return 'in_progress';
        if (s === 'planned' || s === 'pending') return 'planned';
        if (s === 'completed') return 'completed';
        if (s === 'delayed') return 'delayed';
        return s;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '—';
        const d = new Date(dateStr);
        return isNaN(d) ? dateStr : d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatCost(cost) {
        if (cost == null || cost === '') return '—';
        const num = Number(String(cost).replace(/[^\d.]/g, ''));
        return isNaN(num) ? cost : '₱' + num.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
    }

    function getStatusBadge(status) {
        const n = normalizeStatus(status);
        const map = {
            completed: 'bg-green-100 text-green-800',
            in_progress: 'bg-blue-100 text-blue-800',
            planned: 'bg-amber-100 text-amber-800',
            delayed: 'bg-red-100 text-red-800'
        };
        const label = n === 'in_progress' ? 'Ongoing' : (n.charAt(0).toUpperCase() + n.slice(1));
        const cls = map[n] || 'bg-gray-100 text-gray-800';
        return '<span class="px-2 py-0.5 text-xs font-semibold rounded-full ' + cls + '">' + label + '</span>';
    }

    function escapeHtml(str) {
        if (str == null) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function filterAndRender() {
        const barangay = (barangayFilter && barangayFilter.value) || '';
        const status = (statusFilter && statusFilter.value) || '';
        const startDate = (startDateFilter && startDateFilter.value) || '';
        const endDate = (endDateFilter && endDateFilter.value) || '';

        filteredProjects = projects.filter(p => {
            const matchBarangay = !barangay || (p.barangay && p.barangay.trim().toLowerCase() === barangay.trim().toLowerCase());
            let matchStatus = true;
            if (status) {
                const nFilter = normalizeStatus(status);
                const nProject = normalizeStatus(p.status);
                matchStatus = nFilter === 'in_progress' ? (nProject === 'in_progress') : (nProject === nFilter);
            }
            let matchDate = true;
            if (startDate && p.start_date) matchDate = matchDate && (new Date(p.start_date) >= new Date(startDate));
            if (endDate && p.end_date) matchDate = matchDate && (new Date(p.end_date) <= new Date(endDate));
            return matchBarangay && matchStatus && matchDate;
        });

        let totalBudget = 0;
        filteredProjects.forEach(p => {
            if (p.project_cost != null && p.project_cost !== '') {
                const num = Number(String(p.project_cost).replace(/[^\d.]/g, ''));
                if (!isNaN(num)) totalBudget += num;
            }
        });

        if (resultCountNum) resultCountNum.textContent = filteredProjects.length;
        if (summaryCount) summaryCount.textContent = filteredProjects.length.toLocaleString();
        if (summaryBudget) summaryBudget.textContent = '₱' + totalBudget.toLocaleString('en-US', { minimumFractionDigits:0, maximumFractionDigits:0 });
        // Total Spent stays as server value (not per-project in JSON)

        projectsTableBody.innerHTML = '';
        if (filteredProjects.length === 0) {
            projectsTableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-8 text-center text-gray-500">No projects match the selected filters.</td></tr>';
            return;
        }
        filteredProjects.forEach((project, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition';
            row.innerHTML =
                '<td class="px-4 py-3 text-sm text-gray-900 align-top">' + (index + 1) + '</td>' +
                '<td class="px-4 py-3 text-sm font-mono text-gray-700 break-words align-top">' + escapeHtml(project.prn || '—') + '</td>' +
                '<td class="px-4 py-3 text-sm font-medium text-gray-900 break-words align-top">' + escapeHtml(project.name || '—') + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-600 break-words align-top">' + escapeHtml(project.description || '—') + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-700 break-words align-top">' + escapeHtml(project.barangay || '—') + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-700 break-words align-top">' + formatCost(project.project_cost) + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-600 break-words align-top">' + escapeHtml(project.source_of_funds || '—') + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap align-top">' + formatDate(project.start_date) + '</td>' +
                '<td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap align-top">' + formatDate(project.end_date) + '</td>' +
                '<td class="px-4 py-3 align-top">' + getStatusBadge(project.status) + '</td>';
            projectsTableBody.appendChild(row);
        });
    }

    if (barangayFilter) barangayFilter.addEventListener('change', filterAndRender);
    if (statusFilter) statusFilter.addEventListener('change', filterAndRender);
    if (startDateFilter) startDateFilter.addEventListener('change', filterAndRender);
    if (endDateFilter) endDateFilter.addEventListener('change', filterAndRender);
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            if (barangayFilter) barangayFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            if (startDateFilter) startDateFilter.value = '';
            if (endDateFilter) endDateFilter.value = '';
            filterAndRender();
        });
    }

    filterAndRender();

    // Export modal
    const exportButton = document.getElementById('export-button');
    const exportModal = document.getElementById('exportModal');
    const closeModalButton = document.getElementById('closeModal');
    const modalTableBody = document.getElementById('modal-projects-table-body');
    const modalBarangayFilter = document.getElementById('modal-barangay-filter');

    function renderModalTable(list) {
        modalTableBody.innerHTML = '';
        if (!list || list.length === 0) {
            modalTableBody.innerHTML = '<tr><td colspan="10" class="px-4 py-4 text-center text-gray-500">No projects to export.</td></tr>';
            return;
        }
        list.forEach((project, index) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML =
                '<td class="px-4 py-2 text-gray-900">' + (index + 1) + '</td>' +
                '<td class="px-4 py-2 font-mono text-gray-700">' + escapeHtml(project.prn || '') + '</td>' +
                '<td class="px-4 py-2 font-medium text-gray-900">' + escapeHtml(project.name || '') + '</td>' +
                '<td class="px-4 py-2 text-gray-600">' + escapeHtml(project.description || '') + '</td>' +
                '<td class="px-4 py-2 text-gray-700">' + escapeHtml(project.barangay || '') + '</td>' +
                '<td class="px-4 py-2 text-gray-700">' + formatCost(project.project_cost) + '</td>' +
                '<td class="px-4 py-2 text-gray-600">' + escapeHtml(project.source_of_funds || '') + '</td>' +
                '<td class="px-4 py-2 text-gray-600">' + formatDate(project.start_date) + '</td>' +
                '<td class="px-4 py-2 text-gray-600">' + formatDate(project.end_date) + '</td>' +
                '<td class="px-4 py-2">' + getStatusBadge(project.status) + '</td>';
            modalTableBody.appendChild(tr);
        });
    }

    function openExportModal() {
        renderModalTable(filteredProjects);
        exportModal.classList.remove('hidden');
    }
    function closeExportModal() {
        exportModal.classList.add('hidden');
    }

    if (exportButton) exportButton.addEventListener('click', openExportModal);
    const exportButtonHeader = document.getElementById('export-button-header');
    if (exportButtonHeader) exportButtonHeader.addEventListener('click', openExportModal);
    if (closeModalButton) closeModalButton.addEventListener('click', closeExportModal);

    if (modalBarangayFilter) {
        modalBarangayFilter.addEventListener('change', function() {
            const val = this.value;
            const list = val ? filteredProjects.filter(p => p.barangay === val) : filteredProjects;
            renderModalTable(list);
        });
    }

    // PDF export via PDFMake – City of Tagum official format
    function exportToPdfMake() {
        const list = (modalBarangayFilter && modalBarangayFilter.value)
            ? filteredProjects.filter(function(p) { return p.barangay === modalBarangayFilter.value; })
            : filteredProjects;

        const now = new Date();
        const reportDate = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).replace(/(\d+), (\d+)/, '$1, $2');

        function toDdMonYy(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return isNaN(d) ? '' : d.getDate() + '-' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + '-' + String(d.getFullYear()).slice(-2);
        }

        function formatCostOfficial(cost) {
            if (cost == null || cost === '') return '';
            const num = Number(String(cost).replace(/[^\d.]/g, ''));
            return isNaN(num) ? '' : num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getRemarks(status, progress) {
            const n = normalizeStatus(status);
            const pct = Number(progress);
            if (pct >= 99 || n === 'completed') return '100% Completed as per POW';
            if (n === 'in_progress') return 'On Going';
            if (n === 'planned' || n === 'pending') return 'For Implementation';
            if (n === 'delayed') return 'On Going';
            return n ? n.charAt(0).toUpperCase() + n.slice(1) : '';
        }

        // Official header: right-aligned institutional text
        const headerContent = [
            { text: 'REPUBLIC OF THE PHILIPPINES', fontSize: 8, alignment: 'right', margin: [0, 0, 0, 0] },
            { text: 'PROVINCE OF DAVAO DEL NORTE', fontSize: 8, alignment: 'right', margin: [0, 0, 0, 0] },
            { text: 'CITY OF TAGUM', fontSize: 11, bold: true, alignment: 'right', margin: [0, 2, 0, 0] },
            { text: 'OFFICE OF THE CITY ENGINEER', fontSize: 11, bold: true, alignment: 'right', margin: [0, 2, 0, 0] },
            { text: 'LIST OF INFRASTRUCTURE PROJECTS', fontSize: 12, bold: true, alignment: 'right', margin: [0, 4, 0, 0] },
            { text: 'As of ' + reportDate, fontSize: 9, alignment: 'right', margin: [0, 2, 0, 0] }
        ];

        // Table: No. | PRN | Name of Project | Location | Project Cost | Project Description | Date Started | Target Date of Completion | Date of Completion | % Accomplishment | REMARKS
        const colWidths = [20, 50, '*', 45, 50, 65, 42, 48, 42, 42, 50];
        const year = now.getFullYear();
        const sectionHeaderRow = [
            { text: year + ' INFRASTRUCTURE PROJECTS', colSpan: 11, alignment: 'center', fillColor: '#166534', color: 'white', bold: true, fontSize: 9 },
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}
        ];
        const mainHeaderRow = [
            { text: 'No.', style: 'tableHeader', alignment: 'center' },
            { text: 'PRN', style: 'tableHeader' },
            { text: 'Name of Project', style: 'tableHeader' },
            { text: 'Location', style: 'tableHeader' },
            { text: 'Project Cost', style: 'tableHeader', alignment: 'right' },
            { text: 'Project Description', style: 'tableHeader' },
            { text: 'Date Started', style: 'tableHeader', alignment: 'center' },
            { text: 'Target Date of Completion', style: 'tableHeader', alignment: 'center' },
            { text: 'Date of Completion', style: 'tableHeader', alignment: 'center' },
            { text: '% Accomplishment', style: 'tableHeader', alignment: 'right' },
            { text: 'REMARKS', style: 'tableHeader' }
        ];
        const tableBody = [sectionHeaderRow, mainHeaderRow];

        list.forEach(function(p, idx) {
            const progress = p.progress != null ? Number(p.progress) : 0;
            const dateCompleted = (progress >= 99 || normalizeStatus(p.status) === 'completed') && p.end_date ? toDdMonYy(p.end_date) : '';
            tableBody.push([
                { text: String(idx + 1), alignment: 'center', fontSize: 8 },
                { text: (p.prn || '').toString(), fontSize: 8 },
                { text: (p.name || '').toString(), fontSize: 8 },
                { text: (p.barangay || '').toString(), fontSize: 8 },
                { text: formatCostOfficial(p.project_cost), alignment: 'right', fontSize: 8 },
                { text: ((p.description || '').toString().substring(0, 80) + ((p.description || '').length > 80 ? '...' : '')), fontSize: 7 },
                { text: toDdMonYy(p.start_date), alignment: 'center', fontSize: 8 },
                { text: toDdMonYy(p.end_date), alignment: 'center', fontSize: 8 },
                { text: dateCompleted, alignment: 'center', fontSize: 8 },
                { text: (progress.toFixed(2) + '%'), alignment: 'right', fontSize: 8 },
                { text: getRemarks(p.status, progress), fontSize: 8 }
            ]);
        });

        const docDef = {
            pageSize: 'A4',
            pageOrientation: 'landscape',
            pageMargins: [30, 80, 30, 50],
            header: function() {
                return {
                    columns: [
                        { text: 'ON GOING / FOR IMPLEMENTATION / PRE-INGE PROJECTS.', fontSize: 8, margin: [30, 20, 0, 0] },
                        { stack: headerContent, width: '*', margin: [0, 20, 30, 0] }
                    ]
                };
            },
            footer: function(currentPage, pageCount) {
                return { text: 'Page ' + currentPage + ' of ' + pageCount, fontSize: 8, color: '#666', alignment: 'center', margin: [0, 0, 0, 15] };
            },
            content: [
                {
                    table: {
                        headerRows: 2,
                        widths: colWidths,
                        body: tableBody
                    },
                    layout: {
                        hLineWidth: function() { return 0.5; },
                        vLineWidth: function() { return 0.5; }
                    }
                }
            ],
            styles: {
                tableHeader: { bold: true, fontSize: 8, fillColor: '#166534', color: 'white' }
            }
        };

        if (typeof pdfMake !== 'undefined') {
            pdfMake.createPdf(docDef).download('list_of_infrastructure_projects_' + now.toISOString().slice(0, 10) + '.pdf');
        } else {
            alert('PDF library not loaded. Please refresh the page and try again.');
        }
    }

    // CSV and Excel: keep server-side export with filter params
    [document.getElementById('export-csv'), document.getElementById('export-excel')].forEach(function(link) {
        if (!link) return;
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const params = new URLSearchParams();
            if (barangayFilter && barangayFilter.value) params.append('barangay', barangayFilter.value);
            if (statusFilter && statusFilter.value) params.append('status', statusFilter.value);
            if (startDateFilter && startDateFilter.value) params.append('start_date', startDateFilter.value);
            if (endDateFilter && endDateFilter.value) params.append('end_date', endDateFilter.value);
            let url = this.getAttribute('href');
            if (params.toString()) url = url + (url.indexOf('?') >= 0 ? '&' : '?') + params.toString();
            window.location.href = url;
            closeExportModal();
        });
    });

    // PDF: use PDFMake (client-side)
    const exportPdfBtn = document.getElementById('export-pdf');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', function(e) {
            e.preventDefault();
            exportToPdfMake();
            closeExportModal();
        });
    }
});
</script>
{% endblock %}
