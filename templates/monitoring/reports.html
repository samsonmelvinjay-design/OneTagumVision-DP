{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="container mx-auto p-6 bg-gray-100 min-h-screen">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Project Reports</h1>

    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">All Projects for Reporting</h2>
            {# Controls #}
            <div class="flex flex-row gap-4 items-center">
                <button id="export-button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-green-500 focus:border-green-500">
                    Export
                </button>
      </div>
    </div>

        {# Add Filter Form Here #}
        <form method="get" id="filter-form" class="mb-4">
            <div class="flex flex-wrap gap-4 items-center">
          <div>
                    <label for="barangay-filter" class="block text-sm font-medium text-gray-700">Barangay:</label>
                    <select id="barangay-filter" name="barangay" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">All Barangays</option>
                        <option value="Apokon">Apokon</option>
                        <option value="Bincungan">Bincungan</option>
                        <option value="Busaon">Busaon</option>
                        <option value="Canocotan">Canocotan</option>
                        <option value="Cuambogan">Cuambogan</option>
                        <option value="La Filipina">La Filipina</option>
                        <option value="Liboganon">Liboganon</option>
                        <option value="Madaum">Madaum</option>
                        <option value="Magdum">Magdum</option>
                        <option value="Magugpo East">Magugpo East</option>
                        <option value="Magugpo North">Magugpo North</option>
                        <option value="Magugpo Poblacion">Magugpo Poblacion</option>
                        <option value="Magugpo South">Magugpo South</option>
                        <option value="Magugpo West">Magugpo West</option>
                        <option value="Mankilam">Mankilam</option>
                        <option value="New Balamban">New Balamban</option>
                        <option value="Nueva Fuerza">Nueva Fuerza</option>
                        <option value="Pagsabangan">Pagsabangan</option>
                        <option value="Pandapan">Pandapan</option>
                        <option value="San Agustin">San Agustin</option>
                        <option value="San Isidro">San Isidro</option>
                        <option value="San Miguel">San Miguel</option>
                        <option value="Visayan Village">Visayan Village</option>
            </select>
          </div>
          <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-700">Status:</label>
                    <select id="status-filter" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="in_progress">Ongoing</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="planned">Planned</option>
                        <option value="pending">Pending</option>
                        <option value="delayed">Delayed</option>
            </select>
          </div>
          <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700">Start Date:</label>
                    <input type="date" id="start-date-filter" name="start_date" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
          </div>
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700">End Date:</label>
                    <input type="date" id="end-date-filter" name="end_date" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
        </div>
                <div class="flex items-end">
                    <button type="button" id="clear-filters-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:ring-gray-500 focus:border-gray-500">Clear Filters</button>
              </div>
              </div>
        </form>

        {# Table of projects #}
        <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
            <table id="projects-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRN#</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name of Project</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Description</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Cost</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source of Funds</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Started</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Ended</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="projects-table-body">
                    {# Table rows will be populated by JavaScript #}
                </tbody>
            </table>
        </div>
      </div>
    </div>

<!-- Export Modal -->
<div id="exportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 1000;">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-screen-xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Export Project List</h3>
                {# Group dropdown and close button #}
                <div class="flex items-center">
                    {# Add Barangay Dropdown Here #}
                    <div class="relative inline-block text-left mr-4">
                        <div>
                            <label for="modal-barangay-filter" class="sr-only">Barangay:</label>
                            <select id="modal-barangay-filter" name="modal_barangay" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500">
                                <option value="">All Barangays</option>
                                <option value="Apokon">Apokon</option>
                                <option value="Bincungan">Bincungan</option>
                                <option value="Busaon">Busaon</option>
                                <option value="Canocotan">Canocotan</option>
                                <option value="Cuambogan">Cuambogan</option>
                                <option value="La Filipina">La Filipina</option>
                                <option value="Liboganon">Liboganon</option>
                                <option value="Madaum">Madaum</option>
                                <option value="Magdum">Magdum</option>
                                <option value="Magugpo East">Magugpo East</option>
                                <option value="Magugpo North">Magugpo North</option>
                                <option value="Magugpo Poblacion">Magugpo Poblacion</option>
                                <option value="Magugpo South">Magugpo South</option>
                                <option value="Magugpo West">Magugpo West</option>
                                <option value="Mankilam">Mankilam</option>
                                <option value="New Balamban">New Balamban</option>
                                <option value="Nueva Fuerza">Nueva Fuerza</option>
                                <option value="Pagsabangan">Pagsabangan</option>
                                <option value="Pandapan">Pandapan</option>
                                <option value="San Agustin">San Agustin</option>
                                <option value="San Isidro">San Isidro</option>
                                <option value="San Miguel">San Miguel</option>
                                <option value="Visayan Village">Visayan Village</option>
                            </select>
        </div>
      </div>

                    {# Export As Dropdown #}
                    <div class="relative inline-block text-left mr-4">
                        <div>
                            <button type="button" id="export-dropdown-button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500" aria-haspopup="true" aria-expanded="true">
                                Export As
                                <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
                            </button>
      </div>

                        <div id="export-dropdown-menu" class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="export-dropdown-button">
                            <div class="py-1" role="none">
                                <a href="{% url 'export_reports_csv' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" id="export-csv">Export CSV</a>
                                <a href="{% url 'export_reports_excel' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" id="export-excel">Export Excel</a>
                                <a href="{% url 'export_reports_pdf' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" id="export-pdf">Export PDF</a>
          </div>
        </div>
      </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                </div>
            </div>
            
        <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRN#</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name of Project</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Cost</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source of Funds</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Started</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Ended</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
                    <tbody id="modal-projects-table-body" class="bg-white divide-y divide-gray-200">
                        {# Project rows will be added here by JavaScript #}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

{{ projects_json|json_script:"projects-data" }}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get project data directly from the template context
    const projectsDataElement = document.getElementById('projects-data');
    let projects = [];
let filteredProjects = [];

    if (projectsDataElement) {
        try {
            const rawContent = projectsDataElement.textContent.trim();
            if (rawContent) {
                const parsed = JSON.parse(rawContent);
                // Ensure we have an array
                if (Array.isArray(parsed)) {
                    projects = parsed;
                    console.log('Loaded', projects.length, 'projects');
                } else {
                    console.error('Projects data is not an array:', typeof parsed, parsed);
                    projects = [];
                }
            } else {
                console.warn('Projects data element is empty');
                projects = [];
            }
        } catch (e) {
            console.error('Error parsing projects data:', e);
            console.error('Raw content:', projectsDataElement.textContent);
            projects = [];
        }
    } else {
        console.error('Projects data element not found');
        projects = [];
    }
    
    filteredProjects = [...projects]; // Create a copy

    // Filter elements
    const filterForm = document.getElementById('filter-form');
    const barangayFilter = document.getElementById('barangay-filter');
    const statusFilter = document.getElementById('status-filter');
    const startDateFilter = document.getElementById('start-date-filter');
    const endDateFilter = document.getElementById('end-date-filter');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const projectsTableBody = document.getElementById('projects-table-body');

    // Function to normalize status
function normalizeStatus(status) {
    if (!status) return '';
    status = status.toLowerCase();
    if (status === 'in_progress' || status === 'ongoing') return 'Ongoing';
    if (status === 'planned' || status === 'pending') return 'Planned';
    if (status === 'completed') return 'Completed';
    if (status === 'delayed') return 'Delayed';
    return status.charAt(0).toUpperCase() + status.slice(1);
}

    // Function to format date
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        if (isNaN(date)) return dateStr;
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Function to format cost
    function formatCost(cost) {
        if (!cost) return 'N/A';
        const num = Number(String(cost).replace(/[^\d.]/g, ''));
        if (isNaN(num)) return cost;
        return 'â‚±' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Function to get status badge HTML
    function getStatusBadge(status) {
        const normStatus = normalizeStatus(status);
        if (normStatus === 'Completed') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Completed</span>';
        } else if (normStatus === 'Ongoing') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Ongoing</span>';
        } else if (normStatus === 'Planned') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Planned</span>';
        } else if (normStatus === 'Delayed') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Delayed</span>';
        } else {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">' + normStatus + '</span>';
        }
    }

    // Function to filter and render projects
    function filterAndRender() {
        // Ensure projects is an array
        if (!Array.isArray(projects)) {
            console.error('Projects is not an array, cannot filter');
            projects = [];
        }
        
        const barangay = barangayFilter ? barangayFilter.value : '';
        const status = statusFilter ? statusFilter.value : '';
        const startDate = startDateFilter ? startDateFilter.value : '';
        const endDate = endDateFilter ? endDateFilter.value : '';

        filteredProjects = projects.filter(p => {
            const matchesBarangay = !barangay || (p.barangay && p.barangay.trim().toLowerCase() === barangay.trim().toLowerCase());
            const matchesStatus = !status || normalizeStatus(p.status) === normalizeStatus(status);
            let matchesDate = true;
            if (startDate && p.start_date) {
                matchesDate = matchesDate && (new Date(p.start_date) >= new Date(startDate));
            }
            if (endDate && p.end_date) {
                matchesDate = matchesDate && (new Date(p.end_date) <= new Date(endDate));
            }
            return matchesBarangay && matchesStatus && matchesDate;
        });

        renderTable();
    }

    // Function to render table
    function renderTable() {
        projectsTableBody.innerHTML = '';
        if (filteredProjects.length === 0) {
            projectsTableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        No projects found for the selected criteria.
                    </td>
                </tr>
            `;
            return;
        }

        filteredProjects.forEach((project, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${index + 1}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.prn || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${project.name || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.description || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.barangay || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatCost(project.project_cost)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.source_of_funds || 'N/A'}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatDate(project.start_date)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatDate(project.end_date)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(project.status)}</td>
            `;
            projectsTableBody.appendChild(row);
        });
    }

    // Event listeners
    if (barangayFilter) {
        barangayFilter.addEventListener('change', filterAndRender);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterAndRender);
    }
    if (startDateFilter) {
        startDateFilter.addEventListener('change', filterAndRender);
    }
    if (endDateFilter) {
        endDateFilter.addEventListener('change', filterAndRender);
    }
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            barangayFilter.value = '';
            statusFilter.value = '';
            startDateFilter.value = '';
            endDateFilter.value = '';
            filterAndRender();
        });
    }

    // Initial render
    filterAndRender();

    // Export Modal Logic
    const exportButton = document.getElementById('export-button');
    const exportModal = document.getElementById('exportModal');
    const closeModalButton = document.getElementById('closeModal');
    const modalTableBody = document.getElementById('modal-projects-table-body');
    const exportDropdownButton = document.getElementById('export-dropdown-button');
    const exportDropdownMenu = document.getElementById('export-dropdown-menu');
    const modalBarangayFilter = document.getElementById('modal-barangay-filter');

    // Function to render the modal table with provided projects
    function renderModalTable(projectsToDisplay) {
        modalTableBody.innerHTML = '';
        if (projectsToDisplay.length === 0) {
            modalTableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        No projects found for the selected criteria.
                    </td>
                </tr>
            `;
            return;
        }

        projectsToDisplay.forEach((project, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${index + 1}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.prn || ''}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${project.name || ''}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.description || ''}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.barangay || ''}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatCost(project.project_cost)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${project.source_of_funds || ''}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatDate(project.start_date)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">${formatDate(project.end_date)}</div></td>
                <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(project.status)}</td>
            `;
            modalTableBody.appendChild(row);
        });
    }

    // Function to open the modal
    function openExportModal() {
        renderModalTable(filteredProjects);
        exportModal.classList.remove('hidden');
    }

    // Function to close export modal
    function closeExportModal() {
        exportModal.classList.add('hidden');
    }
    
    // Event listeners for export button and close button
    if (exportButton) {
        exportButton.addEventListener('click', openExportModal);
    }
    if (closeModalButton) {
        closeModalButton.addEventListener('click', closeExportModal);
    }

    // Event listener for the modal barangay filter dropdown
    if (modalBarangayFilter) {
        modalBarangayFilter.addEventListener('change', function() {
            const selectedBarangay = this.value;
            let filtered = filteredProjects;
            if (selectedBarangay) {
                filtered = filteredProjects.filter(project => project.barangay === selectedBarangay);
            }
            renderModalTable(filtered);
        });
    }

    // Event listener for the export dropdown button (toggle menu visibility)
    if (exportDropdownButton) {
        exportDropdownButton.addEventListener('click', () => {
            exportDropdownMenu.classList.toggle('hidden');
        });
    }

    // Add event listeners for the export links
    const exportCsv = document.getElementById('export-csv');
    const exportExcel = document.getElementById('export-excel');
    const exportPdf = document.getElementById('export-pdf');

    if (exportCsv) {
        exportCsv.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedBarangay = modalBarangayFilter ? modalBarangayFilter.value : '';
            let exportUrl = this.href;
            if (selectedBarangay) {
                exportUrl = `${exportUrl}?barangay=${selectedBarangay}`;
            }
            window.location.href = exportUrl;
            closeExportModal();
        });
    }

    if (exportExcel) {
        exportExcel.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedBarangay = modalBarangayFilter ? modalBarangayFilter.value : '';
            let exportUrl = this.href;
            if (selectedBarangay) {
                exportUrl = `${exportUrl}?barangay=${selectedBarangay}`;
            }
            window.location.href = exportUrl;
            closeExportModal();
        });
    }

    if (exportPdf) {
        exportPdf.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedBarangay = modalBarangayFilter ? modalBarangayFilter.value : '';
            let exportUrl = this.href;
            if (selectedBarangay) {
                exportUrl = `${exportUrl}?barangay=${selectedBarangay}`;
            }
            window.location.href = exportUrl;
            closeExportModal();
        });
    }
});
</script>
{% endblock %} 
