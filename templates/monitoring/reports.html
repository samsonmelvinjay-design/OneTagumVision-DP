{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Project Reports</h1>
      <p class="text-gray-600 text-sm lg:text-base">Comprehensive project analytics and reporting dashboard</p>
    </div>

    <!-- Filters Section -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6 no-print">
      <!-- Date Range Presets -->
      <div class="mb-4 pb-4 border-b border-gray-200">
        <label class="block text-xs font-semibold text-gray-600 mb-2">Quick Date Range</label>
        <div class="flex flex-wrap gap-2">
          <button onclick="setDateRange('7days')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-lg transition-colors">Last 7 Days</button>
          <button onclick="setDateRange('30days')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-lg transition-colors">Last 30 Days</button>
          <button onclick="setDateRange('month')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-lg transition-colors">This Month</button>
          <button onclick="setDateRange('year')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-lg transition-colors">This Year</button>
          <button onclick="setDateRange('all')" class="px-3 py-1.5 text-xs font-medium bg-gray-100 hover:bg-blue-100 text-gray-700 hover:text-blue-700 rounded-lg transition-colors">All Time</button>
        </div>
      </div>
      <div class="flex flex-col lg:flex-row lg:items-end gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 flex-1">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1.5">Start Date</label>
            <input id="filter-start-date" type="date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium transition-all hover:border-gray-300">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1.5">End Date</label>
            <input id="filter-end-date" type="date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium transition-all hover:border-gray-300">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1.5">Barangay</label>
            <select id="filter-barangay" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300">
              <option>All Barangays</option>
              <option>Apokon</option>
              <option>Bincungan</option>
              <option>Busaon</option>
              <option>Canocotan</option>
              <option>Cuambogan</option>
              <option>La Filipina</option>
              <option>Liboganon</option>
              <option>Madaum</option>
              <option>Magdum</option>
              <option>Magugpo North</option>
              <option>Magugpo South</option>
              <option>Magugpo East</option>
              <option>Magugpo West</option>
              <option>Magugpo Poblacion</option>
              <option>Mankilam</option>
              <option>New Balamban</option>
              <option>Nueva Fuerza</option>
              <option>Pagsabangan</option>
              <option>Pandapan</option>
              <option>San Agustin</option>
              <option>San Isidro</option>
              <option>San Miguel</option>
              <option>Visayan Village</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1.5">Status</label>
            <select id="filter-status" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium bg-white transition-all hover:border-gray-300">
              <option>All Status</option>
              <option>Completed</option>
              <option>Ongoing</option>
              <option>Planned</option>
              <option>Delayed</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1.5">Search</label>
            <input id="filter-search" type="text" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base font-medium transition-all hover:border-gray-300" placeholder="Search projects...">
          </div>
        </div>
        <div class="flex gap-3">
          <button id="view-project-list-btn" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg text-base font-semibold shadow-md transition-all duration-200 hover:shadow-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            View Project List
            <span id="project-count-badge" class="bg-white bg-opacity-20 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
          </button>
          <button onclick="clearAllFilters()" class="inline-flex items-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-5 py-2.5 rounded-lg text-base font-semibold shadow-md transition-all duration-200 hover:shadow-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Clear Filters
          </button>
          <div class="relative">
            <button id="export-btn" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-base font-semibold shadow-md transition-all duration-200 hover:shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Export
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-50 border border-gray-200 overflow-hidden">
            <a href="{% url 'export_reports_pdf' %}" target="_blank" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors border-b border-gray-100">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Export to PDF
              </div>
            </a>
            <a href="{% url 'export_reports_excel' %}" target="_blank" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors border-b border-gray-100">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export to Excel
              </div>
            </a>
            <a href="{% url 'export_reports_csv' %}" target="_blank" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors border-b border-gray-100">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export to CSV
              </div>
            </a>
            <button onclick="window.print()" class="block w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                </svg>
                Print Report
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content: Summary, Charts -->
    <div class="flex-1 flex flex-col min-h-0">
      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 lg:gap-4 mb-6">
        <div id="card-total" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">0</div>
          <div class="text-blue-100 text-xs font-medium">Total Projects</div>
        </div>
        <div id="card-completed" class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">0</div>
          <div class="text-green-100 text-xs font-medium">Completed</div>
        </div>
        <div id="card-ongoing" class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">0</div>
          <div class="text-yellow-100 text-xs font-medium">Ongoing</div>
        </div>
        <div id="card-planned" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">0</div>
          <div class="text-purple-100 text-xs font-medium">Planned</div>
        </div>
        <div id="card-delayed" class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">0</div>
          <div class="text-red-100 text-xs font-medium">Delayed</div>
        </div>
      </div>

      <!-- Budget Metrics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">₱{{ total_budget|floatformat:0|intcomma }}</div>
          <div class="text-indigo-100 text-xs font-medium">Total Budget</div>
        </div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">₱{{ total_spent|floatformat:0|intcomma }}</div>
          <div class="text-orange-100 text-xs font-medium">Total Spent</div>
        </div>
        <div class="bg-gradient-to-br from-teal-500 to-teal-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">₱{{ remaining_budget|floatformat:0|intcomma }}</div>
          <div class="text-teal-100 text-xs font-medium">Remaining Budget</div>
        </div>
        <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <div class="bg-white bg-opacity-20 rounded-lg p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
          </div>
          <div class="text-2xl font-bold mb-1">{{ budget_utilization|floatformat:1 }}%</div>
          <div class="text-pink-100 text-xs font-medium">Budget Utilization</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-bold text-gray-800">Projects by Status</h2>
          </div>
          <canvas id="barChart" height="120"></canvas>
        </div>
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-bold text-gray-800">Projects by Barangay</h2>
          </div>
          <canvas id="pieChart" height="120"></canvas>
        </div>
      </div>

    </div>
  </div>

  <!-- Project List Modal -->
  <div id="project-list-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl mx-4 max-h-[90vh] flex flex-col relative">
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 rounded-t-2xl flex items-center justify-between">
        <h2 class="text-2xl font-bold text-white">Project List</h2>
        <div class="flex items-center gap-3">
          <div class="relative">
            <button id="modal-export-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Export
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div id="modal-export-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 border border-gray-200 overflow-hidden">
              <a href="{% url 'export_reports_pdf' %}" id="modal-export-pdf" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors border-b border-gray-100">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                  </svg>
                  Export as PDF
                </div>
              </a>
              <a href="{% url 'export_reports_csv' %}" id="modal-export-csv" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors border-b border-gray-100">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export as CSV
                </div>
              </a>
              <a href="{% url 'export_reports_excel' %}" id="modal-export-excel" class="block px-4 py-3 text-gray-700 hover:bg-blue-50 transition-colors">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Export as Excel
                </div>
              </a>
            </div>
          </div>
          <button id="close-modal-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white w-8 h-8 rounded-lg flex items-center justify-center transition-all font-bold text-xl">&times;</button>
        </div>
      </div>
      <!-- Modal Body -->
      <div class="flex-1 overflow-auto p-6">
        <div class="overflow-x-auto">
          <table id="modal-report-table" class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50 sticky top-0">
              <tr>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">#</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">PRN#</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Name of Project</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Project Description</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Location</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Project Cost</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Source of Funds</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Date Started</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Date Ended</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">Status</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <!-- Table rows will be rendered by JS -->
            </tbody>
          </table>
        </div>
      </div>
      <!-- Modal Footer with Pagination -->
      <div class="bg-gray-50 px-6 py-4 rounded-b-2xl border-t border-gray-200">
        <div class="flex justify-between items-center">
          <div class="text-sm text-gray-600">
            Showing <span id="modal-page-info" class="font-semibold">0</span> of <span id="modal-total-info" class="font-semibold">0</span> projects
          </div>
          <nav id="modal-pagination" class="flex space-x-2"></nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Engineer Projects Modal (copied from base.html for reports page compatibility) -->
  <!-- REMOVED: Modal HTML now only in base.html -->
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Declare filteredProjects globally
let filteredProjects = [];

// Example data, replace with Django context variables
const statusLabels = {{ status_labels|safe }};
const statusCounts = {{ status_counts|safe }};
const barangayLabels = {{ barangay_labels|safe }};
const barangayCounts = {{ barangay_counts|safe }};
const allProjects = JSON.parse('{{ projects_json|escapejs }}');

// Bar Chart
const barCtx = document.getElementById('barChart').getContext('2d');
const barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: statusLabels,
        datasets: [{
            label: 'Projects',
            data: statusCounts,
            backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#F87171', '#6366F1', '#F472B6'
            ],
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } }
    }
});

// Pie Chart
const pieCtx = document.getElementById('pieChart').getContext('2d');
const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: barangayLabels,
        datasets: [{
            data: barangayCounts,
            backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#F87171', '#6366F1', '#F472B6', '#34D399', '#FBBF24', '#A78BFA', '#FCA5A5', '#6EE7B7', '#FDE68A', '#C4B5FD', '#F9A8D4', '#FCD34D', '#818CF8', '#FECACA', '#A7F3D0', '#FDE68A', '#DDD6FE', '#FBCFE8', '#FDE68A', '#C7D2FE'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
    }
});

// Filtering logic
const filterStartDate = document.getElementById('filter-start-date');
const filterEndDate = document.getElementById('filter-end-date');
const filterBarangay = document.getElementById('filter-barangay');
const filterStatus = document.getElementById('filter-status');
const filterSearch = document.getElementById('filter-search');

function normalizeStatus(status) {
    if (!status) return '';
    status = status.toLowerCase();
    if (status === 'in_progress' || status === 'ongoing') return 'Ongoing';
    if (status === 'planned' || status === 'pending') return 'Planned';
    if (status === 'completed') return 'Completed';
    if (status === 'delayed') return 'Delayed';
    return status.charAt(0).toUpperCase() + status.slice(1);
}

function filterAndRender() {
    const barangay = filterBarangay.value;
    const status = filterStatus.value;
    const search = filterSearch.value.trim().toLowerCase();
    const startDate = filterStartDate.value;
    const endDate = filterEndDate.value;
    // Filter projects
    filteredProjects = allProjects.filter(p => {
        const matchesBarangay = (
            barangay === 'All Barangays' ||
            (p.barangay && p.barangay.trim().toLowerCase() === barangay.trim().toLowerCase())
        );
        const matchesStatus = (
            status === 'All Status' ||
            normalizeStatus(p.status) === status
        );
        const matchesSearch = (
            !search ||
            (p.name && p.name.toLowerCase().includes(search)) ||
            (p.barangay && p.barangay.toLowerCase().includes(search)) ||
            (p.status && normalizeStatus(p.status).toLowerCase().includes(search))
        );
        // Date filter logic
        let matchesDate = true;
        if (startDate) {
            matchesDate = matchesDate && p.start_date && (new Date(p.start_date) >= new Date(startDate));
        }
        if (endDate) {
            matchesDate = matchesDate && p.end_date && (new Date(p.end_date) <= new Date(endDate));
        }
        return matchesBarangay && matchesStatus && matchesSearch && matchesDate;
    });
    // Update summary cards
    document.querySelector('#card-total span').textContent = filteredProjects.length;
    document.querySelector('#card-completed span').textContent = filteredProjects.filter(p => normalizeStatus(p.status) === 'Completed').length;
    document.querySelector('#card-ongoing span').textContent = filteredProjects.filter(p => normalizeStatus(p.status) === 'Ongoing').length;
    document.querySelector('#card-planned span').textContent = filteredProjects.filter(p => normalizeStatus(p.status) === 'Planned').length;
    document.querySelector('#card-delayed span').textContent = filteredProjects.filter(p => normalizeStatus(p.status) === 'Delayed').length;
    
    // Update project count badge
    const projectCountBadge = document.getElementById('project-count-badge');
    if (projectCountBadge) {
        projectCountBadge.textContent = filteredProjects.length;
    }
    // Update charts
    // Bar chart (status)
    const statusMap = {};
    filteredProjects.forEach(p => {
        const s = normalizeStatus(p.status);
        statusMap[s] = (statusMap[s] || 0) + 1;
    });
    barChart.data.labels = Object.keys(statusMap);
    barChart.data.datasets[0].data = Object.values(statusMap);
    barChart.update();
    // Pie chart (barangay)
    const barangayMap = {};
    filteredProjects.forEach(p => {
        if (p.barangay) barangayMap[p.barangay] = (barangayMap[p.barangay] || 0) + 1;
    });
    pieChart.data.labels = Object.keys(barangayMap);
    pieChart.data.datasets[0].data = Object.values(barangayMap);
    pieChart.update();
}

filterStartDate.addEventListener('change', filterAndRender);
filterEndDate.addEventListener('change', filterAndRender);
filterBarangay.addEventListener('change', filterAndRender);
filterStatus.addEventListener('change', filterAndRender);
filterSearch.addEventListener('input', filterAndRender);

// Initial render
filterAndRender();

// Date Range Preset Functions
function setDateRange(range) {
    const today = new Date();
    const startDateInput = document.getElementById('filter-start-date');
    const endDateInput = document.getElementById('filter-end-date');
    
    let startDate = new Date();
    let endDate = new Date();
    
    switch(range) {
        case '7days':
            startDate.setDate(today.getDate() - 7);
            endDate = today;
            break;
        case '30days':
            startDate.setDate(today.getDate() - 30);
            endDate = today;
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = today;
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = today;
            break;
        case 'all':
            startDate = null;
            endDate = null;
            break;
    }
    
    if (startDate) {
        startDateInput.value = startDate.toISOString().split('T')[0];
    } else {
        startDateInput.value = '';
    }
    
    if (endDate) {
        endDateInput.value = endDate.toISOString().split('T')[0];
    } else {
        endDateInput.value = '';
    }
    
    filterAndRender();
}

// Clear All Filters Function
function clearAllFilters() {
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    document.getElementById('filter-barangay').value = 'All Barangays';
    document.getElementById('filter-status').value = 'All Status';
    document.getElementById('filter-search').value = '';
    filterAndRender();
}

// View Project List Button Handler
const viewProjectListBtn = document.getElementById('view-project-list-btn');
if (viewProjectListBtn) {
    viewProjectListBtn.addEventListener('click', function() {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
        projectListModal.classList.remove('hidden');
    });
}

// Modal logic
const projectListModal = document.getElementById('project-list-modal');
const closeModalBtn = document.getElementById('close-modal-btn');
const modalReportTable = document.getElementById('modal-report-table').getElementsByTagName('tbody')[0];
const modalPagination = document.getElementById('modal-pagination');
const modalExportBtn = document.getElementById('modal-export-btn');
const modalExportDropdown = document.getElementById('modal-export-dropdown');
const MODAL_PAGE_SIZE = 10;
let modalCurrentPage = 1;

// Export dropdown toggle
const exportBtn = document.getElementById('export-btn');
const exportDropdown = document.getElementById('export-dropdown');
if (exportBtn) {
  exportBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    exportDropdown.classList.toggle('hidden');
  });
}
// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!exportDropdown.contains(e.target) && !exportBtn.contains(e.target)) {
    exportDropdown.classList.add('hidden');
  }
});

// Close modal on close button click
closeModalBtn.addEventListener('click', function() {
    projectListModal.classList.add('hidden');
});
// Close modal when clicking outside the modal content
projectListModal.addEventListener('click', function(e) {
    if (e.target === projectListModal) {
        projectListModal.classList.add('hidden');
    }
});

// Render paginated filtered projects in modal
function renderModalTablePage(page) {
    modalReportTable.innerHTML = '';
    const start = (page - 1) * MODAL_PAGE_SIZE;
    const end = start + MODAL_PAGE_SIZE;
    const pageProjects = filteredProjects.slice(start, end);
    pageProjects.forEach((project, idx) => {
        let statusBadge = '';
        const normStatus = normalizeStatus(project.status);
        if (normStatus === 'Completed') {
            statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>';
        } else if (normStatus === 'Ongoing') {
            statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold">Ongoing</span>';
        } else if (normStatus === 'Planned') {
            statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Planned</span>';
        } else if (normStatus === 'Delayed') {
            statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Delayed</span>';
        } else {
            statusBadge = normStatus;
        }
        modalReportTable.innerHTML += `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 text-gray-700 font-medium">${start + idx + 1}</td>
            <td class="px-4 py-3 text-gray-700 break-words" title="${project.prn || ''}">${wrapAfterNWords(project.prn || 'N/A')}</td>
            <td class="px-4 py-3 text-gray-900 font-medium break-words" title="${capitalize(project.name) || ''}">${wrapAfterNWords(capitalize(project.name) || 'N/A')}</td>
            <td class="px-4 py-3 text-gray-600 break-words max-w-xs" title="${project.description || ''}">${wrapAfterNWords(project.description || 'N/A', 5)}</td>
            <td class="px-4 py-3 text-gray-700 break-words" title="${project.location || ''}">${wrapAfterNWords(project.location || 'N/A')}</td>
            <td class="px-4 py-3 text-gray-700 font-medium" title="${project.project_cost || ''}">${formatCost(project.project_cost) || 'N/A'}</td>
            <td class="px-4 py-3 text-gray-600 break-words max-w-xs" title="${project.source_of_funds || ''}">${wrapAfterNWords(project.source_of_funds || 'N/A', 5)}</td>
            <td class="px-4 py-3 text-gray-600">${formatDate(project.start_date) || 'N/A'}</td>
            <td class="px-4 py-3 text-gray-600">${formatDate(project.end_date) || 'N/A'}</td>
            <td class="px-4 py-3">${statusBadge}</td>
        </tr>`;
    });
}

function renderModalPagination() {
    modalPagination.innerHTML = '';
    const totalPages = Math.ceil(filteredProjects.length / MODAL_PAGE_SIZE);
    const start = (modalCurrentPage - 1) * MODAL_PAGE_SIZE + 1;
    const end = Math.min(modalCurrentPage * MODAL_PAGE_SIZE, filteredProjects.length);
    
    // Update page info
    document.getElementById('modal-page-info').textContent = `${start}-${end}`;
    document.getElementById('modal-total-info').textContent = filteredProjects.length;
    
    if (totalPages <= 1) return;
    
    // Previous button
    if (modalCurrentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '‹';
        prevBtn.className = 'px-3 py-1.5 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-semibold';
        prevBtn.onclick = () => {
            modalCurrentPage--;
            renderModalTablePage(modalCurrentPage);
            renderModalPagination();
        };
        modalPagination.appendChild(prevBtn);
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= modalCurrentPage - 1 && i <= modalCurrentPage + 1)) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `px-3 py-1.5 rounded-lg text-sm font-semibold transition-colors ${
                i === modalCurrentPage 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`;
            btn.onclick = () => {
                modalCurrentPage = i;
                renderModalTablePage(modalCurrentPage);
                renderModalPagination();
            };
            modalPagination.appendChild(btn);
        } else if (i === modalCurrentPage - 2 || i === modalCurrentPage + 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.className = 'px-2 text-gray-500';
            modalPagination.appendChild(ellipsis);
        }
    }
    
    // Next button
    if (modalCurrentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '›';
        nextBtn.className = 'px-3 py-1.5 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-semibold';
        nextBtn.onclick = () => {
            modalCurrentPage++;
            renderModalTablePage(modalCurrentPage);
            renderModalPagination();
        };
        modalPagination.appendChild(nextBtn);
    }
}

// Update modal table and pagination when filters change
filterStartDate.addEventListener('change', function() {
    if (!projectListModal.classList.contains('hidden')) {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
    }
});
filterEndDate.addEventListener('change', function() {
    if (!projectListModal.classList.contains('hidden')) {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
    }
});
filterBarangay.addEventListener('change', function() {
    if (!projectListModal.classList.contains('hidden')) {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
    }
});
filterStatus.addEventListener('change', function() {
    if (!projectListModal.classList.contains('hidden')) {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
    }
});
filterSearch.addEventListener('input', function() {
    if (!projectListModal.classList.contains('hidden')) {
        modalCurrentPage = 1;
        renderModalTablePage(modalCurrentPage);
        renderModalPagination();
    }
});

// Modal Export Dropdown Logic
modalExportBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    modalExportDropdown.classList.toggle('hidden');
});
document.addEventListener('click', function(e) {
    if (!modalExportDropdown.classList.contains('hidden')) {
        modalExportDropdown.classList.add('hidden');
    }
});
modalExportDropdown.addEventListener('click', function(e) {
    e.stopPropagation(); // Prevent closing when clicking inside dropdown
});

function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr;
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}
function formatCost(cost) {
    if (!cost) return '';
    // Remove commas and non-numeric except dot
    const num = Number(String(cost).replace(/[^\d.]/g, ''));
    if (isNaN(num)) return cost;
    return num.toLocaleString();
}
function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
}
function wrapAfterNWords(str, n = 3) {
    if (!str) return '';
    const words = str.split(' ');
    let result = '';
    for (let i = 0; i < words.length; i++) {
        result += words[i];
        if ((i + 1) % n === 0 && i !== words.length - 1) {
            result += '<br>';
        } else if (i !== words.length - 1) {
            result += ' ';
        }
    }
    return result;
}
</script>
{% endblock %} 