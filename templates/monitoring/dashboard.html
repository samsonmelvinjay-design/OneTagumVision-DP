{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 lg:px-8">
        <!-- Header Section with Welcome -->
        <div class="mb-8">
            <div class="mb-6">
                <!-- Welcome Section -->
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                        Welcome back, <span class="text-blue-600">{{ user.get_full_name|default:user.username }}</span>!
                    </h1>
                    <p class="text-gray-600 text-sm lg:text-base">Here's an overview of your projects and city development progress</p>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards - Modern Grid Layout -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 lg:gap-6 mb-8">
            <!-- Total Projects Card -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-total-projects">{{ project_count }}</div>
                <div class="text-blue-100 text-sm font-medium">Total Projects</div>
            </div>

            <!-- Completed Projects Card -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-completed">{{ completed_count }}</div>
                <div class="text-green-100 text-sm font-medium">Completed</div>
            </div>

            <!-- In Progress Card -->
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-in-progress">{{ in_progress_count }}</div>
                <div class="text-yellow-100 text-sm font-medium">In Progress</div>
            </div>

            <!-- Planned Projects Card -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-planned">{{ planned_count }}</div>
                <div class="text-purple-100 text-sm font-medium">Planned</div>
            </div>

            <!-- Delayed Projects Card -->
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-delayed">{{ delayed_count }}</div>
                <div class="text-red-100 text-sm font-medium">Delayed</div>
            </div>
        </div>

        <!-- Recent Projects and Quick Stats Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Recent Projects Section -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Recent Projects
                    </h2>
                    <a href="{% url 'project_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All →</a>
                </div>
                <div class="space-y-3">
                    {% for project in recent_projects %}
                    <a href="{% url 'monitoring_project_detail' project.id %}" class="block bg-gradient-to-r from-gray-50 to-white rounded-lg p-4 border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all duration-200 group">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors mb-1">{{ project.name }}</h3>
                                <div class="flex items-center gap-3 text-sm text-gray-600">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        {{ project.barangay|default:"N/A" }}
                                    </span>
                                    <span class="text-gray-400">•</span>
                                    <span>{{ project.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold {% if project.status_normalized == 'completed' %}bg-green-100 text-green-700{% elif project.status_normalized == 'in_progress' %}bg-yellow-100 text-yellow-700{% elif project.status_normalized == 'planned' %}bg-purple-100 text-purple-700{% elif project.status_normalized == 'delayed' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ project.status_display }}
                                </span>
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No recent projects</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Quick Stats
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg flex-wrap gap-2">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-gray-700 font-medium">Completion Rate</span>
                            {% if completion_rate_year %}<span class="text-gray-500 text-sm">({{ completion_rate_year }})</span>{% endif %}
                            {% if available_years %}
                            <form method="get" class="inline" id="quick-stats-year-form">
                                <select name="year" onchange="this.form.submit()" class="text-sm rounded border border-gray-300 bg-white px-2 py-1 text-gray-700 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All years</option>
                                    {% for y in available_years %}
                                    <option value="{{ y }}" {% if completion_rate_year == y %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            {% endif %}
                        </div>
                        <span class="text-lg font-bold text-blue-600">{{ completion_rate }}%</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <span class="text-gray-700 font-medium">Active Projects</span>
                        <span class="text-lg font-bold text-green-600">{{ in_progress_count }}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                        <span class="text-gray-700 font-medium">Pending</span>
                        <span class="text-lg font-bold text-yellow-600">{{ planned_count }}</span>
                    </div>
                    {% if delayed_count > 0 %}
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                        <span class="text-gray-700 font-medium">Needs Attention</span>
                        <span class="text-lg font-bold text-red-600">{{ delayed_count }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Analytics Section Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Analytics & Insights</h2>
            <p class="text-gray-600 text-sm">Comprehensive data visualization for strategic decision-making</p>
        </div>

        <!-- Charts Section: 6 Charts in 2 Columns -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Chart 1: Project Status Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Project Status Distribution</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="projectStatus">
                        <label for="period-projectStatus" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-projectStatus" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="projectStatusChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Collaborative Projects per Barangay -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Projects per Barangay</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="collabBarangay">
                        <label for="period-collab" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-collab" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="collabBarangayChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Collaborative Projects per Status -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Projects per Status</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="collabStatus">
                        <label for="period-collab-status" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-collab-status" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="collabStatusChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Budget Utilization by Project -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-yellow-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Budget Utilization</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="budgetUtilization">
                        <label for="period-budgetUtilization" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-budgetUtilization" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="budgetUtilizationChart"></canvas>
                </div>
            </div>

            <!-- Chart 5: Cost Breakdown by Type -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Cost Breakdown by Type</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="costBreakdown">
                        <label for="period-costBreakdown" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-costBreakdown" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="costBreakdownChart"></canvas>
                </div>
            </div>

            <!-- Chart 6: Spending Trend -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-pink-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Spending Trend</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="monthlySpending">
                        <label for="period-monthlySpending" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-monthlySpending" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="monthlySpendingChart"></canvas>
                </div>
                <p class="text-sm text-gray-600 mt-2 font-medium" id="monthlySpendingSummary" aria-live="polite"></p>
            </div>

            <!-- Chart 7: Projects Created per Month -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-100 rounded-lg p-2">
                            <svg class="w-5 h-5 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Projects Created per Month</h3>
                    </div>
                    <div class="chart-period-wrap flex items-center gap-2 flex-shrink-0" data-chart-id="projectsPerMonth">
                        <label for="period-projectsPerMonth" class="text-xs font-semibold text-gray-500 uppercase tracking-wide whitespace-nowrap">Chart period</label>
                        <select id="period-projectsPerMonth" class="chart-period-select px-3 py-2 rounded-lg text-sm font-medium border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="week">Weekly</option>
                            <option value="month" selected>Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="projectsPerMonthChart"></canvas>
                </div>
                <p class="text-sm text-gray-600 mt-2 font-medium" id="projectsPerMonthSummary" aria-live="polite"></p>
            </div>
        </div>

    </div>
</div>

{{ collab_by_barangay|default:'{}'|json_script:"collab-barangay-data" }}
{{ collab_by_status|default:'{}'|json_script:"collab-status-data" }}
{{ projects_created_labels|default:"[]"|json_script:"projects-created-labels" }}
{{ projects_created_counts|default:"[]"|json_script:"projects-created-counts" }}
{{ status_counts|json_script:"status-counts-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calcPercent = (value, total) => total > 0 ? ((value / total) * 100) : 0;
        const fmtMoney = (value) => '₱' + Number(value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Card color palette (matches dashboard metric cards: Completed=green, In Progress=orange, Planned=purple, Delayed=red, Total=blue)
        const CARD = {
            green: 'rgba(46, 204, 113, 0.85)',   // #2ECC71 - Completed
            greenB: 'rgba(46, 204, 113, 1)',
            orange: 'rgba(243, 156, 18, 0.85)',  // #F39C12 - In Progress
            orangeB: 'rgba(243, 156, 18, 1)',
            purple: 'rgba(155, 89, 182, 0.85)',  // #9B59B6 - Planned
            purpleB: 'rgba(155, 89, 182, 1)',
            red: 'rgba(231, 76, 60, 0.85)',      // #E74C3C - Delayed
            redB: 'rgba(231, 76, 60, 1)',
            blue: 'rgba(59, 130, 246, 0.85)',    // Total / other
            blueB: 'rgba(59, 130, 246, 1)'
        };
        const STATUS_PALETTE_BG = [CARD.green, CARD.orange, CARD.purple, CARD.red];
        const STATUS_PALETTE_BD = [CARD.greenB, CARD.orangeB, CARD.purpleB, CARD.redB];
        const CHART_PALETTE_BG = [CARD.green, CARD.orange, CARD.purple, CARD.red, CARD.blue];
        const CHART_PALETTE_BD = [CARD.greenB, CARD.orangeB, CARD.purpleB, CARD.redB, CARD.blueB];
        function statusColorsByLabels(labels) {
            const map = { 'Completed': 0, 'In Progress': 1, 'Ongoing': 1, 'Planned': 2, 'Delayed': 3 };
            return labels.map(l => {
                const i = map[l] !== undefined ? map[l] : (labels.indexOf(l) % CHART_PALETTE_BG.length);
                return { bg: CHART_PALETTE_BG[i], bd: CHART_PALETTE_BD[i] };
            });
        }
        // Legend with inline data: "Label: value (pct%)" - pass useMoney and suffix via closure
        function createLegendWithData(useMoney, suffix, showPct) {
            if (showPct === undefined) showPct = true;
            return function(chart) {
                const ds = chart.data.datasets?.[0];
                const labels = chart.data.labels || [];
                const data = ds?.data || [];
                const total = data.reduce((a,b)=>a+b,0);
                const fmt = useMoney ? fmtMoney : (v => String(v));
                const bg = Array.isArray(ds?.backgroundColor) ? ds.backgroundColor : ds?.backgroundColor;
                const bc = Array.isArray(ds?.borderColor) ? ds.borderColor : ds?.borderColor;
                return labels.map((label, i) => {
                    const val = data[i] ?? 0;
                    const pct = showPct && total > 0 ? ' (' + calcPercent(val, total).toFixed(1) + '%)' : '';
                    return { text: label + ': ' + fmt(val) + (suffix || '') + pct, fillStyle: Array.isArray(bg) ? (bg[i] || 'rgba(0,0,0,0.1)') : (bg || 'rgba(0,0,0,0.1)'), strokeStyle: Array.isArray(bc) ? (bc[i] || '#666') : (bc || '#666'), lineWidth: 1, hidden: false, index: i };
                });
            };
        }

        // Chart period: each chart has its own period (no shared control)
        const chartPeriods = {
            projectStatus: 'month',
            collabBarangay: 'month',
            collabStatus: 'month',
            budgetUtilization: 'month',
            costBreakdown: 'month',
            monthlySpending: 'month',
            projectsPerMonth: 'month'
        };
        function getPeriod(chartId) { return chartPeriods[chartId] || 'month'; }
        function setSelectsForChart(chartId, period) {
            document.querySelectorAll('.chart-period-wrap[data-chart-id="' + chartId + '"]').forEach(wrap => {
                const sel = wrap.querySelector('.chart-period-select');
                if (sel && sel.value !== period) sel.value = period;
            });
        }
        function loadOneChart(chartId) {
            const period = getPeriod(chartId);
            if (chartId === 'projectStatus') {
                fetch(`{% url "dashboard_collab_analytics_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => {
                        try {
                            const statusData = data.status || {};
                            const order = ['Completed', 'In Progress', 'Ongoing', 'Planned', 'Delayed'];
                            const labels = [];
                            const values = [];
                            order.forEach(l => { if (statusData[l] !== undefined) { labels.push(l === 'Ongoing' ? 'In Progress' : l); values.push(statusData[l]); } });
                            Object.keys(statusData).filter(k => !order.includes(k)).forEach(k => { labels.push(k); values.push(statusData[k]); });
                            if (!labels.length) { labels.push('No Data'); values.push(0); }
                            const ctx = document.getElementById('projectStatusChart');
                            if (!ctx) return;
                            if (projectStatusChart) projectStatusChart.destroy();
                            const statusColors = statusColorsByLabels(labels);
                            projectStatusChart = new Chart(ctx.getContext('2d'), {
                                type: 'doughnut',
                                data: {
                                    labels,
                                    datasets: [{
                                        label: 'Projects',
                                        data: values,
                                        backgroundColor: statusColors.map(c => c.bg),
                                        borderColor: statusColors.map(c => c.bd),
                                        borderWidth: 2
                                    }]
                                },
                                options: { responsive: true, maintainAspectRatio: false, layout: { padding: { right: 30 } }, plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 16, generateLabels: createLegendWithData(false, '', true) } }, tooltip: { enabled: true, callbacks: { label: c => { const t = c.dataset.data.reduce((a,b)=>a+b,0); return c.label + ': ' + c.parsed + ' projects (' + (t ? ((c.parsed/t)*100).toFixed(1) : 0) + '%)'; } } } } }
                            });
                        } catch (e) { console.error('Error rendering project status chart:', e); }
                    }).catch(e => console.error('Error fetching project status data:', e));
            } else if (chartId === 'budgetUtilization') {
                fetch(`{% url "dashboard_budget_utilization_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => {
                        try {
                            const ctx = document.getElementById('budgetUtilizationChart').getContext('2d');
                            if (budgetUtilChart) budgetUtilChart.destroy();
                            const ds = (data.datasets || [])[0];
                            if (ds && ds.data) {
                                ds.backgroundColor = ds.data.map(d => d > 100 ? CARD.red : d > 80 ? CARD.orange : CARD.green);
                                ds.borderColor = ds.data.map(d => d > 100 ? CARD.redB : d > 80 ? CARD.orangeB : CARD.greenB);
                            }
                            budgetUtilChart = new Chart(ctx, {
                                type: 'bar', data: data,
                                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 30 } },
                                    scales: { x: { beginAtZero: true, title: { display: true, text: 'Budget Utilization (%)' }, ticks: { callback: v => v + '%' } } },
                                    plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12, generateLabels: createLegendWithData(false, '%', false) } }, tooltip: { enabled: true, callbacks: { title: c => (c[0] && c[0].label) ? c[0].label : '', label: c => 'Utilization: ' + c.parsed.x.toFixed(1) + '%' } } }
                                }
                            });
                        } catch (e) { console.error('Error rendering budget utilization chart:', e); }
                    }).catch(e => console.error('Error fetching budget utilization data:', e));
            } else if (chartId === 'collabBarangay') {
                fetch(`{% url "dashboard_collab_analytics_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => { try { drawCollabBarangayOnly(data.barangay || {}); } catch (e) { console.error('Error drawing collab barangay chart:', e); } })
                    .catch(e => console.error('Error fetching collab analytics:', e));
            } else if (chartId === 'collabStatus') {
                fetch(`{% url "dashboard_collab_analytics_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => { try { drawCollabStatusOnly(data.status || {}); } catch (e) { console.error('Error drawing collab status chart:', e); } })
                    .catch(e => console.error('Error fetching collab analytics:', e));
            } else if (chartId === 'costBreakdown') {
                fetch(`{% url "dashboard_cost_breakdown_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => {
                        try {
                            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
                            if (costBreakdownChart) costBreakdownChart.destroy();
                            const labels = data.labels || [];
                            const ds = (data.datasets || [])[0];
                            if (ds) {
                                ds.backgroundColor = labels.map((_, i) => CHART_PALETTE_BG[i % CHART_PALETTE_BG.length]);
                                ds.borderColor = labels.map((_, i) => CHART_PALETTE_BD[i % CHART_PALETTE_BD.length]);
                            }
                            costBreakdownChart = new Chart(ctx, {
                                type: 'pie', data: data,
                                options: { responsive: true, maintainAspectRatio: false, layout: { padding: { right: 30 } }, plugins: {
                                    legend: { position: 'right', labels: { boxWidth: 12, padding: 16, generateLabels: createLegendWithData(true, '', true) } },
                                    tooltip: { enabled: true, callbacks: { label: c => { const t = c.dataset.data.reduce((a,b)=>a+b,0); return c.label + ': ' + fmtMoney(c.parsed) + ' (' + calcPercent(c.parsed, t).toFixed(1) + '%)'; } } }
                                } }
                            });
                        } catch (e) { console.error('Error rendering cost breakdown chart:', e); }
                    }).catch(e => console.error('Error fetching cost breakdown data:', e));
            } else if (chartId === 'monthlySpending') {
                fetch(`{% url "dashboard_monthly_spending_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => {
                        try {
                            const ctx = document.getElementById('monthlySpendingChart').getContext('2d');
                            if (spendingChart) spendingChart.destroy();
                            const ds = (data.datasets || []).map(d => ({ ...d, fill: true, tension: 0.4, pointRadius: 4 }));
                            spendingChart = new Chart(ctx, {
                                type: 'line', data: { ...data, datasets: ds.length ? ds : data.datasets },
                                options: { responsive: true, maintainAspectRatio: false, layout: { padding: { right: 30 } },
                                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Spending (₱)' }, ticks: { callback: v => '₱' + Number(v).toLocaleString('en-US') } } },
                                    plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12 } }, tooltip: { enabled: true, callbacks: { label: c => c.dataset.label + ': ' + fmtMoney(c.parsed.y) } } }
                                }
                            });
                        } catch (e) { console.error('Error rendering spending chart:', e); }
                    }).catch(e => console.error('Error fetching spending data:', e));
            } else if (chartId === 'projectsPerMonth') {
                fetch(`{% url "dashboard_projects_created_data" %}?period=${encodeURIComponent(period)}`)
                    .then(r => r.json())
                    .then(data => {
                        try {
                            const ctx = document.getElementById('projectsPerMonthChart').getContext('2d');
                            if (projectsPerMonthChart) projectsPerMonthChart.destroy();
                            const pmDatasets = (data.datasets || [{ label: 'Projects Created', data: [] }]).map((d,i) => ({
                                ...d, backgroundColor: CARD.blue, borderColor: CARD.blueB, borderWidth: 1, borderRadius: 6
                            }));
                            projectsPerMonthChart = new Chart(ctx, {
                                type: 'bar',
                                data: { labels: data.labels || [], datasets: pmDatasets },
                                options: { responsive: true, maintainAspectRatio: false, layout: { padding: { right: 30 } },
                                    plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12 } }, tooltip: { enabled: true, callbacks: { label: c => (c.dataset.label || 'Projects') + ': ' + c.parsed.y } } },
                                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                                }
                            });
                        } catch (e) { console.error('Error rendering projects per month chart:', e); }
                    }).catch(e => console.error('Error fetching projects created data:', e));
            }
        }
        document.querySelectorAll('.chart-period-wrap').forEach(wrap => {
            const chartId = wrap.getAttribute('data-chart-id');
            if (!chartId) return;
            const sel = wrap.querySelector('.chart-period-select');
            if (!sel) return;
            sel.value = getPeriod(chartId);
            sel.addEventListener('change', function() {
                const period = this.value || 'month';
                chartPeriods[chartId] = period;
                setSelectsForChart(chartId, period);
                loadOneChart(chartId);
            });
        });

        // Chart instances to avoid overlap on refresh
        let projectStatusChart = null;
        let budgetUtilChart = null;
        let costBreakdownChart = null;
        let spendingChart = null;
        let projectsPerMonthChart = null;
        let collabBarangayChart = null;
        let collabStatusChart = null;

        // Chart 1: Overall Status Distribution (doughnut)
        const statusCtx = document.getElementById('projectStatusChart').getContext('2d');
        const statusLabels = ['Completed', 'In Progress', 'Planned', 'Delayed'];
        const statusCounts = JSON.parse(document.getElementById('status-counts-data').textContent);
        const statusTotal = statusCounts.reduce((a, b) => a + b, 0);
        if (projectStatusChart) projectStatusChart.destroy();
        projectStatusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Projects',
                    data: statusCounts,
                    backgroundColor: STATUS_PALETTE_BG,
                    borderColor: STATUS_PALETTE_BD,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { right: 30 } },
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, padding: 16, generateLabels: createLegendWithData(false, '', true) } },
                    tooltip: { enabled: true, callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const pct = calcPercent(value, statusTotal).toFixed(1);
                            return `${label}: ${value} projects (${pct}%)`;
                        }
                    } }
                }
            }
        });

        // Helpers so each chart-period control only affects its own chart
        function drawCollabBarangayOnly(barangayData) {
            const barCtx = document.getElementById('collabBarangayChart');
            if (!barCtx) return;
            if (collabBarangayChart) { collabBarangayChart.destroy(); collabBarangayChart = null; }
            const barKeys = Object.keys(barangayData || {});
            const barVals = Object.values(barangayData || {});
            if (!barKeys.length) {
                collabBarangayChart = new Chart(barCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'Projects',
                            data: [0],
                            backgroundColor: CARD.blue,
                            borderColor: CARD.blueB,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12, generateLabels: createLegendWithData(false, '', true) } }, tooltip: { enabled: true, callbacks: { label: c => 'Projects: ' + c.parsed.x } } },
                        scales: { x: { beginAtZero: true, stepSize: 1 } }
                    }
                });
                return;
            }
            collabBarangayChart = new Chart(barCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: barKeys,
                    datasets: [{
                        label: 'Projects',
                        data: barVals,
                        backgroundColor: barKeys.map((_, i) => CHART_PALETTE_BG[i % CHART_PALETTE_BG.length]),
                        borderColor: barKeys.map((_, i) => CHART_PALETTE_BD[i % CHART_PALETTE_BD.length]),
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 30 } },
                        plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 12, padding: 12, generateLabels: createLegendWithData(false, '', true) } }, tooltip: { enabled: true, callbacks: { label: c => c.label + ': ' + c.parsed.x + ' projects' } } },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function drawCollabStatusOnly(statusData) {
            const statusCtx2 = document.getElementById('collabStatusChart');
            if (!statusCtx2) return;
            if (collabStatusChart) { collabStatusChart.destroy(); collabStatusChart = null; }
            const statusKeys = Object.keys(statusData || {});
            const statusVals = Object.values(statusData || {});
            if (!statusKeys.length) {
                collabStatusChart = new Chart(statusCtx2.getContext('2d'), {
                    type: 'polarArea',
                    data: {
                        labels: ['No Data'],
                        datasets: [{
                            label: 'Projects',
                            data: [0],
                            backgroundColor: [CARD.blue],
                            borderColor: [CARD.blueB],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 12, generateLabels: createLegendWithData(false, '', true) } }, tooltip: { enabled: true, callbacks: { label: c => 'Projects: ' + c.parsed } } } }
                });
                return;
            }
            const statusColorMap = statusColorsByLabels(statusKeys);
            collabStatusChart = new Chart(statusCtx2.getContext('2d'), {
                type: 'polarArea',
                data: {
                    labels: statusKeys,
                    datasets: [{
                        label: 'Projects',
                        data: statusVals,
                        backgroundColor: statusColorMap.map(c => c.bg),
                        borderColor: statusColorMap.map(c => c.bd),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 30 } },
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 16, generateLabels: createLegendWithData(false, '', true) } },
                        tooltip: { enabled: true, callbacks: {
                            label: function(c) {
                                const t = c.dataset.data.reduce((a,b)=>a+b,0);
                                const pct = t ? ((c.parsed / t) * 100).toFixed(1) : 0;
                                return c.label + ': ' + c.parsed + ' (' + pct + '%)';
                            }
                        } }
                    }
                }
            });
        }

        // Initial load: load each period-driven chart with its own period (default 'month')
        function loadPeriodCharts() {
            [
                'projectStatus',
                'collabBarangay',
                'collabStatus',
                'budgetUtilization',
                'costBreakdown',
                'monthlySpending',
                'projectsPerMonth'
            ].forEach(loadOneChart);
        }

        loadPeriodCharts();
    });

</script>
{% endblock %} 