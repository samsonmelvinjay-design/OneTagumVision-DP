{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 lg:px-8">
        <!-- Header Section with Welcome -->
        <div class="mb-8">
            <div class="mb-6">
                <!-- Welcome Section -->
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                        Welcome back, <span class="text-blue-600">{{ user.get_full_name|default:user.username }}</span>!
                    </h1>
                    <p class="text-gray-600 text-sm lg:text-base">Here's an overview of your projects and city development progress</p>
                </div>
            </div>
        </div>

        <!-- Key Metrics Cards - Modern Grid Layout -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 lg:gap-6 mb-8">
            <!-- Total Projects Card -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-total-projects">{{ project_count }}</div>
                <div class="text-blue-100 text-sm font-medium">Total Projects</div>
            </div>

            <!-- Completed Projects Card -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-completed">{{ completed_count }}</div>
                <div class="text-green-100 text-sm font-medium">Completed</div>
            </div>

            <!-- In Progress Card -->
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-in-progress">{{ in_progress_count }}</div>
                <div class="text-yellow-100 text-sm font-medium">In Progress</div>
            </div>

            <!-- Planned Projects Card -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-planned">{{ planned_count }}</div>
                <div class="text-purple-100 text-sm font-medium">Planned</div>
            </div>

            <!-- Delayed Projects Card -->
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-xl">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold mb-1" id="card-delayed">{{ delayed_count }}</div>
                <div class="text-red-100 text-sm font-medium">Delayed</div>
            </div>
        </div>

        <!-- Recent Projects and Quick Stats Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Recent Projects Section -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Recent Projects
                    </h2>
                    <a href="{% url 'project_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">View All →</a>
                </div>
                <div class="space-y-3">
                    {% for project in recent_projects %}
                    <a href="{% url 'monitoring_project_detail' project.id %}" class="block bg-gradient-to-r from-gray-50 to-white rounded-lg p-4 border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all duration-200 group">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors mb-1">{{ project.name }}</h3>
                                <div class="flex items-center gap-3 text-sm text-gray-600">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        {{ project.barangay|default:"N/A" }}
                                    </span>
                                    <span class="text-gray-400">•</span>
                                    <span>{{ project.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold {% if project.status == 'completed' %}bg-green-100 text-green-700{% elif project.status == 'in_progress' or project.status == 'ongoing' %}bg-blue-100 text-blue-700{% elif project.status == 'planned' or project.status == 'pending' %}bg-yellow-100 text-yellow-700{% elif project.status == 'delayed' %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ project.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>No recent projects</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Stats Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Quick Stats
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <span class="text-gray-700 font-medium">Completion Rate</span>
                        <span class="text-lg font-bold text-blue-600">{{ completion_rate }}%</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <span class="text-gray-700 font-medium">Active Projects</span>
                        <span class="text-lg font-bold text-green-600">{{ in_progress_count }}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                        <span class="text-gray-700 font-medium">Pending</span>
                        <span class="text-lg font-bold text-yellow-600">{{ planned_count }}</span>
                    </div>
                    {% if delayed_count > 0 %}
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                        <span class="text-gray-700 font-medium">Needs Attention</span>
                        <span class="text-lg font-bold text-red-600">{{ delayed_count }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Analytics Section Header -->
        <div class="mb-6 flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Analytics & Insights</h2>
                <p class="text-gray-600 text-sm">Comprehensive data visualization for strategic decision-making</p>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl px-4 py-3 shadow-sm">
                <label for="chart-period-select" class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wide">Chart period</label>
                <select id="chart-period-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="week">Weekly</option>
                    <option value="month" selected>Monthly</option>
                    <option value="year">Yearly</option>
                </select>
                <p class="text-[11px] text-gray-500 mt-1">Applies to Spending Trend and Cost Breakdown charts</p>
            </div>
        </div>

        <!-- Charts Section: 6 Charts in 2 Columns -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Chart 1: Project Status Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-blue-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Project Status Distribution</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="projectStatusChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Collaborative Projects per Barangay -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-green-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Projects per Barangay</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="collabBarangayChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Collaborative Projects per Status -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-purple-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Projects per Status</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="collabStatusChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Budget Utilization by Project -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-yellow-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Budget Utilization</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="budgetUtilizationChart"></canvas>
                </div>
            </div>

            <!-- Chart 5: Cost Breakdown by Type -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-indigo-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Cost Breakdown by Type</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="costBreakdownChart"></canvas>
                </div>
            </div>

            <!-- Chart 6: Spending Trend -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-pink-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Spending Trend</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="monthlySpendingChart"></canvas>
                </div>
            </div>

            <!-- Chart 7: Projects Created per Month -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-slate-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Projects Created per Month</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="projectsPerMonthChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Zone Analytics Section -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Zoning Analytics</h2>
            <p class="text-gray-600 text-sm">Strategic insights based on zoning classifications</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Chart 7: Projects by Zone Type -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-teal-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A2 2 0 013 15.382V5.618a2 2 0 011.553-1.948L9 2m0 0l6 2.67M9 2v18m6-15.33l5.447 2.724A2 2 0 0121 8.618v9.764a2 2 0 01-1.553 1.948L15 22m0 0V4.67"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Projects by Zone Type</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="projectsByZoneChart"></canvas>
                </div>
            </div>

            <!-- Chart 8: Zone Cost Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow duration-200">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-cyan-100 rounded-lg p-2">
                        <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Cost Distribution by Zone</h3>
                </div>
                <div class="chart-container" style="position: relative; height:300px; width:100%">
                    <canvas id="zoneCostChart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

{{ collab_by_barangay|default:'{}'|json_script:"collab-barangay-data" }}
{{ collab_by_status|default:'{}'|json_script:"collab-status-data" }}
{{ projects_created_labels|default:"[]"|json_script:"projects-created-labels" }}
{{ projects_created_counts|default:"[]"|json_script:"projects-created-counts" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calcPercent = (value, total) => total > 0 ? ((value / total) * 100) : 0;
        const fmtMoney = (value) => '₱' + Number(value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Chart period (for Spending + Cost Breakdown)
        const periodSelect = document.getElementById('chart-period-select');
        const getPeriod = () => (periodSelect ? periodSelect.value : 'month');

        // Chart instances to avoid overlap on refresh
        let budgetUtilChart = null;
        let costBreakdownChart = null;
        let spendingChart = null;
        let projectsPerMonthChart = null;

        // Chart 1: Overall Status Distribution (doughnut)
        const statusCtx = document.getElementById('projectStatusChart').getContext('2d');
        const statusLabels = ['Completed', 'In Progress', 'Planned', 'Delayed'];
        const statusCounts = [{{ completed_count }}, {{ in_progress_count }}, {{ planned_count }}, {{ delayed_count }}];
        const statusTotal = statusCounts.reduce((a, b) => a + b, 0);
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Projects',
                    data: statusCounts,
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',   // green-500 with alpha
                        'rgba(59, 130, 246, 0.8)',  // blue-500 with alpha
                        'rgba(251, 191, 36, 0.8)',  // yellow-500 with alpha
                        'rgba(239, 68, 68, 0.8)'    // red-500 with alpha
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(251, 191, 36, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const pct = calcPercent(value, statusTotal).toFixed(1);
                                return `${label}: ${value} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Collaborative Projects per Barangay Chart
        const collabBarangayElem = document.getElementById('collab-barangay-data');
        if (collabBarangayElem) {
          const collabBarangayLabels = JSON.parse(collabBarangayElem.textContent);
          const collabBarangayData = Object.values(collabBarangayLabels);
          const collabBarangayKeys = Object.keys(collabBarangayLabels);
          if (collabBarangayKeys.length > 0) {
            const collabBarangayCtx = document.getElementById('collabBarangayChart').getContext('2d');
            new Chart(collabBarangayCtx, {
              type: 'bar',
              data: {
                labels: collabBarangayKeys,
                datasets: [{
                  label: 'Collaborative Projects',
                  data: collabBarangayData,
                  backgroundColor: 'rgba(59, 130, 246, 0.7)',
                  borderColor: 'rgba(59, 130, 246, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, stepSize: 1 } }
              }
            });
          } else {
            document.getElementById('collabBarangayChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">No collaborative projects found.</div>';
          }
        }

        // Collaborative Projects per Status Chart
        const collabStatusElem = document.getElementById('collab-status-data');
        if (collabStatusElem) {
          const collabStatusLabels = JSON.parse(collabStatusElem.textContent);
          const collabStatusData = Object.values(collabStatusLabels);
          const collabStatusKeys = Object.keys(collabStatusLabels);
          if (collabStatusKeys.length > 0) {
            const collabStatusCtx = document.getElementById('collabStatusChart').getContext('2d');
            new Chart(collabStatusCtx, {
              type: 'pie',
              data: {
                labels: collabStatusKeys,
                datasets: [{
                  label: 'Collaborative Projects',
                  data: collabStatusData,
                  backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(34, 197, 94, 0.7)',
                    'rgba(251, 191, 36, 0.7)',
                    'rgba(139, 92, 246, 0.7)',
                    'rgba(239, 68, 68, 0.7)'
                  ],
                  borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(34, 197, 94, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(239, 68, 68, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
              }
            });
          } else {
            document.getElementById('collabStatusChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">No collaborative projects found.</div>';
          }
        }

        // Chart 4: Budget Utilization by Project
        fetch('{% url "dashboard_budget_utilization_data" %}')
         .then(response => response.json())
         .then(data => {
             try {
                 const ctx = document.getElementById('budgetUtilizationChart').getContext('2d');
                 if (budgetUtilChart) budgetUtilChart.destroy();
                 budgetUtilChart = new Chart(ctx, {
                     type: 'bar',
                     data: data,
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         indexAxis: 'y',
                         scales: {
                             x: {
                                 beginAtZero: true,
                                 title: {
                                     display: true,
                                     text: 'Budget Utilization (%)'
                                 },
                                 ticks: {
                                     callback: function(value) {
                                         return value + '%';
                                     }
                                 }
                             }
                         },
                         plugins: {
                             legend: {
                                 display: false
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         return 'Utilization: ' + context.parsed.x.toFixed(1) + '%';
                                     }
                                 }
                             }
                         }
                     }
                 });
             } catch (error) {
                 console.error('Error rendering budget utilization chart:', error);
                 document.getElementById('budgetUtilizationChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
             }
         })
         .catch(error => {
             console.error('Error fetching budget utilization data:', error);
             document.getElementById('budgetUtilizationChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
         });

        // Chart 5: Cost Breakdown by Type
        async function loadPeriodCharts() {
            const period = getPeriod();

            // Cost Breakdown
            fetch(`{% url "dashboard_cost_breakdown_data" %}?period=${encodeURIComponent(period)}`)
             .then(response => response.json())
             .then(data => {
                 try {
                     const ctx = document.getElementById('costBreakdownChart').getContext('2d');
                     if (costBreakdownChart) costBreakdownChart.destroy();
                     costBreakdownChart = new Chart(ctx, {
                         type: 'doughnut',
                         data: data,
                         options: {
                             responsive: true,
                             maintainAspectRatio: false,
                             plugins: {
                                 legend: { position: 'bottom' },
                                 tooltip: {
                                     callbacks: {
                                         label: function(context) {
                                             const label = context.label || '';
                                             const value = context.parsed || 0;
                                             const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                             const percentage = calcPercent(value, total).toFixed(1);
                                             return `${label}: ${fmtMoney(value)} (${percentage}%)`;
                                         }
                                     }
                                 }
                             }
                         }
                     });
                 } catch (error) {
                     console.error('Error rendering cost breakdown chart:', error);
                     document.getElementById('costBreakdownChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
                 }
             })
             .catch(error => {
                 console.error('Error fetching cost breakdown data:', error);
                 document.getElementById('costBreakdownChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
             });

            // Spending Trend
            fetch(`{% url "dashboard_monthly_spending_data" %}?period=${encodeURIComponent(period)}`)
             .then(response => response.json())
             .then(data => {
                 try {
                     const ctx = document.getElementById('monthlySpendingChart').getContext('2d');
                     if (spendingChart) spendingChart.destroy();
                     spendingChart = new Chart(ctx, {
                         type: 'line',
                         data: data,
                         options: {
                             responsive: true,
                             maintainAspectRatio: false,
                             scales: {
                                 y: {
                                     beginAtZero: true,
                                     title: { display: true, text: 'Spending (₱)' },
                                     ticks: {
                                         callback: function(value) {
                                             return '₱' + Number(value).toLocaleString('en-US');
                                         }
                                     }
                                 }
                             },
                             plugins: {
                                 legend: { display: true, position: 'top' },
                                 tooltip: {
                                     callbacks: {
                                         label: function(context) {
                                             return `Spending: ${fmtMoney(context.parsed.y)}`;
                                         }
                                     }
                                 }
                             }
                         }
                     });
                 } catch (error) {
                     console.error('Error rendering spending chart:', error);
                     document.getElementById('monthlySpendingChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
                 }
             })
             .catch(error => {
                 console.error('Error fetching spending data:', error);
                 document.getElementById('monthlySpendingChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
             });
        }

        loadPeriodCharts();
        if (periodSelect) {
            periodSelect.addEventListener('change', loadPeriodCharts);
        }

        // Chart 7: Projects Created per Month (local data)
        const createdLabelsEl = document.getElementById('projects-created-labels');
        const createdCountsEl = document.getElementById('projects-created-counts');
        if (createdLabelsEl && createdCountsEl) {
            const labels = JSON.parse(createdLabelsEl.textContent || '[]');
            const counts = JSON.parse(createdCountsEl.textContent || '[]');
            const ctx = document.getElementById('projectsPerMonthChart').getContext('2d');
            if (projectsPerMonthChart) projectsPerMonthChart.destroy();
            projectsPerMonthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Projects Created',
                        data: counts,
                        backgroundColor: 'rgba(100, 116, 139, 0.7)',
                        borderColor: 'rgba(100, 116, 139, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // Phase 6: Chart 7 - Projects by Zone Type
        const projectsByZoneChartEl = document.getElementById('projectsByZoneChart');
        if (projectsByZoneChartEl) {
            fetch('/projeng/api/zone-analytics/')
             .then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 return response.json();
             })
             .then(data => {
                 try {
                     const ctx = projectsByZoneChartEl.getContext('2d');
                     const zones = data.zones || [];
                     
                     if (zones.length === 0) {
                         projectsByZoneChartEl.parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">No zone data available</div>';
                         return;
                     }
                     
                     const labels = zones.map(z => z.zone_type);
                     const projectCounts = zones.map(z => z.total_projects);
                 
                 // Zone colors matching the map (updated to standard urban planning colors)
                 const zoneColors = {
                     // Residential - Yellow/Beige tones
                     'R-1': 'rgba(255, 249, 196, 0.8)', // Very light yellow
                     'R-2': 'rgba(255, 245, 157, 0.8)', // Light yellow
                     'R-3': 'rgba(253, 216, 53, 0.8)', // Yellow
                     'SHZ': 'rgba(197, 225, 165, 0.8)', // Light green-yellow
                     // Commercial - Orange tones
                     'C-1': 'rgba(255, 111, 0, 0.8)', // Deep orange
                     'C-2': 'rgba(255, 183, 77, 0.8)', // Light orange
                     // Industrial - Purple tones
                     'I-1': 'rgba(186, 104, 200, 0.8)', // Purple
                     'I-2': 'rgba(206, 147, 216, 0.8)', // Light purple
                     'AGRO': 'rgba(156, 204, 101, 0.8)', // Light green
                     // Institutional
                     'INS-1': 'rgba(121, 134, 203, 0.8)', // Indigo/purple-blue
                     // Open Space/Parks
                     'PARKS': 'rgba(102, 187, 106, 0.8)', // Medium green
                     'AGRICULTURAL': 'rgba(129, 199, 132, 0.8)', // Green
                     'ECO-TOURISM': 'rgba(38, 166, 154, 0.8)', // Teal
                     // Special Uses
                     'SPECIAL': 'rgba(161, 136, 127, 0.8)', // Brown
                 };
                 
                 const backgroundColors = labels.map(z => zoneColors[z] || 'rgba(200, 200, 200, 0.8)');
                 
                 new Chart(ctx, {
                     type: 'bar',
                     data: {
                         labels: labels,
                         datasets: [{
                             label: 'Number of Projects',
                             data: projectCounts,
                             backgroundColor: backgroundColors,
                             borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                             borderWidth: 1
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: {
                                 beginAtZero: true,
                                 ticks: {
                                     stepSize: 1
                                 }
                             }
                         },
                         plugins: {
                             legend: {
                                 display: false
                             },
                             tooltip: {
                                 callbacks: {
                                     title: function(context) {
                                         const zone = zones[context[0].dataIndex];
                                         return zone.display_name || zone.zone_type;
                                     },
                                     label: function(context) {
                                         const zone = zones[context.dataIndex];
                                         return [
                                             `Projects: ${context.parsed.y}`,
                                             `Completed: ${zone.completed}`,
                                             `In Progress: ${zone.in_progress}`,
                                             `Planned: ${zone.planned}`
                                         ];
                                     }
                                 }
                             }
                         }
                     }
                 });
             } catch (error) {
                 console.error('Error rendering projects by zone chart:', error);
                 document.getElementById('projectsByZoneChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
             }
             })
             .catch(error => {
                 console.error('Error fetching zone analytics data:', error);
                 if (projectsByZoneChartEl && projectsByZoneChartEl.parentElement) {
                     projectsByZoneChartEl.parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
                 }
             });
        } else {
            console.warn('projectsByZoneChart element not found');
        }

        // Phase 6: Chart 8 - Zone Cost Distribution
        const zoneCostChartEl = document.getElementById('zoneCostChart');
        if (zoneCostChartEl) {
            fetch('/projeng/api/zone-analytics/')
             .then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 return response.json();
             })
             .then(data => {
                 try {
                     const ctx = zoneCostChartEl.getContext('2d');
                     const zones = data.zones || [];
                     
                     // Filter zones with costs > 0
                     const zonesWithCosts = zones.filter(z => z.total_cost > 0);
                     
                     if (zonesWithCosts.length === 0) {
                         zoneCostChartEl.parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">No cost data available</div>';
                         return;
                     }
                 
                 const labels = zonesWithCosts.map(z => z.zone_type);
                 const costs = zonesWithCosts.map(z => z.total_cost);
                 
                 // Zone colors matching the map (updated to standard urban planning colors)
                 const zoneColors = {
                     // Residential - Yellow/Beige tones
                     'R-1': 'rgba(255, 249, 196, 0.8)', // Very light yellow
                     'R-2': 'rgba(255, 245, 157, 0.8)', // Light yellow
                     'R-3': 'rgba(253, 216, 53, 0.8)', // Yellow
                     'SHZ': 'rgba(197, 225, 165, 0.8)', // Light green-yellow
                     // Commercial - Orange tones
                     'C-1': 'rgba(255, 111, 0, 0.8)', // Deep orange
                     'C-2': 'rgba(255, 183, 77, 0.8)', // Light orange
                     // Industrial - Purple tones
                     'I-1': 'rgba(186, 104, 200, 0.8)', // Purple
                     'I-2': 'rgba(206, 147, 216, 0.8)', // Light purple
                     'AGRO': 'rgba(156, 204, 101, 0.8)', // Light green
                     // Institutional
                     'INS-1': 'rgba(121, 134, 203, 0.8)', // Indigo/purple-blue
                     // Open Space/Parks
                     'PARKS': 'rgba(102, 187, 106, 0.8)', // Medium green
                     'AGRICULTURAL': 'rgba(129, 199, 132, 0.8)', // Green
                     'ECO-TOURISM': 'rgba(38, 166, 154, 0.8)', // Teal
                     // Special Uses
                     'SPECIAL': 'rgba(161, 136, 127, 0.8)', // Brown
                 };
                 
                 const backgroundColors = labels.map(z => zoneColors[z] || 'rgba(200, 200, 200, 0.8)');
                 
                 new Chart(ctx, {
                     type: 'doughnut',
                     data: {
                         labels: labels,
                         datasets: [{
                             label: 'Total Cost (₱)',
                             data: costs,
                             backgroundColor: backgroundColors,
                             borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
                             borderWidth: 2
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 display: true,
                                 position: 'right'
                             },
                             tooltip: {
                                 callbacks: {
                                     title: function(context) {
                                         const zone = zonesWithCosts[context[0].dataIndex];
                                         return zone.display_name || zone.zone_type;
                                     },
                                     label: function(context) {
                                         const value = context.parsed;
                                         const percentage = ((value / costs.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                         return `Cost: ₱${value.toLocaleString('en-US')} (${percentage}%)`;
                                     }
                                 }
                             }
                         }
                     }
                 });
             } catch (error) {
                 console.error('Error rendering zone cost chart:', error);
                 document.getElementById('zoneCostChart').parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
             }
                 })
                 .catch(error => {
                     console.error('Error fetching zone analytics data:', error);
                     if (zoneCostChartEl && zoneCostChartEl.parentElement) {
                         zoneCostChartEl.parentElement.innerHTML = '<div class="text-gray-500 text-center mt-8">Error loading chart data</div>';
                     }
                 });
        } else {
            console.warn('zoneCostChart element not found');
        }
    });

</script>
{% endblock %} 