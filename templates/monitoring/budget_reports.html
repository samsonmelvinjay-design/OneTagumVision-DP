{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8 bg-gray-100 min-h-screen">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Budget Reports</h1>
    <div class="flex justify-end mb-6">
      <div class="relative inline-block text-left">
        <button id="export-dropdown-btn" type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-blue-600 text-white font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-haspopup="true" aria-expanded="true">
          Export
          <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
        <div id="export-dropdown-menu" class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50" role="menu" aria-orientation="vertical" aria-labelledby="export-dropdown-btn">
          <div class="py-1" role="none">
            <a href="?export=csv" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Export CSV</a>
            <a href="?export=excel" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Export Excel</a>
            <a href="?export=pdf" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Export PDF</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6 mb-8 overflow-x-auto">
    <table class="w-full min-w-[900px] divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">PRN #</th>
          <th class="px-3 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Project</th>
          <th class="px-3 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider">Barangay</th>
          <th class="px-3 py-3 text-right font-semibold text-gray-700 uppercase tracking-wider">Budget</th>
          <th class="px-3 py-3 text-right font-semibold text-gray-700 uppercase tracking-wider">Spent</th>
          <th class="px-3 py-3 text-right font-semibold text-gray-700 uppercase tracking-wider">Remaining</th>
          <th class="px-3 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Utilization</th>
          <th class="px-3 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Over/Under</th>
          <th class="px-3 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Status</th>
          <th class="px-3 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Cost Breakdown</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for p in project_data %}
        <tr>
          <td class="px-3 py-3">{{ p.prn }}</td>
          <td class="px-3 py-3 font-semibold text-blue-900">{{ p.name }}</td>
          <td class="px-3 py-3">{{ p.barangay }}</td>
          <td class="px-3 py-3 text-right">₱{{ p.budget|floatformat:2 }}</td>
          <td class="px-3 py-3 text-right">₱{{ p.spent|floatformat:2 }}</td>
          <td class="px-3 py-3 text-right">₱{{ p.remaining|floatformat:2 }}</td>
          <td class="px-3 py-3 text-center">{{ p.utilization|floatformat:1 }}%</td>
          <td class="px-3 py-3 text-center">
            {% if p.over_under == 'Over' %}
              <span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 font-semibold">Over</span>
            {% else %}
              <span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-700 font-semibold">Under</span>
            {% endif %}
          </td>
          <td class="px-3 py-3 text-center">{{ p.status|title }}</td>
          <td class="px-3 py-3 text-center">
            {% for c in p.cost_breakdown %}
              <div>{{ c.cost_type|title }}: ₱{{ c.total|floatformat:2 }}</div>
            {% empty %}
              <div class="text-gray-400">No costs</div>
            {% endfor %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center py-6 text-gray-400">No projects found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <div class="bg-white rounded-xl shadow p-6 h-80 flex flex-col">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Budget Utilization per Project</h2>
      <canvas id="budgetUtilizationChart" class="flex-1"></canvas>
    </div>
    <div class="bg-white rounded-xl shadow p-6 h-80 flex flex-col">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Over/Under Budget Status</h2>
      <canvas id="overUnderChart" class="flex-1"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Budget Utilization Bar Chart
    const projNames = {{ project_names|safe }};
    const utilizations = {{ utilizations|safe }};
    const ctxUtil = document.getElementById('budgetUtilizationChart').getContext('2d');
    new Chart(ctxUtil, {
      type: 'bar',
      data: {
        labels: projNames,
        datasets: [{
          label: 'Utilization %',
          data: utilizations,
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 150 } }
      }
    });

    // Over/Under Budget Pie Chart
    const overCount = {{ over_count }};
    const underCount = {{ under_count }};
    const ctxOU = document.getElementById('overUnderChart').getContext('2d');
    new Chart(ctxOU, {
      type: 'pie',
      data: {
        labels: ['Over Budget', 'Under Budget'],
        datasets: [{
          data: [overCount, underCount],
          backgroundColor: [
            'rgba(239, 68, 68, 0.7)',
            'rgba(34, 197, 94, 0.7)'
          ],
          borderColor: [
            'rgba(239, 68, 68, 1)',
            'rgba(34, 197, 94, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });

    const btn = document.getElementById('export-dropdown-btn');
    const menu = document.getElementById('export-dropdown-menu');
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });
    document.addEventListener('click', function() {
      menu.classList.add('hidden');
    });
  });
</script>
{% endblock %} 