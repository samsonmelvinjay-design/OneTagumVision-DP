{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if user_role == 'project_engineer' %}
        My Projects Analytics
    {% else %}
        All Projects Analytics
    {% endif %}
{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                {% if user_role == 'project_engineer' %}
                    My Projects Analytics
                {% else %}
                    All Projects Analytics
                {% endif %}
            </h1>
            <p class="text-gray-600 text-sm lg:text-base">
                {% if user_role == 'project_engineer' %}
                    Track and manage your assigned projects
                {% else %}
                    Monitor and analyze all projects across the system
                {% endif %}
            </p>
        </div>

        <!-- Stats Cards - Modern Gradient Design -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 lg:gap-4 mb-6">
            <div id="card-all" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if not status_filter %}active{% endif %}" onclick="filterByStatus('all', this)">
                <div class="flex items-center justify-between mb-3">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold mb-1">{{ total_projects }}</div>
                <div class="text-blue-100 text-xs font-medium">Total Projects</div>
            </div>
            
            <div id="card-completed" class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if status_filter == 'completed' %}active{% endif %}" onclick="filterByStatus('completed', this)">
                <div class="flex items-center justify-between mb-3">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold mb-1">{{ completed_projects }}</div>
                <div class="text-green-100 text-xs font-medium">Completed</div>
            </div>
            
            <div id="card-inprogress" class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if status_filter == 'in_progress' %}active{% endif %}" onclick="filterByStatus('in_progress', this)">
                <div class="flex items-center justify-between mb-3">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold mb-1">{{ ongoing_projects }}</div>
                <div class="text-yellow-100 text-xs font-medium">In Progress</div>
            </div>
            
            <div id="card-planned" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if status_filter == 'planned' %}active{% endif %}" onclick="filterByStatus('planned', this)">
                <div class="flex items-center justify-between mb-3">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold mb-1">{{ planned_projects }}</div>
                <div class="text-purple-100 text-xs font-medium">Planned</div>
            </div>
            
            <div id="card-delayed" class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-md p-4 text-white transform transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if status_filter == 'delayed' %}active{% endif %}" onclick="filterByStatus('delayed', this)">
                <div class="flex items-center justify-between mb-3">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold mb-1">{{ delayed_projects }}</div>
                <div class="text-red-100 text-xs font-medium">Delayed</div>
            </div>
        </div>

        <!-- Projects Table Card -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Projects List
                    </h2>
                    <form id="filter-form" method="get" class="flex flex-wrap items-end gap-2">
                        <div class="flex-1 min-w-[200px]">
                            <input type="text" id="search-input" name="search" value="{{ search_query }}" placeholder="Search projects..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all">
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <select id="filter-barangay" name="barangay" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white transition-all">
                                <option value="">All Barangays</option>
                                <option value="Apokon" {% if barangay_filter == 'Apokon' %}selected{% endif %}>Apokon</option>
                                <option value="Bincungan" {% if barangay_filter == 'Bincungan' %}selected{% endif %}>Bincungan</option>
                                <option value="Busaon" {% if barangay_filter == 'Busaon' %}selected{% endif %}>Busaon</option>
                                <option value="Canocotan" {% if barangay_filter == 'Canocotan' %}selected{% endif %}>Canocotan</option>
                                <option value="Cuambogan" {% if barangay_filter == 'Cuambogan' %}selected{% endif %}>Cuambogan</option>
                                <option value="La Filipina" {% if barangay_filter == 'La Filipina' %}selected{% endif %}>La Filipina</option>
                                <option value="Liboganon" {% if barangay_filter == 'Liboganon' %}selected{% endif %}>Liboganon</option>
                                <option value="Madaum" {% if barangay_filter == 'Madaum' %}selected{% endif %}>Madaum</option>
                                <option value="Magdum" {% if barangay_filter == 'Magdum' %}selected{% endif %}>Magdum</option>
                                <option value="Magugpo East" {% if barangay_filter == 'Magugpo East' %}selected{% endif %}>Magugpo East</option>
                                <option value="Magugpo North" {% if barangay_filter == 'Magugpo North' %}selected{% endif %}>Magugpo North</option>
                                <option value="Magugpo Poblacion" {% if barangay_filter == 'Magugpo Poblacion' %}selected{% endif %}>Magugpo Poblacion</option>
                                <option value="Magugpo South" {% if barangay_filter == 'Magugpo South' %}selected{% endif %}>Magugpo South</option>
                                <option value="Magugpo West" {% if barangay_filter == 'Magugpo West' %}selected{% endif %}>Magugpo West</option>
                                <option value="Mankilam" {% if barangay_filter == 'Mankilam' %}selected{% endif %}>Mankilam</option>
                                <option value="New Balamban" {% if barangay_filter == 'New Balamban' %}selected{% endif %}>New Balamban</option>
                                <option value="Nueva Fuerza" {% if barangay_filter == 'Nueva Fuerza' %}selected{% endif %}>Nueva Fuerza</option>
                                <option value="Pagsabangan" {% if barangay_filter == 'Pagsabangan' %}selected{% endif %}>Pagsabangan</option>
                                <option value="Pandapan" {% if barangay_filter == 'Pandapan' %}selected{% endif %}>Pandapan</option>
                                <option value="San Agustin" {% if barangay_filter == 'San Agustin' %}selected{% endif %}>San Agustin</option>
                                <option value="San Isidro" {% if barangay_filter == 'San Isidro' %}selected{% endif %}>San Isidro</option>
                                <option value="San Miguel" {% if barangay_filter == 'San Miguel' %}selected{% endif %}>San Miguel</option>
                                <option value="Visayan Village" {% if barangay_filter == 'Visayan Village' %}selected{% endif %}>Visayan Village</option>
                            </select>
                        </div>
                        <a href="{% url 'head_engineer_analytics' %}" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition-all duration-200 text-sm whitespace-nowrap">
                            Clear
                        </a>
                    </form>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full min-w-[900px] divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Project Name</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Barangay</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Progress</th>
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Start Date</th>
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">End Date</th>
                            {% if user_role == 'head_engineer' %}
                            <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Assigned To</th>
                            {% endif %}
                            <th class="px-4 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="projects-table-body">
                        {% for project in projects %}
                        <tr class="hover:bg-blue-50 transition-colors duration-150">
                            <td class="px-4 py-4">
                                <div class="text-sm font-semibold text-gray-900">{{ project.name }}</div>
                                <div class="text-xs text-gray-500 font-mono mt-1">{{ project.prn|default:'—' }}</div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-700">
                                {{ project.barangay|default:'—' }}
                            </td>
                            <td class="px-4 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: {{ project.total_progress|default:0 }}%; min-width: {% if project.total_progress > 0 %}2px{% else %}0{% endif %}"></div>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-700 min-w-[45px]">{{ project.total_progress|default:0 }}%</span>
                                </div>
                            </td>
                            <td class="px-4 py-4 text-center">
                                {% if project.status == 'completed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Completed</span>
                                {% elif project.status == 'ongoing' or project.status == 'in_progress' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Ongoing</span>
                                {% elif project.status == 'planned' or project.status == 'pending' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700">Planned</span>
                                {% elif project.status == 'delayed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">Delayed</span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">{{ project.status_display }}</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600">
                                {{ project.start_date|default:'—' }}
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600">
                                {{ project.end_date|default:'—' }}
                            </td>
                            {% if user_role == 'head_engineer' %}
                            <td class="px-4 py-4 text-sm text-gray-600">
                                {% if project.assigned_to %}
                                    <div class="flex flex-wrap gap-1">
                                        {% for engineer in project.assigned_to %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700">{{ engineer }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                            </td>
                            {% endif %}
                            <td class="px-4 py-4 text-center">
                                {% if user_role == 'head_engineer' %}
                                    {% if project.id %}
                                        <a href="{% url 'monitoring_project_detail' project.id %}"
                                           class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 hover:shadow-lg">
                                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                           </svg>
                                           Timeline Report
                                        </a>
                                    {% else %}
                                        <span class="text-gray-400 text-sm">—</span>
                                    {% endif %}
                                {% elif user_role == 'project_engineer' %}
                                    <div class="flex items-center justify-center gap-2">
                                        <a href="javascript:void(0);" onclick="openProjectModal({{ project.id }})" class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </a>
                                        <a href="{% url 'project_update' project.id %}" class="p-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-all duration-200">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </a>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if user_role == 'head_engineer' %}8{% else %}7{% endif %}" class="text-center py-12">
                                <div class="flex flex-col items-center">
                                    <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-500 text-lg font-medium">No projects found</p>
                                    <p class="text-gray-400 text-sm mt-1">Try adjusting your filters</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-gray-700">
                        Showing <span class="font-semibold">{{ page_obj.start_index }}</span> to <span class="font-semibold">{{ page_obj.end_index }}</span> of <span class="font-semibold">{{ page_obj.paginator.count }}</span> projects
                    </div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if barangay_filter %}&barangay={{ barangay_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Previous
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                                Previous
                            </span>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span aria-current="page" class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-semibold text-blue-600">
                                    {{ num }}
                                </span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if barangay_filter %}&barangay={{ barangay_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    {{ num }}
                                </a>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if barangay_filter %}&barangay={{ barangay_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                Next
                                <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 cursor-not-allowed">
                                Next
                                <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </span>
                        {% endif %}
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div id="project-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-8 relative mx-4 my-8 max-h-[90vh] overflow-y-auto">
        <button onclick="closeProjectModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <div id="modal-content">
            <!-- Content will be filled by JS -->
        </div>
    </div>
</div>

<!-- Cost Entry Modal Placeholder -->
<div id="cost-entry-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-8 relative mx-4 my-8 max-h-[90vh] overflow-y-auto">
        <button onclick="closeViewCostsModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <div id="cost-entry-modal-content">
            <h2 class="text-2xl font-bold mb-4">Cost Entries for Project <span id="cost-entry-project-name"></span></h2>
            <!-- Cost Entry list will be filled by JS -->
            <div id="cost-entries-list"></div>
        </div>
    </div>
</div>

<style>
/* Active status card indicator */
#card-all.active,
#card-completed.active,
#card-inprogress.active,
#card-planned.active,
#card-delayed.active {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border: 3px solid rgba(255, 255, 255, 0.5);
}
</style>

{% block extra_js %}
{{ block.super }}

<script>
// Utility functions
window.utils = window.utils || {
    getElement: (id) => document.getElementById(id),
    getElements: (selector) => document.querySelectorAll(selector),
    showElement: (element) => element?.classList.remove('hidden'),
    hideElement: (element) => element?.classList.add('hidden'),
    toggleElement: (element) => element?.classList.toggle('hidden'),
    getCookie: (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

// Store projects data
window.projects = (typeof window.projects !== 'undefined' && Array.isArray(window.projects)) ? window.projects : {{ projects|safe|default:'[]' }};
if (!Array.isArray(window.projects)) window.projects = [];

console.log("window.projects:", window.projects);

// Modal functions
function openProjectModal(id) {
    console.log("openProjectModal called with id:", id);
    if (!window.projects || !Array.isArray(window.projects)) window.projects = [];
    console.log("window.projects inside openProjectModal:", window.projects);
    const modal = utils.getElement('project-modal');
    const content = utils.getElement('modal-content');
    const project = window.projects.find(p => p.id == id);
    console.log("Found project:", project);
    console.log("modal:", modal, "content:", content);

    if (!project || !modal || !content) return;

    const totalProgress = project.total_progress || 0;
    const assignedEngineers = project.assigned_engineers ? project.assigned_engineers.join(', ') : '';

    let html = `
        <h2 class="text-2xl font-bold mb-2">${project.name || ''}</h2>
        <div class="mb-2 text-gray-600">PRN: ${project.prn || ''}</div>
        <div class="mb-2 text-gray-600">Barangay: ${project.barangay || ''}</div>
        <div class="mb-2 text-gray-600">Status: ${project.status || ''}</div>
        <div class="mb-2 text-gray-600">Assigned: ${assignedEngineers}</div>
        <div class="mb-4">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${totalProgress}%"></div>
            </div>
            <span class="text-sm text-gray-500">${totalProgress}% Complete</span>
        </div>
        <h3 class="text-lg font-semibold mb-2">Progress Updates</h3>
    `;

    if (project.progress_updates?.length > 0) {
        html += project.progress_updates.map((update, idx) => `
            <div class="border rounded-lg mb-3 p-3 bg-gray-50 cursor-pointer" onclick="toggleUpdateDetails('update-details-${idx}')">
                <div class="font-semibold">${update.date || ''} - ${update.percentage_complete || 0}% <span class="text-xs text-gray-500">by ${update.engineer || ''}</span></div>
                <div id="update-details-${idx}" class="mt-2 hidden">
                    <div class="mb-2">${update.description || ''}</div>
                    <div>
                        ${update.photos?.length > 0 ? update.photos.map(url => `<img src="${url}" style="max-width:80px; margin-right:6px; border-radius:4px; border:1px solid #ccc;">`).join('') : '<span class="text-gray-400">No photos</span>'}
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        html += `<div class="text-gray-400">No progress updates yet.</div>`;
    }

    content.innerHTML = html;
    utils.showElement(modal);
}

function closeProjectModal() {
    const modal = utils.getElement('project-modal');
    if (modal) utils.hideElement(modal);
}

function toggleUpdateDetails(id) {
    const el = utils.getElement(id);
    if (el) utils.toggleElement(el);
}

// Filter functions - redirect to backend filter
function filterByStatus(status, card) {
    // Build URL with current filters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Remove page parameter when filtering
    urlParams.delete('page');
    
    // Set status filter
    if (status === 'all') {
        urlParams.delete('status');
    } else {
        urlParams.set('status', status);
    }
    
    // Redirect to filtered page
    window.location.href = '?' + urlParams.toString();
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-apply filters on change
    const filterForm = utils.getElement('filter-form');
    const searchInput = utils.getElement('search-input');
    const filterBarangay = utils.getElement('filter-barangay');
    
    // Debounce function for search input
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                if (filterForm) {
                    // Reset to page 1 when filtering
                    const pageInput = document.createElement('input');
                    pageInput.type = 'hidden';
                    pageInput.name = 'page';
                    pageInput.value = '1';
                    filterForm.appendChild(pageInput);
                    filterForm.submit();
                }
            }, 500); // 500ms debounce
        });
    }
    
    // Auto-submit on barangay change
    if (filterBarangay) {
        filterBarangay.addEventListener('change', function() {
            if (filterForm) {
                // Reset to page 1 when filtering
                const pageInput = document.createElement('input');
                pageInput.type = 'hidden';
                pageInput.name = 'page';
                pageInput.value = '1';
                filterForm.appendChild(pageInput);
                filterForm.submit();
            }
        });
    }
    
    // Initialize cost entry form
    const costEntryForm = utils.getElement('cost-entry-form');
    if (costEntryForm) {
        costEntryForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(costEntryForm);
            const projectId = formData.get('project_id');
            const addCostUrl = `/projeng/projects/${projectId}/add-cost/`;

            try {
                const response = await fetch(addCostUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': utils.getCookie('csrftoken'),
                    },
                });
                const data = await response.json();

                if (data.success) {
                    alert('Cost entry added successfully!');
                    closeViewCostsModal();
                } else {
                    alert('Error adding cost entry: ' + (data.error || JSON.stringify(data.errors)));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while adding the cost entry.');
            }
        });
    }
});

// Cost modal functions
function openViewCostsModal(id) {
    const modal = utils.getElement('cost-entry-modal');
    const costEntriesListDiv = utils.getElement('cost-entries-list');
    const projectNameElement = utils.getElement('cost-entry-project-name');
    const project = window.projects.find(p => p.id == id);

    if (!project || !modal || !costEntriesListDiv || !projectNameElement) return;

    projectNameElement.textContent = project.name || '';
    costEntriesListDiv.innerHTML = '';

    if (project.cost_entries?.length > 0) {
        const costsHtml = project.cost_entries.map(cost => `
            <div class="border rounded-lg mb-3 p-3 bg-gray-50">
                <div class="font-semibold">${cost.date || ''} - ${cost.cost_type || ''} - ${cost.amount || ''}</div>
                <div class="mt-2 text-sm text-gray-700">${cost.description || ''}</div>
                ${cost.receipt_url ? `<div class="mt-2"><a href="${cost.receipt_url}" target="_blank" class="text-blue-600 hover:underline">View Receipt</a></div>` : ''}
            </div>
        `).join('');
        costEntriesListDiv.innerHTML = costsHtml;
    } else {
        costEntriesListDiv.innerHTML = '<div class="text-gray-400">No cost entries yet.</div>';
    }

    utils.showElement(modal);
}

function closeViewCostsModal() {
    const modal = utils.getElement('cost-entry-modal');
    if (modal) utils.hideElement(modal);
}
</script>
{{ projects|json_script:"projects-data" }}
<script>
var projectsDataElement = document.getElementById('projects-data');
if (projectsDataElement) {
    try {
        window.projects = JSON.parse(projectsDataElement.textContent);
    } catch (e) {
        console.error('Error parsing projects-data JSON:', e, projectsDataElement.textContent);
        window.projects = [];
    }
} else {
    window.projects = [];
}
console.log("window.projects:", window.projects);
</script>
{% endblock %}

{% endblock %} 